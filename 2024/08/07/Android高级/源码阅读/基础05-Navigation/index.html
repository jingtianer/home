<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>基础05-Navigation - Jingtianer</title><link rel="manifest" href="/home/manifest.json"><meta name="application-name" content="Jingtianer"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jingtianer"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="简介NavController是中央导航 API。它会跟踪用户访问过的目的地，并允许用户在目的地之间移动。 获取NavController fragment  如果是NavHostFragment 1val navController &amp;#x3D; this.navController"><meta property="og:type" content="blog"><meta property="og:title" content="基础05-Navigation"><meta property="og:url" content="https://jingtianer.github.io/home/2024/08/07/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8005-Navigation/"><meta property="og:site_name" content="Jingtianer"><meta property="og:description" content="简介NavController是中央导航 API。它会跟踪用户访问过的目的地，并允许用户在目的地之间移动。 获取NavController fragment  如果是NavHostFragment 1val navController &amp;#x3D; this.navController"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://jingtianer.github.io/home/img/og_image.png"><meta property="article:published_time" content="2024-08-07T13:15:36.000Z"><meta property="article:modified_time" content="2025-04-15T02:37:55.589Z"><meta property="article:author" content="Meow Meow Liu"><meta property="article:tag" content="Android-官方源码"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://jingtianer.github.io/home/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jingtianer.github.io/home/2024/08/07/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8005-Navigation/"},"headline":"基础05-Navigation","image":["https://jingtianer.github.io/home/img/og_image.png"],"datePublished":"2024-08-07T13:15:36.000Z","dateModified":"2025-04-15T02:37:55.589Z","author":{"@type":"Person","name":"Meow Meow Liu"},"publisher":{"@type":"Organization","name":"Jingtianer","logo":{"@type":"ImageObject","url":{"text":"Meow!!"}}},"description":"简介NavController是中央导航 API。它会跟踪用户访问过的目的地，并允许用户在目的地之间移动。 获取NavController fragment  如果是NavHostFragment 1val navController &#x3D; this.navController"}</script><link rel="canonical" href="https://jingtianer.github.io/home/2024/08/07/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8005-Navigation/"><link rel="alternate" href="/home/atom.xml" title="Jingtianer" type="application/atom+xml"><link rel="icon" href="/home/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/vs.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/home/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/home/">Meow!!</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/home/">主页</a><a class="navbar-item" href="/home/archives">归档</a><a class="navbar-item" href="/home/categories">分类</a><a class="navbar-item" href="/home/tags">标签</a><a class="navbar-item" href="/home/about">关于我</a><a class="navbar-item" href="/home/tags/gallery">相册</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-08-07T13:15:36.000Z" title="2024/8/7 21:15:36">2024-08-07</time>发表</span><span class="level-item"><time dateTime="2025-04-15T02:37:55.589Z" title="2025/4/15 10:37:55">2025-04-15</time>更新</span><span class="level-item"><a class="link-muted" href="/home/categories/Android/">Android</a><span> / </span><a class="link-muted" href="/home/categories/Android/%E6%89%8B%E6%92%B8Android%E6%BA%90%E7%A0%81/">手撸Android源码</a></span><span class="level-item">1 小时读完 (大约11066个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">基础05-Navigation</h1><div class="content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>NavController</code>是中央导航 API。它会跟踪用户访问过的目的地，并允许用户在目的地之间移动。</p>
<h3 id="获取NavController"><a href="#获取NavController" class="headerlink" title="获取NavController"></a>获取<code>NavController</code></h3><ul>
<li>fragment</li>
</ul>
<p>如果是NavHostFragment</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> navController = <span class="keyword">this</span>.navController</span><br></pre></td></tr></table></figure>

<p>如果是普通Fragment</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> navController = <span class="keyword">this</span>.findNavController()</span><br></pre></td></tr></table></figure>

<ul>
<li>compose</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> navController = rememberNavController()</span><br></pre></td></tr></table></figure>

<p><code>NavHostFragment</code>实现了<code>NavHost</code>接口，可以直接获取<code>NavController</code>。</p>
<ul>
<li>view</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> navController = view.findNavController()</span><br><span class="line"><span class="comment">// 这个view必须在一个NavHost之中</span></span><br></pre></td></tr></table></figure>

<ul>
<li>activity</li>
</ul>
<p>先获取<code>Activity</code>中的<code>NavHostFragment</code>，再获取<code>NavController</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> navHostFragment =</span><br><span class="line">    supportFragmentManager.findFragmentById(R.id.nav_host_fragment) <span class="keyword">as</span> NavHostFragment</span><br><span class="line"><span class="keyword">val</span> navController = navHostFragment.navController</span><br></pre></td></tr></table></figure>

<p>使用Activity的扩展函数<code>findNavController</code>，可以获取<code>NavController</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> navController = activity.findNavController(R.id.view_within_navhost)</span><br><span class="line"><span class="comment">// R.id.view_within_navhost这个view必须在一个NavHost之中</span></span><br></pre></td></tr></table></figure>

<h4 id="Fragment-findNavController"><a href="#Fragment-findNavController" class="headerlink" title="Fragment.findNavController"></a>Fragment.findNavController</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> Fragment.<span class="title">findNavController</span><span class="params">()</span></span>: NavController =</span><br><span class="line">    NavHostFragment.findNavController(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmStatic</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">findNavController</span><span class="params">(fragment: <span class="type">Fragment</span>)</span></span>: NavController &#123;</span><br><span class="line">    <span class="keyword">var</span> findFragment: Fragment? = fragment</span><br><span class="line">    <span class="keyword">while</span> (findFragment != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (findFragment <span class="keyword">is</span> NavHostFragment) &#123;</span><br><span class="line">            <span class="keyword">return</span> findFragment.navHostController</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> primaryNavFragment = findFragment.parentFragmentManager</span><br><span class="line">            .primaryNavigationFragment</span><br><span class="line">        <span class="keyword">if</span> (primaryNavFragment <span class="keyword">is</span> NavHostFragment) &#123;</span><br><span class="line">            <span class="keyword">return</span> primaryNavFragment.navHostController</span><br><span class="line">        &#125;</span><br><span class="line">        findFragment = findFragment.parentFragment</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try looking for one associated with the view instead, if applicable</span></span><br><span class="line">    <span class="keyword">val</span> view = fragment.view</span><br><span class="line">    <span class="keyword">if</span> (view != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Navigation.findNavController(view)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For DialogFragments, look at the dialog&#x27;s decor view</span></span><br><span class="line">    <span class="keyword">val</span> dialogDecorView = (fragment <span class="keyword">as</span>? DialogFragment)?.dialog?.window?.decorView</span><br><span class="line">    <span class="keyword">if</span> (dialogDecorView != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Navigation.findNavController(dialogDecorView)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;Fragment <span class="variable">$fragment</span> does not have a NavController set&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>从当前fragment开始寻找<ul>
<li>如果有<code>NavHostFragment</code>，就返回他的<code>NavController</code></li>
<li>如果没有，就找<code>parentFragmentManager</code>的<code>primaryNavigationFragment</code><ul>
<li>如果是<code>NavHostFragment</code>，就返回他的<code>NavController</code></li>
<li>如果不是，就把当前<code>fragment</code>设置为<code>parentFragment</code>，重复上面过程，直到找到一个<code>NavHostFragment</code>或没有<code>parentFragment</code>为止</li>
</ul>
</li>
</ul>
</li>
<li>如果当前fragment及父fragment中找不到<code>NavHostFragment</code>，就尝试从当前fragment的<code>view</code>中寻找</li>
<li>如果还是找不到，尝试判断当前<code>fragment</code>是否为<code>DialogFragment</code>，如果是，则从<code>DialogFragment</code>的<code>decorView</code>中查找</li>
<li>如果还是找不到，就抛出异常</li>
</ul>
<h4 id="View-findNavController"><a href="#View-findNavController" class="headerlink" title="View.findNavController"></a>View.findNavController</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> View.<span class="title">findNavController</span><span class="params">()</span></span>: NavController =</span><br><span class="line">    Navigation.findNavController(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Activity-findNavController"><a href="#Activity-findNavController" class="headerlink" title="Activity.findNavController"></a>Activity.findNavController</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> Activity.<span class="title">findNavController</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@IdRes</span> viewId: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: NavController = Navigation.findNavController(<span class="keyword">this</span>, viewId)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmStatic</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">findNavController</span><span class="params">(activity: <span class="type">Activity</span>, <span class="meta">@IdRes</span> viewId: <span class="type">Int</span>)</span></span>: NavController &#123;</span><br><span class="line">    <span class="keyword">val</span> view = ActivityCompat.requireViewById&lt;View&gt;(activity, viewId)</span><br><span class="line">    <span class="keyword">return</span> findViewNavController(view)</span><br><span class="line">        ?: <span class="keyword">throw</span> IllegalStateException(</span><br><span class="line">            <span class="string">&quot;Activity <span class="variable">$activity</span> does not have a NavController set on <span class="variable">$viewId</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Activity就是比View多了一步<code>findViewById</code></li>
</ul>
<h4 id="findViewNavController-view-View"><a href="#findViewNavController-view-View" class="headerlink" title="findViewNavController(view: View)"></a><code>findViewNavController(view: View)</code></h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">findViewNavController</span><span class="params">(view: <span class="type">View</span>)</span></span>: NavController? =</span><br><span class="line">    generateSequence(view) &#123;</span><br><span class="line">        it.parent <span class="keyword">as</span>? View?</span><br><span class="line">    &#125;.mapNotNull &#123;</span><br><span class="line">        getViewNavController(it)</span><br><span class="line">    &#125;.firstOrNull()</span><br></pre></td></tr></table></figure>

<ul>
<li>其实就是从当前view开始，一直找到根view，如果过程中有<code>NavController</code>，就返回</li>
<li>其中一个设置<code>nav_controller_view_tag</code>的地方可以看<a href="#onviewcreated">NavHostFragment#onviewcreated</a></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getViewNavController</span><span class="params">(view: <span class="type">View</span>)</span></span>: NavController? &#123;</span><br><span class="line">    <span class="keyword">val</span> tag = view.getTag(R.id.nav_controller_view_tag)</span><br><span class="line">    <span class="keyword">var</span> controller: NavController? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (tag <span class="keyword">is</span> WeakReference&lt;*&gt;) &#123;</span><br><span class="line">        controller = (tag <span class="keyword">as</span> WeakReference&lt;NavController&gt;).<span class="keyword">get</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag <span class="keyword">is</span> NavController) &#123;</span><br><span class="line">        controller = tag</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> controller</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@kotlin</span>.<span class="keyword">internal</span>.LowPriorityInOverloadResolution</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : Any&gt;</span> <span class="title">generateSequence</span><span class="params">(seed: <span class="type">T</span>?, nextFunction: (<span class="type">T</span>) -&gt; <span class="type">T</span>?)</span></span>: Sequence&lt;T&gt; =</span><br><span class="line">    <span class="keyword">if</span> (seed == <span class="literal">null</span>)</span><br><span class="line">        EmptySequence</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        GeneratorSequence(&#123; seed &#125;, nextFunction)</span><br></pre></td></tr></table></figure>


<h3 id="导航图"><a href="#导航图" class="headerlink" title="导航图"></a>导航图</h3><h4 id="使用kotlin-DSL"><a href="#使用kotlin-DSL" class="headerlink" title="使用kotlin DSL"></a>使用kotlin DSL</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> NavController.<span class="title">createGraph</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    startDestination: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    route: <span class="type">String</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    builder: <span class="type">NavGraphBuilder</span>.() -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: NavGraph = navigatorProvider.navigation(startDestination, route, builder)</span><br></pre></td></tr></table></figure>

<h4 id="xml"><a href="#xml" class="headerlink" title="xml"></a>xml</h4><p>首先，创建一个 NavHostFragment。它充当包含实际导航图的导航宿主。</p>
<p>NavHostFragment 的最小实现：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.fragment.app.FragmentContainerView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/nav_host_fragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;androidx.navigation.fragment.NavHostFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:navGraph</span>=<span class="string">&quot;@navigation/nav_graph&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>NavHostFragment 包含 app:navGraph 属性。使用此属性可将导航图连接到导航宿主。以下示例展示了如何实现该图：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">navigation</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/nav_graph&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:startDestination</span>=<span class="string">&quot;@id/profile&quot;</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Action back to destination which launched into this profile --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_global_profile&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">app:popUpTo</span>=<span class="string">&quot;@id/profile&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">app:popUpToInclusive</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/profile&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.ProfileFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;Profile&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Action to navigate from Profile to Friends List. --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_profile_to_friendslist&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:destination</span>=<span class="string">&quot;@id/friendslist&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/friendslist&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.FriendsListFragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;Friends List&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 深层链接 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://developer.android.com/guide/navigation/design/deep-link?hl=zh-cn --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">deepLink</span> <span class="attr">app:uri</span>=<span class="string">&quot;www.example.com&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:action</span>=<span class="string">&quot;android.intent.action.MY_ACTION&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:mimeType</span>=<span class="string">&quot;type/subtype&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Add other fragment destinations similarly. --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 对话框目的地 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dialog</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/my_dialog_fragment&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;androidx.navigation.myapp.MyDialogFragment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">argument</span> <span class="attr">android:name</span>=<span class="string">&quot;myarg&quot;</span> <span class="attr">android:defaultValue</span>=<span class="string">&quot;@null&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">&quot;@+id/myaction&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">app:destination</span>=<span class="string">&quot;@+id/another_destination&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dialog</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Activity目的地 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/sampleActivityDestination&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.android.navigation.activity.DestinationActivity&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/sampleActivityTitle&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 嵌套图 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 应用中的登录流程、向导或其他子流程通常是嵌套导航图的最佳表示形式。通过以这种方式嵌套独立的子导航流程，您可以更轻松地理解和管理应用界面的主流程。 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">navigation</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/sendMoneyGraph&quot;</span> <span class="attr">app:startDestination</span>=<span class="string">&quot;@id/chooseRecipient&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:id</span>=<span class="string">&quot;@+id/chooseRecipient&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:name</span>=<span class="string">&quot;com.example.cashdog.cashdog.ChooseRecipient&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:label</span>=<span class="string">&quot;fragment_choose_recipient&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_choose_recipient&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_chooseRecipient_to_chooseAmountFragment&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">app:destination</span>=<span class="string">&quot;@id/chooseAmountFragment&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">fragment</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">fragment</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:id</span>=<span class="string">&quot;@+id/chooseAmountFragment&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:name</span>=<span class="string">&quot;com.example.cashdog.cashdog.ChooseAmountFragment&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:label</span>=<span class="string">&quot;fragment_choose_amount&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">tools:layout</span>=<span class="string">&quot;@layout/fragment_choose_amount&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">navigation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">navigation</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="NavHostFragment"><a href="#NavHostFragment" class="headerlink" title="NavHostFragment"></a>NavHostFragment</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NavHostFragment</span> : <span class="type">Fragment</span>(), NavHost &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现了<code>navHost</code>接口，也就是有了一个<code>navHostController</code>属性</p>
<h3 id="navHostController"><a href="#navHostController" class="headerlink" title="navHostController"></a>navHostController</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">override</span> <span class="keyword">val</span> navController: NavController</span><br><span class="line">        <span class="keyword">get</span>() = navHostController</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">val</span> navHostController: NavHostController <span class="keyword">by</span> lazy &#123; <span class="comment">// 1: lazy</span></span><br><span class="line">    <span class="keyword">val</span> context = checkNotNull(context) &#123; <span class="comment">// 2: 获取context并判空</span></span><br><span class="line">        <span class="string">&quot;NavController cannot be created before the fragment is attached&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    NavHostController(context).apply &#123; <span class="comment">// 3: 生成实例</span></span><br><span class="line">        setLifecycleOwner(<span class="keyword">this</span><span class="symbol">@NavHostFragment</span>) <span class="comment">// 4: 传递fragment为lifecycleOwner</span></span><br><span class="line">        setViewModelStore(viewModelStore) <span class="comment">// 5: 传递fragment的viewModelStore</span></span><br><span class="line">        onCreateNavHostController(<span class="keyword">this</span>) <span class="comment">// 6: 回调通知fragment</span></span><br><span class="line">        savedStateRegistry.consumeRestoredStateForKey(KEY_NAV_CONTROLLER_STATE)?.let &#123;</span><br><span class="line">            restoreState(it)</span><br><span class="line">        &#125;</span><br><span class="line">        savedStateRegistry.registerSavedStateProvider(KEY_NAV_CONTROLLER_STATE) &#123;</span><br><span class="line">            saveState() ?: Bundle.EMPTY</span><br><span class="line">        &#125;</span><br><span class="line">        savedStateRegistry.consumeRestoredStateForKey(KEY_GRAPH_ID)?.let &#123; bundle -&gt;</span><br><span class="line">            graphId = bundle.getInt(KEY_GRAPH_ID)</span><br><span class="line">        &#125;</span><br><span class="line">        savedStateRegistry.registerSavedStateProvider(KEY_GRAPH_ID) &#123;</span><br><span class="line">            <span class="keyword">if</span> (graphId != <span class="number">0</span>) &#123;</span><br><span class="line">                bundleOf(KEY_GRAPH_ID to graphId)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Bundle.EMPTY</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">// 7: savedState相关的看不懂，todo: 以后再看</span></span><br><span class="line">        <span class="keyword">if</span> (graphId != <span class="number">0</span>) &#123; <span class="comment">// // 8: setGraph</span></span><br><span class="line">            <span class="comment">// Set from onInflate()</span></span><br><span class="line">            setGraph(graphId) <span class="comment">// 8.1: 导航图id不为0，有效，设置导航图</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// See if it was set by NavHostFragment.create()</span></span><br><span class="line">            <span class="keyword">val</span> args = arguments</span><br><span class="line">            <span class="keyword">val</span> graphId = args?.getInt(KEY_GRAPH_ID) ?: <span class="number">0</span></span><br><span class="line">            <span class="keyword">val</span> startDestinationArgs = args?.getBundle(KEY_START_DESTINATION_ARGS)</span><br><span class="line">            <span class="keyword">if</span> (graphId != <span class="number">0</span>) &#123; <span class="comment">// 8.2: 尝试从fragment的`arguments`获取导航图和startDestinationArgs</span></span><br><span class="line">                setGraph(graphId, startDestinationArgs)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是创建了一个<code>navHostController</code>,详细内容看<a href="#navhostcontroller%E7%B1%BB">NavHostController类</a></p>
<h4 id="1-lazy"><a href="#1-lazy" class="headerlink" title="1: lazy"></a>1: lazy</h4><p>这个没啥说的，就是懒加载</p>
<h4 id="2-获取context并判空"><a href="#2-获取context并判空" class="headerlink" title="2: 获取context并判空"></a>2: 获取context并判空</h4><ul>
<li><code>fragment</code>的<code>getContext</code></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Context getContext() &#123;</span><br><span class="line">    <span class="keyword">return</span> mHost == <span class="literal">null</span> ? <span class="literal">null</span> : mHost.getContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>mHost</code>会在<code>FragmentStateManager</code>调用<code>moveToExpectedState</code>时，如果移动到<code>Fragment.ATTACHED</code>状态，调用<code>attach</code>方法时，进行初始化</p>
<p>&#x2F;&#x2F; todo: 再挖个坑以后学习</p>
</blockquote>
<h4 id="6-回调通知fragment"><a href="#6-回调通知fragment" class="headerlink" title="6: 回调通知fragment"></a>6: 回调通知fragment</h4><ul>
<li>这里调用的是<code>NavHostFragment</code>的方法<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;DEPRECATION&quot;</span>)</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateNavHostController</span><span class="params">(navHostController: <span class="type">NavHostController</span>)</span></span> &#123;</span><br><span class="line">    onCreateNavController(navHostController)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Callback for when the [NavController][getNavController] is created. If you</span></span><br><span class="line"><span class="comment">* support any custom destination types, their [Navigator] should be added here to</span></span><br><span class="line"><span class="comment">* ensure it is available before the navigation graph is inflated / set.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* By default, this adds a [DialogFragmentNavigator] and [FragmentNavigator].</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* This is only called once when the navController is called. This will be called in [onCreate]</span></span><br><span class="line"><span class="comment">* if the navController has not yet been called. This should not be called directly by</span></span><br><span class="line"><span class="comment">* subclasses.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> navController The newly created [NavController].</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Suppress(<span class="string">&quot;DEPRECATION&quot;</span>)</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="meta">@Deprecated(</span></span><br><span class="line"><span class="meta">    <span class="string">&quot;&quot;&quot;Override &#123;@link #onCreateNavHostController(NavHostController)&#125; to gain</span></span></span><br><span class="line"><span class="string"><span class="meta">    access to the full &#123;@link NavHostController&#125; that is created by this NavHostFragment.&quot;&quot;&quot;</span></span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateNavController</span><span class="params">(navController: <span class="type">NavController</span>)</span></span> &#123;</span><br><span class="line">    navController.navigatorProvider +=</span><br><span class="line">        DialogFragmentNavigator(requireContext(), childFragmentManager)</span><br><span class="line">    navController.navigatorProvider.addNavigator(createFragmentNavigator())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>创建<code>getNavController</code>时的回调函数。如果您支持任何自定义目标类型，则应将其导航器添加到此处，以确保在导航图<code>inflate/set</code>之前可用。 </li>
<li>默认情况下，这会添加一个<code>DialogFragmentNavigator</code>和<code>FragmentNavigator</code>。 </li>
<li>它只在<code>navController</code>被调用时被调用一次。如果<code>navController</code>还没有被调用，这个函数会在<code>onCreate</code>中被调用。子类不应该直接调用这个方法。</li>
</ol>
</blockquote>
<p>翻译一下这个函数的注释</p>
<ol>
<li>第一句是说子类可以重写这个方法，添加自定义的Navigator</li>
<li>第二句是说默认会添加<code>DialogFragmentNavigator</code>和<code>FragmentNavigator</code></li>
<li>要理解第三句先看下面代码，<code>navHostController</code>时lazy，但是在<code>Fragment#onCreate</code>时会主动出发他的创建过程<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="comment">// We are accessing the NavController here to ensure that it is always created by this point</span></span><br><span class="line">    navHostController</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (savedInstanceState.getBoolean(KEY_DEFAULT_NAV_HOST, <span class="literal">false</span>)) &#123;</span><br><span class="line">            defaultNavHost = <span class="literal">true</span></span><br><span class="line">            parentFragmentManager.beginTransaction()</span><br><span class="line">                .setPrimaryNavigationFragment(<span class="keyword">this</span>)</span><br><span class="line">                .commit()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We purposefully run this last as this will trigger the onCreate() of</span></span><br><span class="line">    <span class="comment">// child fragments, which may be relying on having the NavController already</span></span><br><span class="line">    <span class="comment">// created and having its state restored by that point.</span></span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="7-savedState相关的看不懂，todo-以后再看"><a href="#7-savedState相关的看不懂，todo-以后再看" class="headerlink" title="7: savedState相关的看不懂，todo: 以后再看"></a>7: savedState相关的看不懂，todo: 以后再看</h4><p>&#x2F;&#x2F; todo: 占坑，以后再看</p>
<h4 id="8-setGraph"><a href="#8-setGraph" class="headerlink" title="8: setGraph"></a>8: setGraph</h4><ul>
<li>导航图id不为0，有效，设置导航图</li>
<li>导航图id为0, 尝试从fragment的<code>arguments</code>获取<code>导航图id</code>和<code>startDestinationArgs</code></li>
<li>setArguments是父类<code>Fragment</code>的一个方法，<code>mArguments</code>就是一个<code>Bundle</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArguments</span><span class="params">(<span class="meta">@Nullable</span> Bundle args)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mFragmentManager != <span class="literal">null</span> &amp;&amp; isStateSaved()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Fragment already added and state has been saved&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mArguments = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建NavHostFragment"><a href="#创建NavHostFragment" class="headerlink" title="创建NavHostFragment"></a>创建NavHostFragment</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmOverloads</span></span><br><span class="line"><span class="meta">@JvmStatic</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NavigationRes</span> graphResId: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    startDestinationArgs: <span class="type">Bundle</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: NavHostFragment &#123;</span><br><span class="line">    <span class="keyword">var</span> b: Bundle? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (graphResId != <span class="number">0</span>) &#123;</span><br><span class="line">        b = Bundle()</span><br><span class="line">        b.putInt(KEY_GRAPH_ID, graphResId)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (startDestinationArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="literal">null</span>) &#123;</span><br><span class="line">            b = Bundle()</span><br><span class="line">        &#125;</span><br><span class="line">        b.putBundle(KEY_START_DESTINATION_ARGS, startDestinationArgs)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> result = NavHostFragment()</span><br><span class="line">    <span class="keyword">if</span> (b != <span class="literal">null</span>) &#123;</span><br><span class="line">        result.arguments = b</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到, <code>KEY_GRAPH_ID</code>和<code>KEY_START_DESTINATION_ARGS</code></li>
</ul>
<h3 id="几个key的定义"><a href="#几个key的定义" class="headerlink" title="几个key的定义"></a>几个key的定义</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">val</span> KEY_GRAPH_ID: String = <span class="string">&quot;android-support-nav:fragment:graphId&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">val</span> KEY_START_DESTINATION_ARGS: String =</span><br><span class="line">        <span class="string">&quot;android-support-nav:fragment:startDestinationArgs&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> KEY_NAV_CONTROLLER_STATE =</span><br><span class="line">        <span class="string">&quot;android-support-nav:fragment:navControllerState&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> KEY_DEFAULT_NAV_HOST = <span class="string">&quot;android-support-nav:fragment:defaultHost&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>KEY_GRAPH_ID</code>和<code>KEY_START_DESTINATION_ARGS</code>被限制在同组lib中使用，也就是不推荐我们自己手动通过这两个key来设置<code>导航图id</code>和<code>args</code></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> graphId = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><code>graphId</code>也是<code>private</code>的，也无法通过继承的方式修改他的值</p>
<h3 id="onInflate"><a href="#onInflate" class="headerlink" title="onInflate"></a>onInflate</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInflate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    context: <span class="type">Context</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    attrs: <span class="type">AttributeSet</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onInflate(context, attrs, savedInstanceState)</span><br><span class="line">    context.obtainStyledAttributes(</span><br><span class="line">        attrs,</span><br><span class="line">        androidx.navigation.R.styleable.NavHost</span><br><span class="line">    ).use &#123; navHost -&gt;</span><br><span class="line">        <span class="keyword">val</span> graphId = navHost.getResourceId(</span><br><span class="line">            androidx.navigation.R.styleable.NavHost_navGraph, <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (graphId != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.graphId = graphId</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    context.obtainStyledAttributes(attrs, R.styleable.NavHostFragment).use &#123; array -&gt;</span><br><span class="line">        <span class="keyword">val</span> defaultHost = array.getBoolean(R.styleable.NavHostFragment_defaultNavHost, <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">if</span> (defaultHost) &#123;</span><br><span class="line">            defaultNavHost = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导航图和<code>defaultNavHost</code>可以在<code>FragmentContainerView</code>的<code>xml</code>中使用<code>navGraph</code>和<code>defaultNavHost</code>定义</p>
<h3 id="onSaveInstanceState"><a href="#onSaveInstanceState" class="headerlink" title="onSaveInstanceState"></a>onSaveInstanceState</h3><ul>
<li><code>onSaveInstanceState</code>时如果<code>defaultNavHost</code>是<code>true</code>会把这个状态存起来，<code>onCreate</code>时恢复<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSaveInstanceState</span><span class="params">(outState: <span class="type">Bundle</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onSaveInstanceState(outState)</span><br><span class="line">    <span class="keyword">if</span> (defaultNavHost) &#123;</span><br><span class="line">        outState.putBoolean(KEY_DEFAULT_NAV_HOST, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate"></a>onCreate</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="comment">// We are accessing the NavController here to ensure that it is always created by this point</span></span><br><span class="line">    navHostController</span><br><span class="line">    <span class="keyword">if</span> (savedInstanceState != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (savedInstanceState.getBoolean(KEY_DEFAULT_NAV_HOST, <span class="literal">false</span>)) &#123;</span><br><span class="line">            defaultNavHost = <span class="literal">true</span></span><br><span class="line">            parentFragmentManager.beginTransaction()</span><br><span class="line">                .setPrimaryNavigationFragment(<span class="keyword">this</span>)</span><br><span class="line">                .commit()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We purposefully run this last as this will trigger the onCreate() of</span></span><br><span class="line">    <span class="comment">// child fragments, which may be relying on having the NavController already</span></span><br><span class="line">    <span class="comment">// created and having its state restored by that point.</span></span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="onViewCreated"><a href="#onViewCreated" class="headerlink" title="onViewCreated"></a>onViewCreated</h3><ul>
<li>会给view设置<code>navHostController</code><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">    check(view <span class="keyword">is</span> ViewGroup) &#123; <span class="string">&quot;created host view <span class="variable">$view</span> is not a ViewGroup&quot;</span> &#125;</span><br><span class="line">    Navigation.setViewNavController(view, navHostController)</span><br><span class="line">    <span class="comment">// When added programmatically, we need to set the NavController on the parent - i.e.,</span></span><br><span class="line">    <span class="comment">// the View that has the ID matching this NavHostFragment.</span></span><br><span class="line">    <span class="keyword">if</span> (view.getParent() != <span class="literal">null</span>) &#123;</span><br><span class="line">        viewParent = view.getParent() <span class="keyword">as</span> View</span><br><span class="line">        <span class="keyword">if</span> (viewParent!!.id == id) &#123;</span><br><span class="line">            Navigation.setViewNavController(viewParent!!, navHostController)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
通过view的<code>setTag</code>设置<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmStatic</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">setViewNavController</span><span class="params">(view: <span class="type">View</span>, controller: <span class="type">NavController</span>?)</span></span> &#123;</span><br><span class="line">    view.setTag(R.id.nav_controller_view_tag, controller)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="onDestroyView"><a href="#onDestroyView" class="headerlink" title="onDestroyView"></a>onDestroyView</h3><ul>
<li>非常对称的，在onDestroyView时，会把<code>viewParent</code>中的<code>navHostController</code>设置为<code>null</code><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroyView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroyView()</span><br><span class="line">    viewParent?.let &#123; it -&gt;</span><br><span class="line">        <span class="keyword">if</span> (Navigation.findNavController(it) === navHostController) &#123;</span><br><span class="line">            Navigation.setViewNavController(it, <span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    viewParent = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="defaultNavHost"><a href="#defaultNavHost" class="headerlink" title="defaultNavHost"></a>defaultNavHost</h3><p>如果在<code>attach</code>时发现是<code>defaultNavHost</code>，会提交一个<code>setPrimaryNavigationFragment</code>的<code>transaction</code>，追踪这个操作，他具体做了以下内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">setPrimaryNavigationFragment</span><span class="params">(<span class="meta">@Nullable</span> Fragment f)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (f != <span class="literal">null</span> &amp;&amp; (!f.equals(findActiveFragment(f.mWho))</span><br><span class="line">            || (f.mHost != <span class="literal">null</span> &amp;&amp; f.mFragmentManager != <span class="built_in">this</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Fragment &quot;</span> + f</span><br><span class="line">                + <span class="string">&quot; is not an active fragment of FragmentManager &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Fragment</span> <span class="variable">previousPrimaryNav</span> <span class="operator">=</span> mPrimaryNav;</span><br><span class="line">    mPrimaryNav = f;</span><br><span class="line">    dispatchParentPrimaryNavigationFragmentChanged(previousPrimaryNav);</span><br><span class="line">    dispatchParentPrimaryNavigationFragmentChanged(mPrimaryNav);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchParentPrimaryNavigationFragmentChanged</span><span class="params">(<span class="meta">@Nullable</span> Fragment f)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (f != <span class="literal">null</span> &amp;&amp; f.equals(findActiveFragment(f.mWho))) &#123;</span><br><span class="line">        f.performPrimaryNavigationFragmentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>找到前一个<code>primaryNavigationFragment</code>，和将要设置为<code>defaultNav</code>的<code>fragment</code>,调用其<code>performPrimaryNavigationFragmentChanged</code>操作<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performPrimaryNavigationFragmentChanged</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isPrimaryNavigationFragment</span> <span class="operator">=</span> mFragmentManager.isPrimaryNavigation(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// Only send out the callback / dispatch if the state has changed</span></span><br><span class="line">    <span class="keyword">if</span> (mIsPrimaryNavigationFragment == <span class="literal">null</span></span><br><span class="line">            || mIsPrimaryNavigationFragment != isPrimaryNavigationFragment) &#123;</span><br><span class="line">        mIsPrimaryNavigationFragment = isPrimaryNavigationFragment;</span><br><span class="line">        onPrimaryNavigationFragmentChanged(isPrimaryNavigationFragment);</span><br><span class="line">        mChildFragmentManager.dispatchPrimaryNavigationFragmentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>更新Fragment中的<code>mIsPrimaryNavigationFragment</code>这个flag，并且找到子fragment，也去更新其状态</li>
<li>调用钩子函数<code>onPrimaryNavigationFragmentChanged</code></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void onPrimaryNavigationFragmentChanged(boolean isPrimaryNavigationFragment) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>他是一个空的方法，子类可以重写，<code>NavHostFragment</code>也没有实现它，看来是给程序员自由发挥的。</li>
<li>官方文档中<a target="_blank" rel="noopener" href="https://developer.android.com/guide/navigation/use-graph/programmatic?hl=zh-cn#create_a_navhostfragment">创建 NavHostFragment
</a>提到这个操作会<code>&quot;允许您的 NavHost 截获对系统“返回”按钮的按下操作&quot;</code>。上面的代码好像并没有体现出来。</li>
</ul>
<h2 id="NavHostController类"><a href="#NavHostController类" class="headerlink" title="NavHostController类"></a>NavHostController类</h2><ul>
<li><code>NavHostController</code>继承自<code>NavController</code>，其中没有什么代码，其本身是open的，但它把父类的几个方法设置为<code>final</code>，包括：<ul>
<li>setLifecycleOwner</li>
<li>setOnBackPressedDispatcher</li>
<li>enableOnBackPressed</li>
<li>setViewModelStore</li>
</ul>
</li>
</ul>
<h2 id="NavController"><a href="#NavController" class="headerlink" title="NavController"></a>NavController</h2><h3 id="3-生成实例"><a href="#3-生成实例" class="headerlink" title="3: 生成实例"></a>3: 生成实例</h3><p>NavHostController构造函数</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NavHostController</span>(context: Context) </span><br><span class="line">    : NavController(context) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NavController</span>(</span><br><span class="line">    <span class="comment">/** <span class="doctag">@suppress</span> */</span></span><br><span class="line">    <span class="meta">@get:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> context: Context</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        _navigatorProvider.addNavigator(NavGraphNavigator(_navigatorProvider))</span><br><span class="line">        _navigatorProvider.addNavigator(ActivityNavigator(context))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>传递<code>context</code>就是存起来以后会用</p>
</li>
<li><p>通过<code>context</code>创建<code>ActivityNavigator</code></p>
</li>
<li><p>可以先剧透一下，<code>Navigator</code>就是一个具体实施跳转等操作的类</p>
<ul>
<li>比如<code>ActivityNavigator</code>就会调用<code>startActivity</code></li>
<li><code>FragmentNavigator</code>就会构造<code>FragmentTransaction</code>来跳转<code>fragment</code></li>
</ul>
</li>
</ul>
<h3 id="4-传递fragment为lifecycleOwner"><a href="#4-传递fragment为lifecycleOwner" class="headerlink" title="4: 传递fragment为lifecycleOwner"></a>4: 传递fragment为lifecycleOwner</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setLifecycleOwner</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.setLifecycleOwner(owner)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">setLifecycleOwner</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (owner == lifecycleOwner) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    lifecycleOwner?.lifecycle?.removeObserver(lifecycleObserver)</span><br><span class="line">    lifecycleOwner = owner</span><br><span class="line">    owner.lifecycle.addObserver(lifecycleObserver)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>去掉原来的owner，添加新的owner，并添加观察者<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> lifecycleObserver: LifecycleObserver = LifecycleEventObserver &#123; _, event -&gt;</span><br><span class="line">    hostLifecycleState = event.targetState</span><br><span class="line">    <span class="keyword">if</span> (_graph != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (entry <span class="keyword">in</span> backQueue) &#123;</span><br><span class="line">            entry.handleLifecycleEvent(event)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>hostLifecycleState就是存对应的生命周期状态</li>
<li>_graph是一个<code>NavGraph</code>, 在<code>setGraph</code>中初始化</li>
<li>backQueue是存放<code>NavBackStackEntry</code>的双端队列</li>
</ul>
<h3 id="5-传递fragment的viewModelStore"><a href="#5-传递fragment的viewModelStore" class="headerlink" title="5: 传递fragment的viewModelStore"></a>5: 传递fragment的viewModelStore</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setViewModelStore</span><span class="params">(viewModelStore: <span class="type">ViewModelStore</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.setViewModelStore(viewModelStore)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">setViewModelStore</span><span class="params">(viewModelStore: <span class="type">ViewModelStore</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (viewModel == NavControllerViewModel.getInstance(viewModelStore)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    check(backQueue.isEmpty()) &#123; <span class="string">&quot;ViewModelStore should be set before setGraph call&quot;</span> &#125;</span><br><span class="line">    viewModel = NavControllerViewModel.getInstance(viewModelStore)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>就是创建了一个<code>viewModel</code>，以后会用</li>
</ul>
<h3 id="8-setGraph-1"><a href="#8-setGraph-1" class="headerlink" title="8: setGraph"></a>8: setGraph</h3><ul>
<li><p>如果导航图id不为0，有效，设置导航图</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">setGraph</span><span class="params">(<span class="meta">@NavigationRes</span> graphResId: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    setGraph(navInflater.inflate(graphResId), <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果导航图为0，则尝试从<code>fragment</code>的<code>arguments</code>中获取<code>导航图id</code>和<code>startDestinationArgs</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">setGraph</span><span class="params">(<span class="meta">@NavigationRes</span> graphResId: <span class="type">Int</span>, startDestinationArgs: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    setGraph(navInflater.inflate(graphResId), startDestinationArgs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>最终都调用了<code>setGraph(graph: NavGraph, startDestinationArgs: Bundle?)</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Sets the [navigation graph][NavGraph] to the specified graph.</span></span><br><span class="line"><span class="comment">* Any current navigation graph data (including back stack) will be replaced.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* The graph can be retrieved later via [graph].</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> graph graph to set</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> NavController.setGraph</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> NavController.graph</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">setGraph</span><span class="params">(graph: <span class="type">NavGraph</span>, startDestinationArgs: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_graph != graph) &#123;</span><br><span class="line">        _graph?.let &#123; previousGraph -&gt;</span><br><span class="line">            <span class="comment">// Clear all saved back stacks by iterating through a copy of the saved keys,</span></span><br><span class="line">            <span class="comment">// thus avoiding any concurrent modification exceptions</span></span><br><span class="line">            <span class="keyword">val</span> savedBackStackIds = ArrayList(backStackMap.keys)</span><br><span class="line">            savedBackStackIds.forEach &#123; id -&gt;</span><br><span class="line">                clearBackStackInternal(id)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Pop everything from the old graph off the back stack</span></span><br><span class="line">            NavControllerInternal(previousGraph.id, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        _graph = graph</span><br><span class="line">        onGraphCreated(startDestinationArgs)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// first we update _graph with new instances from graph</span></span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until graph.nodes.size()) &#123;</span><br><span class="line">            <span class="keyword">val</span> newDestination = graph.nodes.valueAt(i)</span><br><span class="line">            <span class="keyword">val</span> key = _graph!!.nodes.keyAt(i)</span><br><span class="line">            _graph!!.nodes.replace(key, newDestination)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// then we update backstack with the new instances</span></span><br><span class="line">        backQueue.forEach &#123; entry -&gt;</span><br><span class="line">            <span class="comment">// we will trace this hierarchy in new graph to get new destination instance</span></span><br><span class="line">            <span class="keyword">val</span> hierarchy = entry.destination.hierarchy.toList().asReversed()</span><br><span class="line">            <span class="keyword">val</span> newDestination = hierarchy.fold(_graph!!) &#123;</span><br><span class="line">                    newDest: NavDestination, oldDest: NavDestination -&gt;</span><br><span class="line">                <span class="keyword">if</span> (oldDest == _graph &amp;&amp; newDest == graph) &#123;</span><br><span class="line">                    <span class="comment">// if root graph, it is already the node that matches with oldDest</span></span><br><span class="line">                    newDest</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newDest <span class="keyword">is</span> NavGraph) &#123;</span><br><span class="line">                    <span class="comment">// otherwise we walk down the hierarchy to the next child</span></span><br><span class="line">                    newDest.findNode(oldDest.id)!!</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// final leaf node found</span></span><br><span class="line">                    newDest</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            entry.destination = newDestination</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>考虑了两种情况，setGraph前后<code>_graph</code>和<code>graph</code>是否相等<ul>
<li>注意kt代码有运算符重载，实际上调用的是<code>NavGraph</code>的<code>equals</code></li>
</ul>
</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">equals</span><span class="params">(other: <span class="type">Any</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> === other) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (other == <span class="literal">null</span> || other !<span class="keyword">is</span> NavGraph) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.equals(other) &amp;&amp;</span><br><span class="line">        nodes.size == other.nodes.size &amp;&amp;</span><br><span class="line">        startDestinationId == other.startDestinationId &amp;&amp;</span><br><span class="line">        nodes.valueIterator().asSequence().all &#123; it == other.nodes.<span class="keyword">get</span>(it.id) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="navigate"><a href="#navigate" class="headerlink" title="navigate"></a>navigate</h3><h4 id="通过action的资源id跳转的"><a href="#通过action的资源id跳转的" class="headerlink" title="通过action的资源id跳转的"></a>通过action的资源id跳转的</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// id1: </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(<span class="meta">@IdRes</span> resId: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    navigate(resId, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// id2: </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(<span class="meta">@IdRes</span> resId: <span class="type">Int</span>, args: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    navigate(resId, args, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// id3: </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(<span class="meta">@IdRes</span> resId: <span class="type">Int</span>, args: <span class="type">Bundle</span>?, navOptions: <span class="type">NavOptions</span>?)</span></span> &#123;</span><br><span class="line">    navigate(resId, args, navOptions, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// id4: </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@IdRes</span> resId: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    args: <span class="type">Bundle</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一个参数的调两个参数的，两个参数的调三个参数的<br>四个参数的巨长但也不是核心的方法，还会调用核心的navigate方法</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// id4:</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@IdRes</span> resId: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    args: <span class="type">Bundle</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> finalNavOptions = navOptions <span class="comment">// 1: navOptions</span></span><br><span class="line">    <span class="keyword">val</span> currentNode = (</span><br><span class="line">        <span class="keyword">if</span> (backQueue.isEmpty())</span><br><span class="line">            _graph</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            backQueue.last().destination</span><br><span class="line">        ) ?: <span class="keyword">throw</span> IllegalStateException(</span><br><span class="line">            <span class="string">&quot;No current destination found. Ensure a navigation graph has been set for &quot;</span> +</span><br><span class="line">                <span class="string">&quot;NavController <span class="variable">$this</span>.&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IdRes</span></span><br><span class="line">    <span class="keyword">var</span> destId = resId</span><br><span class="line">    <span class="keyword">val</span> navAction = currentNode.getAction(resId)</span><br><span class="line">    <span class="keyword">var</span> combinedArgs: Bundle? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (navAction != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (finalNavOptions == <span class="literal">null</span>) &#123; <span class="comment">// 1.2: navOptions空的情况</span></span><br><span class="line">            finalNavOptions = navAction.navOptions</span><br><span class="line">        &#125;</span><br><span class="line">        destId = navAction.destinationId <span class="comment">// 3: destId</span></span><br><span class="line">        <span class="keyword">val</span> navActionArgs = navAction.defaultArguments</span><br><span class="line">        <span class="keyword">if</span> (navActionArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">            combinedArgs = Bundle()</span><br><span class="line">            combinedArgs.putAll(navActionArgs)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (args != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (combinedArgs == <span class="literal">null</span>) &#123;</span><br><span class="line">            combinedArgs = Bundle()</span><br><span class="line">        &#125;</span><br><span class="line">        combinedArgs.putAll(args) <span class="comment">// 2: 合并args</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (destId == <span class="number">0</span> &amp;&amp; finalNavOptions != <span class="literal">null</span> &amp;&amp; (finalNavOptions.popUpToId != -<span class="number">1</span> ||</span><br><span class="line">            finalNavOptions.popUpToRoute != <span class="literal">null</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">when</span> &#123; <span class="comment">// 5: popUpTo</span></span><br><span class="line">            finalNavOptions.popUpToRoute != <span class="literal">null</span> -&gt;</span><br><span class="line">                NavController(</span><br><span class="line">                    finalNavOptions.popUpToRoute!!, finalNavOptions.isPopUpToInclusive()</span><br><span class="line">                )</span><br><span class="line">            finalNavOptions.popUpToId != -<span class="number">1</span> -&gt;</span><br><span class="line">                NavController(</span><br><span class="line">                    finalNavOptions.popUpToId, finalNavOptions.isPopUpToInclusive()</span><br><span class="line">                )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    require(destId != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="string">&quot;Destination id == 0 can only be used in conjunction with a valid navOptions.popUpTo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> node = findDestination(destId) <span class="comment">// 4: 找到destination的node</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> dest = NavDestination.getDisplayName(context, destId)</span><br><span class="line">        require(navAction == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="string">&quot;Navigation destination <span class="variable">$dest</span> referenced from action &quot;</span> +</span><br><span class="line">                <span class="string">&quot;<span class="subst">$&#123;NavDestination.getDisplayName(context, resId)&#125;</span> cannot be found from &quot;</span> +</span><br><span class="line">                <span class="string">&quot;the current destination <span class="variable">$currentNode</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">&quot;Navigation action/destination <span class="variable">$dest</span> cannot be found from the current &quot;</span> +</span><br><span class="line">                <span class="string">&quot;destination <span class="variable">$currentNode</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    navigate(node, combinedArgs, finalNavOptions, navigatorExtras) <span class="comment">// 6:</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>大概做了下面几件事</p>
<ul>
<li>1: 如果调用<code>navigate</code>时<ul>
<li>1.1: <code>NavOptions</code>参数不空，则忽略当前<code>node</code>的<code>action</code>中存储的<code>NavOptions</code></li>
<li>1.2: 如果空，则使用当前<code>node</code>的<code>action</code>中存储的<code>NavOptions</code></li>
</ul>
</li>
<li>2: 将action的<code>defaultArguments</code>和参数中的<code>args</code>合并，并传递给核心的<code>navigate</code></li>
<li>3: 从action中获取<code>destinationId</code></li>
<li>4: 从当前图中找到<code>destinationId</code>对应的node</li>
<li>5: 弹出导航栈，直到遇到对应的route或id</li>
<li>6: 将<code>node</code>和合并的<code>args</code>, <code>NavOptions</code>, 还有<code>navigatorExtras</code>传递给核心的<code>navigate</code>方法</li>
</ul>
</blockquote>
<h4 id="通过NavDirections跳转的"><a href="#通过NavDirections跳转的" class="headerlink" title="通过NavDirections跳转的"></a>通过NavDirections跳转的</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NavDirections1:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(directions: <span class="type">NavDirections</span>)</span></span> &#123;</span><br><span class="line">    navigate(directions.actionId, directions.arguments, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NavDirections2:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(directions: <span class="type">NavDirections</span>, navOptions: <span class="type">NavOptions</span>?)</span></span> &#123;</span><br><span class="line">    navigate(directions.actionId, directions.arguments, navOptions)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NavDirections3:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(directions: <span class="type">NavDirections</span>, navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>)</span></span> &#123;</span><br><span class="line">    navigate(directions.actionId, directions.arguments, <span class="literal">null</span>, navigatorExtras)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看一下NavDirections是啥</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">NavDirections</span> &#123;</span><br><span class="line">    <span class="meta">@get:IdRes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> actionId: <span class="built_in">Int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> arguments: Bundle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是把action-id和arguments包装了一下，最终也会调用<code>id4</code></p>
<h4 id="通过Uri类型的DeepLink跳转的"><a href="#通过Uri类型的DeepLink跳转的" class="headerlink" title="通过Uri类型的DeepLink跳转的"></a>通过Uri类型的DeepLink跳转的</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// uri1:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(deepLink: <span class="type">Uri</span>)</span></span> &#123;</span><br><span class="line">    navigate(NavDeepLinkRequest(deepLink, <span class="literal">null</span>, <span class="literal">null</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// uri2:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(deepLink: <span class="type">Uri</span>, navOptions: <span class="type">NavOptions</span>?)</span></span> &#123;</span><br><span class="line">    navigate(NavDeepLinkRequest(deepLink, <span class="literal">null</span>, <span class="literal">null</span>), navOptions, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// uri3:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    deepLink: <span class="type">Uri</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    navigate(NavDeepLinkRequest(deepLink, <span class="literal">null</span>, <span class="literal">null</span>), navOptions, navigatorExtras)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他们都会构造NavDeepLinkRequest对象然后调用<code>NavDeepLinkRequest3</code></p>
<h4 id="通过route跳转的"><a href="#通过route跳转的" class="headerlink" title="通过route跳转的"></a>通过route跳转的</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// route1:</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(route: <span class="type">String</span>, builder: <span class="type">NavOptionsBuilder</span>.() -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    navigate(route, navOptions(builder))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    route: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    navigate(</span><br><span class="line">        NavDeepLinkRequest.Builder.fromUri(createRoute(route).toUri()).build(), navOptions,</span><br><span class="line">        navigatorExtras</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过route跳转的，最后也会变成deeplink</li>
</ul>
<h4 id="通过NavDeepLinkRequest跳转的"><a href="#通过NavDeepLinkRequest跳转的" class="headerlink" title="通过NavDeepLinkRequest跳转的"></a>通过NavDeepLinkRequest跳转的</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NavDeepLinkRequest1:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(request: <span class="type">NavDeepLinkRequest</span>)</span></span> &#123;</span><br><span class="line">    navigate(request, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NavDeepLinkRequest2:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(request: <span class="type">NavDeepLinkRequest</span>, navOptions: <span class="type">NavOptions</span>?)</span></span> &#123;</span><br><span class="line">    navigate(request, navOptions, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NavDeepLinkRequest3:</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    request: <span class="type">NavDeepLinkRequest</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    request: <span class="type">NavDeepLinkRequest</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    requireNotNull(_graph) &#123;</span><br><span class="line">        <span class="string">&quot;Cannot navigate to <span class="variable">$request</span>. Navigation graph has not been set for &quot;</span> +</span><br><span class="line">            <span class="string">&quot;NavController <span class="variable">$this</span>.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> deepLinkMatch = _graph!!.matchDeepLink(request)</span><br><span class="line">    <span class="keyword">if</span> (deepLinkMatch != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> destination = deepLinkMatch.destination</span><br><span class="line">        <span class="keyword">val</span> args = destination.addInDefaultArgs(deepLinkMatch.matchingArgs) ?: Bundle()</span><br><span class="line">        <span class="keyword">val</span> node = deepLinkMatch.destination</span><br><span class="line">        <span class="keyword">val</span> intent = Intent().apply &#123;</span><br><span class="line">            setDataAndType(request.uri, request.mimeType)</span><br><span class="line">            action = request.action</span><br><span class="line">        &#125;</span><br><span class="line">        args.putParcelable(KEY_DEEP_LINK_INTENT, intent)</span><br><span class="line">        navigate(node, args, navOptions, navigatorExtras)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">&quot;Navigation destination that matches request <span class="variable">$request</span> cannot be found in the &quot;</span> +</span><br><span class="line">                <span class="string">&quot;navigation graph <span class="variable">$_graph</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过matchDeepLink方法找到match对象<ul>
<li>如果没有match，抛出异常</li>
<li>如果有match，从match对象中取出<code>destination</code>，和<code>id4</code>方法一样，最终都会调用核心的<code>navigate</code>方法，同样需要找到核心<code>navigate</code>方法所需的几个参数<ul>
<li>node: 从destination对象中获得</li>
<li>args: 从destination对象中获得</li>
<li>navOptions: 函数参数</li>
<li>navigatorExtras: 函数参数</li>
</ul>
</li>
<li>调用核心的<code>navigate</code>方法</li>
</ul>
</li>
</ul>
<h4 id="核心的navigate方法"><a href="#核心的navigate方法" class="headerlink" title="核心的navigate方法"></a>核心的navigate方法</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    node: <span class="type">NavDestination</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    args: <span class="type">Bundle</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    navigatorState.values.forEach &#123; state -&gt;</span><br><span class="line">        state.isNavigating = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> popped = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> launchSingleTop = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> navigated = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (navOptions != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">when</span> &#123; <span class="comment">// 1: 根据navOptions的不同情况，pop栈</span></span><br><span class="line">            navOptions.popUpToRoute != <span class="literal">null</span> -&gt;</span><br><span class="line">                popped = NavControllerInternal(</span><br><span class="line">                    navOptions.popUpToRoute!!,</span><br><span class="line">                    navOptions.isPopUpToInclusive(),</span><br><span class="line">                    navOptions.shouldPopUpToSaveState()</span><br><span class="line">                )</span><br><span class="line">            navOptions.popUpToId != -<span class="number">1</span> -&gt;</span><br><span class="line">                popped = NavControllerInternal(</span><br><span class="line">                    navOptions.popUpToId,</span><br><span class="line">                    navOptions.isPopUpToInclusive(),</span><br><span class="line">                    navOptions.shouldPopUpToSaveState()</span><br><span class="line">                )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> finalArgs = node.addInDefaultArgs(args)</span><br><span class="line">    <span class="comment">// Now determine what new destinations we need to add to the back stack</span></span><br><span class="line">    <span class="keyword">if</span> (navOptions?.shouldRestoreState() == <span class="literal">true</span> &amp;&amp; backStackMap.containsKey(node.id)) &#123;</span><br><span class="line">        navigated = restoreStateInternal(node.id, finalArgs, navOptions, navigatorExtras) <span class="comment">// 2: 需要恢复状态，且backStackMap中存在对应的node的情况</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        launchSingleTop = navOptions?.shouldLaunchSingleTop() == <span class="literal">true</span> &amp;&amp;</span><br><span class="line">            launchSingleTopInternal(node, args) <span class="comment">//3: singleTop的情况</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!launchSingleTop) &#123; <span class="comment">// 不需要singleTop的情况</span></span><br><span class="line">            <span class="comment">// Not a single top operation, so we&#x27;re looking to add the node to the back stack</span></span><br><span class="line">            <span class="keyword">val</span> backStackEntry = NavBackStackEntry.create(</span><br><span class="line">                context, node, finalArgs, hostLifecycleState, viewModel</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">val</span> navigator = _navigatorProvider.getNavigator&lt;Navigator&lt;NavDestination&gt;&gt;(</span><br><span class="line">                node.navigatorName</span><br><span class="line">            )</span><br><span class="line">            navigator.navigateInternal(listOf(backStackEntry), navOptions, navigatorExtras) &#123;</span><br><span class="line">                navigated = <span class="literal">true</span></span><br><span class="line">                addEntryToBackStack(node, finalArgs, it)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    updateOnBackPressedCallbackEnabled() <span class="comment">// 4: 看起来是设置一个flag</span></span><br><span class="line">    navigatorState.values.forEach &#123; state -&gt;</span><br><span class="line">        state.isNavigating = <span class="literal">false</span> <span class="comment">// 5: 又设置一个flag</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (popped || navigated || launchSingleTop) &#123;</span><br><span class="line">        dispatchOnDestinationChanged() <span class="comment">// 6: 调用回调</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        updateBackStackLifecycle() <span class="comment">// 7: 更新导航栈的生命周期</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>根据上面的注释，一共做了7件事</li>
</ul>
<h5 id="2-需要恢复状态，且backStackMap中存在对应的node的情况"><a href="#2-需要恢复状态，且backStackMap中存在对应的node的情况" class="headerlink" title="2: 需要恢复状态，且backStackMap中存在对应的node的情况"></a>2: 需要恢复状态，且backStackMap中存在对应的node的情况</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NavOptions</span> <span class="keyword">internal</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> singleTop: <span class="built_in">Boolean</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> restoreState: <span class="built_in">Boolean</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">shouldRestoreState</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> restoreState</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> singleTop = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> restoreState = <span class="literal">false</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">setRestoreState</span><span class="params">(restoreState: <span class="type">Boolean</span>)</span></span>: Builder &#123;</span><br><span class="line">            <span class="keyword">this</span>.restoreState = restoreState</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shouldRestoreState</code>返回的是<code>restoreState</code>，是在构造时确定的</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">restoreStateInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    id: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    args: <span class="type">Bundle</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!backStackMap.containsKey(id)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// 1: 首先是防止backStackMap中没有对应的node</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> backStackId = backStackMap[id]</span><br><span class="line">    <span class="comment">// Clear out the state we&#x27;re going to restore so that it isn&#x27;t restored a second time</span></span><br><span class="line">    backStackMap.values.removeAll &#123; it == backStackId &#125; <span class="comment">// 2: 删除map中所有和backStackId相等的entry</span></span><br><span class="line">    <span class="keyword">val</span> backStackState = backStackStates.remove(backStackId) <span class="comment">// 3: 删除backStackStates中对应的entry</span></span><br><span class="line">    <span class="comment">// Now restore the back stack from its saved state</span></span><br><span class="line">    <span class="keyword">val</span> entries = instantiateBackStack(backStackState) <span class="comment">// 4: 更新backStackState中的NavBackStackEntryState</span></span><br><span class="line">    <span class="keyword">return</span> executeRestoreState(entries, args, navOptions, navigatorExtras) <span class="comment">// 5: 找到Navigator，导航到对应位置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-删除backStackStates中对应的entry"><a href="#3-删除backStackStates中对应的entry" class="headerlink" title="3: 删除backStackStates中对应的entry"></a>3: 删除backStackStates中对应的entry</h6><p>看一下backStackStates的数据结构</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> backStackStates = mutableMapOf&lt;String, ArrayDeque&lt;NavBackStackEntryState&gt;&gt;()</span><br></pre></td></tr></table></figure>
<h6 id="4-更新backStackState中的"><a href="#4-更新backStackState中的" class="headerlink" title="4: 更新backStackState中的"></a>4: 更新backStackState中的</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">instantiateBackStack</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    backStackState: <span class="type">ArrayDeque</span>&lt;<span class="type">NavBackStackEntryState</span>&gt;?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: List&lt;NavBackStackEntry&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> backStack = mutableListOf&lt;NavBackStackEntry&gt;()</span><br><span class="line">    <span class="keyword">var</span> currentDestination = backQueue.lastOrNull()?.destination ?: graph</span><br><span class="line">    backStackState?.forEach &#123; state -&gt;</span><br><span class="line">        <span class="keyword">val</span> node = currentDestination.findDestination(state.destinationId)</span><br><span class="line">        checkNotNull(node) &#123;</span><br><span class="line">            <span class="keyword">val</span> dest = NavDestination.getDisplayName(</span><br><span class="line">                context, state.destinationId</span><br><span class="line">            )</span><br><span class="line">            <span class="string">&quot;Restore State failed: destination <span class="variable">$dest</span> cannot be found from the current &quot;</span> +</span><br><span class="line">                <span class="string">&quot;destination <span class="variable">$currentDestination</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        backStack += state.instantiate(context, node, hostLifecycleState, viewModel)</span><br><span class="line">        currentDestination = node</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> backStack</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个空的backStack，然后遍历backStackState</li>
<li>找到当前栈最后一个entry的destination</li>
<li>从currentDestination中找到<code>state.destinationId</code>对应的node</li>
<li>根据node重新创建state对象，添加到backStack中，返回该backStack</li>
</ul>
<h6 id="5-找到Navigator，导航到对应位置"><a href="#5-找到Navigator，导航到对应位置" class="headerlink" title="5: 找到Navigator，导航到对应位置"></a>5: 找到Navigator，导航到对应位置</h6><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">executeRestoreState</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    entries: <span class="type">List</span>&lt;<span class="type">NavBackStackEntry</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    args: <span class="type">Bundle</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="comment">// Split up the entries by Navigator so we can restore them as an atomic operation</span></span><br><span class="line">    <span class="keyword">val</span> entriesGroupedByNavigator = mutableListOf&lt;MutableList&lt;NavBackStackEntry&gt;&gt;()</span><br><span class="line">    entries.filterNot &#123; entry -&gt;</span><br><span class="line">        <span class="comment">// Skip navigation graphs - they&#x27;ll be added by addEntryToBackStack()</span></span><br><span class="line">        entry.destination <span class="keyword">is</span> NavGraph</span><br><span class="line">    &#125;.forEach &#123; entry -&gt;</span><br><span class="line">        <span class="keyword">val</span> previousEntryList = entriesGroupedByNavigator.lastOrNull()</span><br><span class="line">        <span class="keyword">val</span> previousNavigatorName = previousEntryList?.last()?.destination?.navigatorName</span><br><span class="line">        <span class="keyword">if</span> (previousNavigatorName == entry.destination.navigatorName) &#123;</span><br><span class="line">            <span class="comment">// Group back to back entries associated with the same Navigator together</span></span><br><span class="line">            previousEntryList += entry</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Create a new group for the new Navigator</span></span><br><span class="line">            entriesGroupedByNavigator += mutableListOf(entry)</span><br><span class="line">        &#125; <span class="comment">// 1: 如果 navigatorName和前一个的相等，则添加到前一个的list中，否则添加到新建一个list中，最后会得到一个二维数组，每个数组中的元素都是具有相同NavigatorName的</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> navigated = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// Now actually navigate to each set of entries</span></span><br><span class="line">    <span class="keyword">for</span> (entryList <span class="keyword">in</span> entriesGroupedByNavigator) &#123;</span><br><span class="line">        <span class="keyword">val</span> navigator = _navigatorProvider.getNavigator&lt;Navigator&lt;NavDestination&gt;&gt;(</span><br><span class="line">            entryList.first().destination.navigatorName</span><br><span class="line">        ) <span class="comment">// 2: 每个entryList都具有相同的navigatorName，找到对应的Navigator</span></span><br><span class="line">        <span class="keyword">var</span> lastNavigatedIndex = <span class="number">0</span></span><br><span class="line">        navigator.navigateInternal(entryList, navOptions, navigatorExtras) &#123; entry -&gt;</span><br><span class="line">            navigated = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// If this destination is part of the restored back stack,</span></span><br><span class="line">            <span class="comment">// pass all destinations between the last navigated entry and this one</span></span><br><span class="line">            <span class="comment">// to ensure that any navigation graphs are properly restored as well</span></span><br><span class="line">            <span class="keyword">val</span> entryIndex = entries.indexOf(entry)</span><br><span class="line">            <span class="keyword">val</span> restoredEntries = <span class="keyword">if</span> (entryIndex != -<span class="number">1</span>) &#123;</span><br><span class="line">                entries.subList(lastNavigatedIndex, entryIndex + <span class="number">1</span>).also &#123;</span><br><span class="line">                    lastNavigatedIndex = entryIndex + <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                emptyList()</span><br><span class="line">            &#125;</span><br><span class="line">            addEntryToBackStack(entry.destination, args, entry, restoredEntries)</span><br><span class="line">        &#125; <span class="comment">// 执行导航操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> navigated</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> Navigator<span class="type">&lt;out NavDestination&gt;</span>.<span class="title">navigateInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    entries: <span class="type">List</span>&lt;<span class="type">NavBackStackEntry</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Navigator</span>.<span class="type">Extras</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    handler: (<span class="type">backStackEntry</span>: <span class="type">NavBackStackEntry</span>) -&gt; <span class="type">Unit</span> = &#123;&#125;</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    addToBackStackHandler = handler <span class="comment">// 先把回调放到一边，稍后由NavControllerNavigatorState的push方法调用</span></span><br><span class="line">    navigate(entries, navOptions, navigatorExtras) <span class="comment">// 执行导航操作</span></span><br><span class="line">    addToBackStackHandler = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">navigate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    entries: <span class="type">List</span>&lt;<span class="type">NavBackStackEntry</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    navOptions: <span class="type">NavOptions</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigatorExtras: <span class="type">Extras</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    entries.asSequence().map &#123; backStackEntry -&gt; <span class="comment">// 遍历entries，把他进行变换</span></span><br><span class="line">        <span class="keyword">val</span> destination = backStackEntry.destination <span class="keyword">as</span>? D ?: <span class="keyword">return</span><span class="symbol">@map</span> <span class="literal">null</span></span><br><span class="line">        <span class="keyword">val</span> navigatedToDestination = navigate(</span><br><span class="line">            destination, backStackEntry.arguments, navOptions, navigatorExtras</span><br><span class="line">        ) <span class="comment">// 由子类实现，执行真正的导航操作</span></span><br><span class="line">        <span class="keyword">when</span> (navigatedToDestination) &#123;</span><br><span class="line">            <span class="literal">null</span> -&gt; <span class="literal">null</span> <span class="comment">// 返回null，当前backStackEntry变成null</span></span><br><span class="line">            destination -&gt; backStackEntry <span class="comment">// 返回导航结果与destination相同，backStackEntry也不变</span></span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                state.createBackStackEntry(</span><br><span class="line">                    navigatedToDestination,</span><br><span class="line">                    navigatedToDestination.addInDefaultArgs(backStackEntry.arguments)</span><br><span class="line">                ) <span class="comment">// 否则创建新的backStackEntry</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.filterNotNull().forEach &#123; backStackEntry -&gt;</span><br><span class="line">        state.push(backStackEntry)</span><br><span class="line">    &#125; <span class="comment">// 1: 对于不为null的，重新放入state中,注意这里调用的push方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面的state定义如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">val</span> state: NavigatorState</span><br><span class="line">    <span class="keyword">get</span>() = checkNotNull(_state) &#123;</span><br><span class="line">        <span class="string">&quot;You cannot access the Navigator&#x27;s state until the Navigator is attached&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> _state: NavigatorState? = <span class="literal">null</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAttach</span><span class="params">(state: <span class="type">NavigatorState</span>)</span></span> &#123; <span class="comment">// 在onAttach时会初始化</span></span><br><span class="line">    _state = state</span><br><span class="line">    isAttached = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在NavController的onGraphCreated方法中有</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> navigatorBackStack = navigatorState.getOrPut(navigator) &#123;</span><br><span class="line">    NavControllerNavigatorState(navigator)</span><br><span class="line">&#125;</span><br><span class="line">navigator.onAttach(navigatorBackStack)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其中navigatorState是从navigator到NavControllerNavigatorState的map</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> navigatorState =</span><br><span class="line">        mutableMapOf&lt;Navigator&lt;<span class="keyword">out</span> NavDestination&gt;, NavControllerNavigatorState&gt;()</span><br><span class="line"><span class="comment">// getOrPut方法就是当没有key时，调用后面的函数插入到map中并返回，有key时则返回查询到的value</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;K, V&gt;</span> MutableMap<span class="type">&lt;K, V&gt;</span>.<span class="title">getOrPut</span><span class="params">(key: <span class="type">K</span>, defaultValue: () -&gt; <span class="type">V</span>)</span></span>: V &#123;</span><br><span class="line">    <span class="keyword">val</span> value = <span class="keyword">get</span>(key)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> answer = defaultValue()</span><br><span class="line">        put(key, answer)</span><br><span class="line">        answer</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以上面<code>1:</code>出调用的push方法，就是NavControllerNavigatorState的push方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">push</span><span class="params">(backStackEntry: <span class="type">NavBackStackEntry</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> destinationNavigator: Navigator&lt;<span class="keyword">out</span> NavDestination&gt; =</span><br><span class="line">        _navigatorProvider[backStackEntry.destination.navigatorName]</span><br><span class="line">    <span class="keyword">if</span> (destinationNavigator == navigator) &#123;</span><br><span class="line">        <span class="keyword">val</span> handler = addToBackStackHandler <span class="comment">// 还记得前面存起来的回调吗，就会在这里调用</span></span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">            handler(backStackEntry)</span><br><span class="line">            addInternal(backStackEntry)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// TODO handle the Navigator calling add() outside of a call to navigate()</span></span><br><span class="line">            Log.i(</span><br><span class="line">                TAG,</span><br><span class="line">                <span class="string">&quot;Ignoring add of destination <span class="subst">$&#123;backStackEntry.destination&#125;</span> &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;outside of the call to navigate(). &quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> navigatorBackStack = checkNotNull(navigatorState[destinationNavigator]) &#123;</span><br><span class="line">            <span class="string">&quot;NavigatorBackStack for <span class="subst">$&#123;backStackEntry.destination.navigatorName&#125;</span> should &quot;</span> +</span><br><span class="line">                <span class="string">&quot;already be created&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        navigatorBackStack.push(backStackEntry)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>疑问，他跳转那么多干什么？</p>
</blockquote>
<h4 id="3-singleTop的情况"><a href="#3-singleTop的情况" class="headerlink" title="3: singleTop的情况"></a>3: singleTop的情况</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NavOptions</span> <span class="keyword">internal</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> singleTop: <span class="built_in">Boolean</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">shouldLaunchSingleTop</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> singleTop</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>shouldLaunchSingleTop返回的值是其构造时的一个标志位</p>
<p>在分析<code>launchSingleTopInternal</code>方法前，先看一下NavController中维护的一个父子关系</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> childToParentEntries = mutableMapOf&lt;NavBackStackEntry, NavBackStackEntry&gt;()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> parentToChildCount = mutableMapOf&lt;NavBackStackEntry, AtomicInteger&gt;()</span><br></pre></td></tr></table></figure>
<p>看起来NavBackStackEntry之间存在一个父子关系，可能是一张图的形式，一个map存储这种父子关系，一个map存储子节点的个数</p>
<blockquote>
<p>后面看了<code>NavDestination</code>和<code>NavBackStackEntry</code>后就知道，这里维护的就是<code>NavDestination</code>之间的父子关系。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">linkChildToParent</span><span class="params">(child: <span class="type">NavBackStackEntry</span>, parent: <span class="type">NavBackStackEntry</span>)</span></span> &#123;</span><br><span class="line">    childToParentEntries[child] = parent</span><br><span class="line">    <span class="keyword">if</span> (parentToChildCount[parent] == <span class="literal">null</span>) &#123;</span><br><span class="line">        parentToChildCount[parent] = AtomicInteger(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    parentToChildCount[parent]!!.incrementAndGet()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">unlinkChildFromParent</span><span class="params">(child: <span class="type">NavBackStackEntry</span>)</span></span>: NavBackStackEntry? &#123;</span><br><span class="line">    <span class="keyword">val</span> parent = childToParentEntries.remove(child) ?: <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">val</span> count = parentToChildCount[parent]?.decrementAndGet()</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> navGraphNavigator: Navigator&lt;<span class="keyword">out</span> NavGraph&gt; =</span><br><span class="line">            _navigatorProvider[parent.destination.navigatorName]</span><br><span class="line">        navigatorState[navGraphNavigator]?.markTransitionComplete(parent)</span><br><span class="line">        parentToChildCount.remove(parent)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> parent</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这两个函数用于维护NavBackStackEntry之间的父子关系<br>当一个NavBackStackEntry的child个数为0时，会调用markTransitionComplete，具体干啥的继续挖坑吧！<br>&#x2F;&#x2F; todo : markTransitionComplete</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">launchSingleTopInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    node: <span class="type">NavDestination</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    args: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> currentBackStackEntry = currentBackStackEntry</span><br><span class="line">    <span class="keyword">val</span> nodeId = <span class="keyword">if</span> (node <span class="keyword">is</span> NavGraph) node.findStartDestination().id <span class="keyword">else</span> node.id</span><br><span class="line">    <span class="keyword">if</span> (nodeId != currentBackStackEntry?.destination?.id) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tempBackQueue: ArrayDeque&lt;NavBackStackEntry&gt; = ArrayDeque()</span><br><span class="line">    <span class="comment">// pop from startDestination back to original node and create a new entry for each</span></span><br><span class="line">    backQueue.indexOfLast &#123; it.destination === node &#125;.let &#123; nodeIndex -&gt; <span class="comment">// 找到queue中最后一个destination和node相等的index</span></span><br><span class="line">        <span class="keyword">while</span> (backQueue.lastIndex &gt;= nodeIndex) &#123; <span class="comment">// 如果queue中最后一个index大于nodeIndex，就删掉他，并创建一个新的entry，放到tempBackQueue中，直到lastIndex小于nodeIndex为止</span></span><br><span class="line">            <span class="keyword">val</span> oldEntry = backQueue.removeLast() </span><br><span class="line">            unlinkChildFromParent(oldEntry) <span class="comment">// 删除父子关系</span></span><br><span class="line">            <span class="keyword">val</span> newEntry = NavBackStackEntry(</span><br><span class="line">                oldEntry,</span><br><span class="line">                oldEntry.destination.addInDefaultArgs(args)</span><br><span class="line">            ) <span class="comment">// 创建新的entry</span></span><br><span class="line">            tempBackQueue.addFirst(newEntry) <span class="comment">// 添加到tempBackQueue中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add each new entry to backQueue starting from original node to startDestination</span></span><br><span class="line">    tempBackQueue.forEach &#123; newEntry -&gt;</span><br><span class="line">        <span class="keyword">val</span> parent = newEntry.destination.parent</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> newParent = getBackStackEntry(parent.id)</span><br><span class="line">            linkChildToParent(newEntry, newParent) <span class="comment">// 更新entry之间的父子关系</span></span><br><span class="line">        &#125;</span><br><span class="line">        backQueue.add(newEntry)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we replace NavState entries here only after backQueue has been finalized</span></span><br><span class="line">    tempBackQueue.forEach &#123; newEntry -&gt;</span><br><span class="line">        <span class="keyword">val</span> navigator = _navigatorProvider.getNavigator&lt;Navigator&lt;*&gt;&gt;(</span><br><span class="line">            newEntry.destination.navigatorName</span><br><span class="line">        )</span><br><span class="line">        navigator.onLaunchSingleTop(newEntry) <span class="comment">// 拿到对应的Navigator，执行onLaunchSingleTop</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLaunchSingleTop</span><span class="params">(backStackEntry: <span class="type">NavBackStackEntry</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> destination = backStackEntry.destination <span class="keyword">as</span>? D ?: <span class="keyword">return</span></span><br><span class="line">    navigate(destination, <span class="literal">null</span>, navOptions &#123; launchSingleTop = <span class="literal">true</span> &#125;, <span class="literal">null</span>) <span class="comment">// 这个navigate执行真正的导航操作，老演员了，上面见过就不说了</span></span><br><span class="line">    state.onLaunchSingleTop(backStackEntry) <span class="comment">// 这个state在前面也介绍过，下面看看他的onLaunchSingleTop方法干了什么</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLaunchSingleTop</span><span class="params">(backStackEntry: <span class="type">NavBackStackEntry</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// We update the back stack here because we don&#x27;t want to leave it to the navigator since</span></span><br><span class="line">    <span class="comment">// it might be using transitions.</span></span><br><span class="line">    backStackLock.withLock &#123;</span><br><span class="line">        <span class="keyword">val</span> tempStack = backStack.value.toMutableList()</span><br><span class="line">        tempStack.indexOfLast &#123; it.id == backStackEntry.id &#125;.let &#123; idx -&gt;</span><br><span class="line">            tempStack[idx] = backStackEntry</span><br><span class="line">        &#125;</span><br><span class="line">        _backStack.value = tempStack</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实就是更新当前的返回栈<br>找到最后一个id与backStackEntry的id相等的index，将这个位置的entry替换为backStackEntry</p>
</blockquote>
<h4 id="其他情况"><a href="#其他情况" class="headerlink" title="其他情况"></a>其他情况</h4><p>在没有开启LaunchSingleTop的情况，或launchSingleTopInternal没有成功的情况那，就会走到这个代码分支</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!launchSingleTop) &#123;</span><br><span class="line">    <span class="comment">// Not a single top operation, so we&#x27;re looking to add the node to the back stack</span></span><br><span class="line">    <span class="keyword">val</span> backStackEntry = NavBackStackEntry.create(</span><br><span class="line">        context, node, finalArgs, hostLifecycleState, viewModel</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> navigator = _navigatorProvider.getNavigator&lt;Navigator&lt;NavDestination&gt;&gt;(</span><br><span class="line">        node.navigatorName</span><br><span class="line">    )</span><br><span class="line">    navigator.navigateInternal(listOf(backStackEntry), navOptions, navigatorExtras) &#123;</span><br><span class="line">        navigated = <span class="literal">true</span></span><br><span class="line">        addEntryToBackStack(node, finalArgs, it)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建新的backStackEntry条目，找到对应的Navigator，执行导航操作，如果成功了，就将其加入到返回栈中</p>
<h2 id="NavigatorProvider"><a href="#NavigatorProvider" class="headerlink" title="NavigatorProvider"></a>NavigatorProvider</h2><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _navigators: MutableMap&lt;String, Navigator&lt;<span class="keyword">out</span> NavDestination&gt;&gt; = mutableMapOf()</span><br><span class="line"><span class="meta">@get:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">val</span> navigators: Map&lt;String, Navigator&lt;<span class="keyword">out</span> NavDestination&gt;&gt;</span><br><span class="line">    <span class="keyword">get</span>() = _navigators.toMap()</span><br></pre></td></tr></table></figure>
<ul>
<li>以上就是<code>NavigatorProvider</code>的全部数据结构了，就是一个<code>String to Navigator</code>的<code>Map</code></li>
<li>回想<a href="#%E6%A0%B8%E5%BF%83%E7%9A%84navigate%E6%96%B9%E6%B3%95">核心的navigate方法</a>中多次使用<code>NavDestination#navigatorName</code>从<code>NavigatorProvider</code>中获取<code>Navigator</code>，所以<code>NavigatorProvider</code>的就是一个用来保存<code>navigatorName</code>到<code>Navigator</code>实例的<code>Map</code></li>
</ul>
<h3 id="获取Navigator"><a href="#获取Navigator" class="headerlink" title="获取Navigator"></a>获取Navigator</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : Navigator&lt;*&gt;</span>&gt; <span class="title">getNavigator</span><span class="params">(navigatorClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">    <span class="keyword">val</span> name = getNameForNavigator(navigatorClass)</span><br><span class="line">    <span class="keyword">return</span> getNavigator(name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Retrieves a registered [Navigator] by name.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> name name of the navigator to return</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the registered navigator with the given name</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IllegalStateException if the Navigator has not been added</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> NavigatorProvider.addNavigator</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : Navigator&lt;*&gt;</span>&gt; <span class="title">getNavigator</span><span class="params">(name: <span class="type">String</span>)</span></span>: T &#123;</span><br><span class="line">    require(validateName(name)) &#123; <span class="string">&quot;navigator name cannot be an empty string&quot;</span> &#125;</span><br><span class="line">    <span class="keyword">val</span> navigator = _navigators[name]</span><br><span class="line">        ?: <span class="keyword">throw</span> IllegalStateException(</span><br><span class="line">            <span class="string">&quot;Could not find Navigator with name \&quot;<span class="variable">$name</span>\&quot;. You must call &quot;</span> +</span><br><span class="line">                <span class="string">&quot;NavController.addNavigator() for each navigation type.&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> navigator <span class="keyword">as</span> T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="getNameForNavigator"><a href="#getNameForNavigator" class="headerlink" title="getNameForNavigator"></a>getNameForNavigator</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> annotationNames = mutableMapOf&lt;Class&lt;*&gt;, String?&gt;()</span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">validateName</span><span class="params">(name: <span class="type">String</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name != <span class="literal">null</span> &amp;&amp; name.isNotEmpty()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">getNameForNavigator</span><span class="params">(navigatorClass: <span class="type">Class</span>&lt;<span class="type">out</span> <span class="type">Navigator</span>&lt;*&gt;&gt;)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">var</span> name = annotationNames[navigatorClass]</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> <span class="keyword">annotation</span> = navigatorClass.getAnnotation(</span><br><span class="line">                Navigator.Name::<span class="keyword">class</span>.java</span><br><span class="line">            )</span><br><span class="line">            name = <span class="keyword">annotation</span>?.value</span><br><span class="line">            require(validateName(name)) &#123;</span><br><span class="line">                <span class="string">&quot;No @Navigator.Name annotation found for <span class="subst">$&#123;navigatorClass.simpleName&#125;</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            annotationNames[navigatorClass] = name</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> name!!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>发现获取的name是一个运行时注解，所以需要先看看<code>Navigator.Name</code>这个注解</li>
<li><code>Navigator.Name</code>是<code>Navigator</code>中的一个运行时注解<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@kotlin</span>.<span class="keyword">annotation</span>.Retention(AnnotationRetention.RUNTIME)</span><br><span class="line"><span class="meta">@Target(AnnotationTarget.ANNOTATION_CLASS, AnnotationTarget.CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">Name</span>(<span class="keyword">val</span> value: String)</span><br></pre></td></tr></table></figure></li>
<li>我们观察几个<code>Navigator</code>，发现他们都有<code>@Navigator.Name</code>注解，并传入了对应的参数<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. FragmentNavigator</span></span><br><span class="line"><span class="meta">@Navigator</span>.Name(<span class="string">&quot;fragment&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">FragmentNavigator</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> context: Context,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> fragmentManager: FragmentManager,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> containerId: <span class="built_in">Int</span></span><br><span class="line">) : Navigator&lt;Destination&gt;() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ActivityNavigator</span></span><br><span class="line"><span class="meta">@Navigator</span>.Name(<span class="string">&quot;activity&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">ActivityNavigator</span>(</span><br><span class="line">    <span class="comment">/** <span class="doctag">@suppress</span> */</span></span><br><span class="line">    <span class="meta">@get:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> context: Context</span><br><span class="line">) : Navigator&lt;ActivityNavigator.Destination&gt;() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. NavGraphNavigator</span></span><br><span class="line"><span class="meta">@Navigator</span>.Name(<span class="string">&quot;navigation&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NavGraphNavigator</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> navigatorProvider: NavigatorProvider</span><br><span class="line">) : Navigator&lt;NavGraph&gt;() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>这样就可以明确了，<code>Navigator</code>的<code>name</code>就是注解时的<code>value</code></li>
<li><code>FragmentNavigator</code>的<code>name</code>是<code>&quot;fragment&quot;</code></li>
<li><code>ActivityNavigator</code>的<code>name</code>是<code>&quot;activity&quot;</code></li>
<li>…</li>
</ul>
<h3 id="addNavigator"><a href="#addNavigator" class="headerlink" title="addNavigator"></a>addNavigator</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">addNavigator</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    navigator: <span class="type">Navigator</span>&lt;<span class="type">out</span> <span class="type">NavDestination</span>&gt;</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Navigator&lt;<span class="keyword">out</span> NavDestination&gt;? &#123;</span><br><span class="line">    <span class="keyword">return</span> addNavigator(getNameForNavigator(navigator.javaClass), navigator)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Register a navigator by name. [destinations][NavDestination] may refer to any</span></span><br><span class="line"><span class="comment">* registered navigator by name for inflation. If a navigator by this name is already</span></span><br><span class="line"><span class="comment">* registered, this new navigator will replace it.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> name name for this navigator</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> navigator navigator to add</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the previously added Navigator for the given name, if any</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">addNavigator</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigator: <span class="type">Navigator</span>&lt;<span class="type">out</span> <span class="type">NavDestination</span>&gt;</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Navigator&lt;<span class="keyword">out</span> NavDestination&gt;? &#123;</span><br><span class="line">    require(validateName(name)) &#123; <span class="string">&quot;navigator name cannot be an empty string&quot;</span> &#125;</span><br><span class="line">    <span class="keyword">val</span> previousNavigator = _navigators[name]</span><br><span class="line">    <span class="keyword">if</span> (previousNavigator == navigator) &#123;</span><br><span class="line">        <span class="keyword">return</span> navigator</span><br><span class="line">    &#125;</span><br><span class="line">    check(previousNavigator?.isAttached != <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="string">&quot;Navigator <span class="variable">$navigator</span> is replacing an already attached <span class="variable">$previousNavigator</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    check(!navigator.isAttached) &#123;</span><br><span class="line">        <span class="string">&quot;Navigator <span class="variable">$navigator</span> is already attached to another NavController&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _navigators.put(name, navigator)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>addNavigator</code>时，首先取出对应<code>name</code>的<code>Navigator</code><ul>
<li>如果<code>Navigator</code>和要放入的<code>Navigator</code>相同，则直接返回</li>
<li>如果前一个<code>Navigator</code>不空且没有被<code>attach</code>，则抛出异常<ul>
<li>这里判断方法为<code>previousNavigator?.isAttached != true</code>, <code>null</code>或者<code>bool</code>和<code>true</code>比较，十分简洁，值得学习！</li>
</ul>
</li>
<li>检查确认要放入的<code>Navigator</code>没有被<code>attach</code>，否则抛出异常</li>
<li>最后将<code>Navigator</code>放入<code>_navigators</code>中，并返回前一个<code>Navigator</code></li>
</ul>
</li>
<li>被替换的<code>Navigator</code>如果不空的话，不能是已经Attach的</li>
<li>想要放入的<code>Navigator</code>也不能被<code>attach</code></li>
</ul>
<h3 id="扩展get和set方法"><a href="#扩展get和set方法" class="headerlink" title="扩展get和set方法"></a>扩展get和set方法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;NOTHING_TO_INLINE&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : Navigator&lt;out NavDestination&gt;</span>&gt; NavigatorProvider.<span class="title">get</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: T = getNavigator(name)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Suppress(<span class="string">&quot;NOTHING_TO_INLINE&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : Navigator&lt;out NavDestination&gt;</span>&gt; NavigatorProvider.<span class="title">get</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    clazz: <span class="type">KClass</span>&lt;<span class="type">T</span>&gt;</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: T = getNavigator(clazz.java)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Suppress(<span class="string">&quot;NOTHING_TO_INLINE&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> NavigatorProvider.<span class="title">set</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    navigator: <span class="type">Navigator</span>&lt;<span class="type">out</span> <span class="type">NavDestination</span>&gt;</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Navigator&lt;<span class="keyword">out</span> NavDestination&gt;? = addNavigator(name, navigator)</span><br></pre></td></tr></table></figure>

<p>很简单</p>
<h3 id="扩展的-运算符"><a href="#扩展的-运算符" class="headerlink" title="扩展的+=运算符"></a>扩展的<code>+=</code>运算符</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;NOTHING_TO_INLINE&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> NavigatorProvider.<span class="title">plusAssign</span><span class="params">(navigator: <span class="type">Navigator</span>&lt;<span class="type">out</span> <span class="type">NavDestination</span>&gt;)</span></span> &#123;</span><br><span class="line">    addNavigator(navigator)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也很简单</p>
<h2 id="NavBackStackEntry"><a href="#NavBackStackEntry" class="headerlink" title="NavBackStackEntry"></a>NavBackStackEntry</h2><h3 id="先看注释"><a href="#先看注释" class="headerlink" title="先看注释"></a>先看注释</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Representation of an entry <span class="keyword">in</span> the back stack of a androidx.navigation.NavController.</span><br><span class="line">The Lifecycle, ViewModelStore, and SavedStateRegistry provided via <span class="keyword">this</span> <span class="keyword">object</span> are valid <span class="keyword">for</span> the lifetime of <span class="keyword">this</span> destination on the back stack: <span class="keyword">when</span> <span class="keyword">this</span> destination <span class="keyword">is</span> popped off the back stack, the lifecycle will be destroyed, state will no longer be saved, and ViewModels will be cleared.</span><br></pre></td></tr></table></figure>

<ul>
<li>介绍了两件事情<ul>
<li>这个类代表的是<code>NavController</code>中返回栈的一个<code>entry</code></li>
<li>他能提供<code>Lifecycle, ViewModelStore, and SavedStateRegistry</code><ul>
<li>当这个<code>NavBackStackEntry</code>存在于返回栈时，他们的生命周期时有效的，当这个<code>NavBackStackEntry</code>被pop掉时，他们的生命周期会被销毁，状态会被清除，ViewModel会被清除</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="类定义和数据结构"><a href="#类定义和数据结构" class="headerlink" title="类定义和数据结构"></a>类定义和数据结构</h3><h4 id="lifeCycle部分"><a href="#lifeCycle部分" class="headerlink" title="lifeCycle部分"></a>lifeCycle部分</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NavBackStackEntry</span> <span class="keyword">private</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> context: Context?,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The destination associated with this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The destination that is currently visible to users</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@set:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> destination: NavDestination,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> immutableArgs: Bundle? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> hostLifecycleState: Lifecycle.State = Lifecycle.State.CREATED,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModelStoreProvider: NavViewModelStoreProvider? = <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The unique ID that serves as the identity of this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the unique ID of this entry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> id: String = UUID.randomUUID().toString(),</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> savedState: Bundle? = <span class="literal">null</span></span><br><span class="line">) : LifecycleOwner,</span><br><span class="line">    ViewModelStoreOwner,</span><br><span class="line">    HasDefaultViewModelProviderFactory,</span><br><span class="line">    SavedStateRegistryOwner &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> _lifecycle = LifecycleRegistry(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> lifecycle: Lifecycle</span><br><span class="line">        <span class="keyword">get</span>() = _lifecycle</span><br><span class="line"></span><br><span class="line">    <span class="meta">@get:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="meta">@set:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> maxLifecycle: Lifecycle.State = Lifecycle.State.INITIALIZED</span><br><span class="line">        <span class="keyword">set</span>(maxState) &#123;</span><br><span class="line">            field = maxState</span><br><span class="line">            updateState()</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>很简单实现了<code>lifeCycle</code></li>
<li><code>maxLifecycle</code>是<code>Lifecycle.State</code>，保存当前的状态，默认是<code>Lifecycle.State.INITIALIZED</code></li>
<li>调用<code>maxLifecycle</code>的<code>set</code>属性时，会调用<code>updateState</code>方法<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateState</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!savedStateRegistryAttached) &#123;</span><br><span class="line">        savedStateRegistryController.performAttach()</span><br><span class="line">        savedStateRegistryAttached = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> (viewModelStoreProvider != <span class="literal">null</span>) &#123;</span><br><span class="line">            enableSavedStateHandles()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Perform the restore just once, the first time updateState() is called</span></span><br><span class="line">        <span class="comment">// and specifically *before* we move up the Lifecycle</span></span><br><span class="line">        savedStateRegistryController.performRestore(savedState)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hostLifecycleState.ordinal &lt; maxLifecycle.ordinal) &#123;</span><br><span class="line">        _lifecycle.currentState = hostLifecycleState</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _lifecycle.currentState = maxLifecycle</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>首先判断<code>savedStateRegistry</code>是否被<code>attach</code>, 如果没有，就执行<code>attach</code>,并回复状态</li>
<li>然后就是更新<code>lifeCycle</code>的状态，取<code>hostLifecycleState</code>和<code>maxLifecycle</code>之中较小的那一个</li>
</ul>
<p>这里看到一个<code>ordinal</code>不太熟悉，这个属于<code>java</code>基础</p>
<blockquote>
<p>继续挖坑<br>&#x2F;&#x2F; todo: enum, ordinal</p>
</blockquote>
<h4 id="ViewModel部分"><a href="#ViewModel部分" class="headerlink" title="ViewModel部分"></a>ViewModel部分</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NavBackStackEntry</span> <span class="keyword">private</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> context: Context?,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The destination associated with this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The destination that is currently visible to users</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@set:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> destination: NavDestination,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> immutableArgs: Bundle? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> hostLifecycleState: Lifecycle.State = Lifecycle.State.CREATED,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModelStoreProvider: NavViewModelStoreProvider? = <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The unique ID that serves as the identity of this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the unique ID of this entry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> id: String = UUID.randomUUID().toString(),</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> savedState: Bundle? = <span class="literal">null</span></span><br><span class="line">) : LifecycleOwner,</span><br><span class="line">    ViewModelStoreOwner,</span><br><span class="line">    HasDefaultViewModelProviderFactory,</span><br><span class="line">    SavedStateRegistryOwner &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> defaultFactory <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        SavedStateViewModelFactory((context?.applicationContext <span class="keyword">as</span>? Application), <span class="keyword">this</span>, arguments)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The [SavedStateHandle] for this entry.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> savedStateHandle: SavedStateHandle <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        check(savedStateRegistryAttached) &#123;</span><br><span class="line">            <span class="string">&quot;You cannot access the NavBackStackEntry&#x27;s SavedStateHandle until it is added to &quot;</span> +</span><br><span class="line">                <span class="string">&quot;the NavController&#x27;s back stack (i.e., the Lifecycle of the NavBackStackEntry &quot;</span> +</span><br><span class="line">                <span class="string">&quot;reaches the CREATED state).&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        check(lifecycle.currentState != Lifecycle.State.DESTROYED) &#123;</span><br><span class="line">            <span class="string">&quot;You cannot access the NavBackStackEntry&#x27;s SavedStateHandle after the &quot;</span> +</span><br><span class="line">                <span class="string">&quot;NavBackStackEntry is destroyed.&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        ViewModelProvider(</span><br><span class="line">            <span class="keyword">this</span>, NavResultSavedStateFactory(<span class="keyword">this</span>)</span><br><span class="line">        ).<span class="keyword">get</span>(SavedStateViewModel::<span class="keyword">class</span>.java).handle</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> defaultViewModelProviderFactory: ViewModelProvider.Factory = defaultFactory</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> defaultViewModelCreationExtras: CreationExtras</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">val</span> extras = MutableCreationExtras()</span><br><span class="line">            (context?.applicationContext <span class="keyword">as</span>? Application)?.let &#123; application -&gt;</span><br><span class="line">                extras[ViewModelProvider.AndroidViewModelFactory.APPLICATION_KEY] = application</span><br><span class="line">            &#125;</span><br><span class="line">            extras[SAVED_STATE_REGISTRY_OWNER_KEY] = <span class="keyword">this</span></span><br><span class="line">            extras[VIEW_MODEL_STORE_OWNER_KEY] = <span class="keyword">this</span></span><br><span class="line">            arguments?.let &#123; args -&gt;</span><br><span class="line">                extras[DEFAULT_ARGS_KEY] = args</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> extras</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> savedStateRegistry: SavedStateRegistry</span><br><span class="line">        <span class="keyword">get</span>() = savedStateRegistryController.savedStateRegistry</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">NavResultSavedStateFactory</span>(</span><br><span class="line">        owner: SavedStateRegistryOwner</span><br><span class="line">    ) : AbstractSavedStateViewModelFactory(owner, <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            key: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">            handle: <span class="type">SavedStateHandle</span></span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>: T &#123;</span><br><span class="line">            <span class="keyword">return</span> SavedStateViewModel(handle) <span class="keyword">as</span> T</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">SavedStateViewModel</span>(<span class="keyword">val</span> handle: SavedStateHandle) : ViewModel()</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里保留了<code>savedStateHandle</code>，和<code>viewModel</code>有一定的耦合</li>
<li>我们使用的<code>viewModel</code>就存了一个<code>SavedStateHandle</code></li>
<li>提供了默认的<code>ViewModelProvider.Factory</code>和<code>Extras</code></li>
<li>基本都是和<code>savedState</code>相关的，所以先不看了</li>
<li><code>viewModel</code>的作用<ul>
<li>提供<code>handle</code></li>
<li>提供<code>viewModelStore</code>(就是<code>viewModelName</code>到<code>viewModel</code>的<code>map</code>)</li>
</ul>
</li>
<li>&#x2F;&#x2F; todo: 学习saveState后再看</li>
<li>&#x2F;&#x2F; 疑问，为啥非要通过<code>viewModel</code>来获取<code>handle</code>呢？</li>
</ul>
<h4 id="savedState部分"><a href="#savedState部分" class="headerlink" title="savedState部分"></a>savedState部分</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NavBackStackEntry</span> <span class="keyword">private</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> context: Context?,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The destination associated with this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The destination that is currently visible to users</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@set:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> destination: NavDestination,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> immutableArgs: Bundle? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> hostLifecycleState: Lifecycle.State = Lifecycle.State.CREATED,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModelStoreProvider: NavViewModelStoreProvider? = <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The unique ID that serves as the identity of this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the unique ID of this entry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> id: String = UUID.randomUUID().toString(),</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> savedState: Bundle? = <span class="literal">null</span></span><br><span class="line">) : LifecycleOwner,</span><br><span class="line">    ViewModelStoreOwner,</span><br><span class="line">    HasDefaultViewModelProviderFactory,</span><br><span class="line">    SavedStateRegistryOwner &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> savedStateRegistryController = SavedStateRegistryController.create(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> savedStateRegistryAttached = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The [SavedStateHandle] for this entry.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> savedStateHandle: SavedStateHandle <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        check(savedStateRegistryAttached) &#123;</span><br><span class="line">            <span class="string">&quot;You cannot access the NavBackStackEntry&#x27;s SavedStateHandle until it is added to &quot;</span> +</span><br><span class="line">                <span class="string">&quot;the NavController&#x27;s back stack (i.e., the Lifecycle of the NavBackStackEntry &quot;</span> +</span><br><span class="line">                <span class="string">&quot;reaches the CREATED state).&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        check(lifecycle.currentState != Lifecycle.State.DESTROYED) &#123;</span><br><span class="line">            <span class="string">&quot;You cannot access the NavBackStackEntry&#x27;s SavedStateHandle after the &quot;</span> +</span><br><span class="line">                <span class="string">&quot;NavBackStackEntry is destroyed.&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        ViewModelProvider(</span><br><span class="line">            <span class="keyword">this</span>, NavResultSavedStateFactory(<span class="keyword">this</span>)</span><br><span class="line">        ).<span class="keyword">get</span>(SavedStateViewModel::<span class="keyword">class</span>.java).handle</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> savedStateRegistry: SavedStateRegistry</span><br><span class="line">        <span class="keyword">get</span>() = savedStateRegistryController.savedStateRegistry</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>&#x2F;&#x2F; todo: 学习saveState后再看</li>
</ul>
<h4 id="其他部分"><a href="#其他部分" class="headerlink" title="其他部分"></a>其他部分</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NavBackStackEntry</span> <span class="keyword">private</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> context: Context?,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The destination associated with this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The destination that is currently visible to users</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@set:RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> destination: NavDestination,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> immutableArgs: Bundle? = <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> hostLifecycleState: Lifecycle.State = Lifecycle.State.CREATED,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModelStoreProvider: NavViewModelStoreProvider? = <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The unique ID that serves as the identity of this entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the unique ID of this entry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> id: String = UUID.randomUUID().toString(),</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> savedState: Bundle? = <span class="literal">null</span></span><br><span class="line">) : LifecycleOwner,</span><br><span class="line">    ViewModelStoreOwner,</span><br><span class="line">    HasDefaultViewModelProviderFactory,</span><br><span class="line">    SavedStateRegistryOwner &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> arguments: Bundle?</span><br><span class="line">        <span class="keyword">get</span>() = <span class="keyword">if</span> (immutableArgs == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Bundle(immutableArgs)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>id: public的一个随机unique的id，应该是用于标识一个<code>NavBackStackEntry</code></li>
<li>arguments: 在前面的<code>defaultViewModelCreationExtras</code>和<code>defaultFactory</code>中有使用，将args提供给<code>extras</code>和<code>factory</code></li>
</ul>
<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">constructor</span>(entry: NavBackStackEntry, arguments: Bundle? = entry.arguments) : <span class="keyword">this</span>(</span><br><span class="line">    entry.context,</span><br><span class="line">    entry.destination,</span><br><span class="line">    arguments,</span><br><span class="line">    entry.hostLifecycleState,</span><br><span class="line">    entry.viewModelStoreProvider,</span><br><span class="line">    entry.id,</span><br><span class="line">    entry.savedState</span><br><span class="line">) &#123;</span><br><span class="line">    hostLifecycleState = entry.hostLifecycleState</span><br><span class="line">    maxLifecycle = entry.maxLifecycle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对外暴露的构造函数仅这一个，除了<code>arguments</code>其他都是从另一个<code>NavBackStackEntry</code>中获取的</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        context: <span class="type">Context</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        destination: <span class="type">NavDestination</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        arguments: <span class="type">Bundle</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        hostLifecycleState: <span class="type">Lifecycle</span>.<span class="type">State</span> = Lifecycle.State.CREATED,</span></span></span><br><span class="line"><span class="params"><span class="function">        viewModelStoreProvider: <span class="type">NavViewModelStoreProvider</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        id: <span class="type">String</span> = UUID.randomUUID()</span></span>.toString(),</span><br><span class="line">        savedState: Bundle? = <span class="literal">null</span></span><br><span class="line">    ): NavBackStackEntry = NavBackStackEntry(</span><br><span class="line">        context, destination, arguments,</span><br><span class="line">        hostLifecycleState, viewModelStoreProvider, id, savedState</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过create方法暴露了另外一个私有的构造函数，猜测这么做的目的是为了限制该构造函数仅在<code>navigation</code>库的范围内使用吧？</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>总的来说，这个类作为<code>NavController</code>返回栈的一个<code>entry</code>，同时提供了一些变量<ul>
<li>destination</li>
<li>id</li>
<li>arguments</li>
<li>savedStateHandle</li>
<li>maxLifecycle</li>
<li>viewModelStore</li>
</ul>
</li>
</ul>
<h2 id="NavDestination"><a href="#NavDestination" class="headerlink" title="NavDestination"></a>NavDestination</h2><h3 id="先看注释-1"><a href="#先看注释-1" class="headerlink" title="先看注释"></a>先看注释</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NavDestination represents one node within an overall navigation graph.</span><br><span class="line">Each destination <span class="keyword">is</span> associated with a Navigator which knows how to navigate to <span class="keyword">this</span> particular destination.</span><br><span class="line">Destinations declare a <span class="keyword">set</span> of actions that they support. These actions form a navigation API <span class="keyword">for</span> the destination; the same actions declared on different destinations that fill similar roles allow application code to navigate based on semantic intent.</span><br><span class="line">Each destination has a <span class="keyword">set</span> of arguments that will be applied <span class="keyword">when</span> navigating to that destination. Any default values <span class="keyword">for</span> those arguments can be overridden at the time of navigation.</span><br><span class="line">NavDestinations should be created via Navigator.createDestination.</span><br></pre></td></tr></table></figure>
<ul>
<li><code>NavDestination</code>代表一个导航图中的一个节点</li>
<li>每个<code>NavDestination</code>都关联一个<code>Navigator</code>，<code>Navigator</code>知道如何导航到这个<code>NavDestination</code></li>
<li>保存一组<code>action</code><ul>
<li>后半句有点难懂，不同<code>destinations</code>中相同的<code>action</code>发挥相同的作用，可以允许应用代码基于语义intent导航</li>
</ul>
</li>
<li>每个destination都有一组args，在导航到这个destination时可能会被覆盖</li>
<li><code>NavDestinations</code>应该通过<code>Navigator.createDestination</code>创建</li>
</ul>
<h3 id="类定义和数据结构-1"><a href="#类定义和数据结构-1" class="headerlink" title="类定义和数据结构"></a>类定义和数据结构</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NavDestination</span>(</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The name associated with this destination&#x27;s [Navigator].</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> navigatorName: String</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="meta">@kotlin</span>.<span class="keyword">annotation</span>.Retention(AnnotationRetention.BINARY)</span><br><span class="line">    <span class="meta">@Target(AnnotationTarget.ANNOTATION_CLASS, AnnotationTarget.CLASS)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">annotation</span> <span class="keyword">class</span> <span class="title class_">ClassType</span>(<span class="keyword">val</span> value: KClass&lt;*&gt;) <span class="comment">// 1. 注解</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> parent: NavGraph? = <span class="literal">null</span> <span class="comment">// 2. partent</span></span><br><span class="line">        <span class="comment">/** <span class="doctag">@suppress</span> */</span></span><br><span class="line">        <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">set</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> idName: String? = <span class="literal">null</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> label: CharSequence? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> deepLinks = mutableListOf&lt;NavDeepLink&gt;() <span class="comment">// 3. deepLinks</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> actions: SparseArrayCompat&lt;NavAction&gt; = SparseArrayCompat() <span class="comment">// 4. actions</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> _arguments: MutableMap&lt;String, NavArgument&gt; = mutableMapOf() <span class="comment">// 5. args</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> arguments: Map&lt;String, NavArgument&gt;</span><br><span class="line">        <span class="keyword">get</span>() = _arguments.toMap()</span><br><span class="line">    <span class="meta">@get:IdRes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> id: <span class="built_in">Int</span> = <span class="number">0</span> <span class="comment">// 6. id</span></span><br><span class="line">        <span class="keyword">set</span>(<span class="meta">@IdRes</span> id) &#123;</span><br><span class="line">            field = id</span><br><span class="line">            idName = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> route: String? = <span class="literal">null</span> <span class="comment">// 7. route</span></span><br><span class="line">        <span class="keyword">set</span>(route) &#123;</span><br><span class="line">            <span class="keyword">if</span> (route == <span class="literal">null</span>) &#123;</span><br><span class="line">                id = <span class="number">0</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                require(route.isNotBlank()) &#123; <span class="string">&quot;Cannot have an empty route&quot;</span> &#125;</span><br><span class="line">                <span class="keyword">val</span> internalRoute = createRoute(route)</span><br><span class="line">                id = internalRoute.hashCode()</span><br><span class="line">                addDeepLink(internalRoute)</span><br><span class="line">            &#125;</span><br><span class="line">            deepLinks.remove(deepLinks.firstOrNull &#123; it.uriPattern == createRoute(field) &#125;)</span><br><span class="line">            field = route</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">val</span> displayName: String</span><br><span class="line">        <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">        <span class="keyword">get</span>() = idName ?: id.toString()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">val</span> NavDestination.hierarchy: Sequence&lt;NavDestination&gt; <span class="comment">// 8. hierarchy</span></span><br><span class="line">            <span class="keyword">get</span>() = generateSequence(<span class="keyword">this</span>) &#123; it.parent &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h4 id="1-注解"><a href="#1-注解" class="headerlink" title="1. 注解"></a><code>1. 注解</code></h4><p>在子类中使用，在<code>XXXNavigator</code>中会有内部类<code>Destination</code>继承<code>NavDestination</code>，并使用该注解标注其导航的<code>class</code></p>
<p>如，在<code>FragmentNavigator</code>中</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NavDestination</span>.ClassType(Fragment::<span class="keyword">class</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">Destination</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">constructor</span>(fragmentNavigator: Navigator&lt;<span class="keyword">out</span> Destination&gt;) :</span><br><span class="line">    NavDestination(fragmentNavigator) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>暂时没有找到获取并使用这个注解的代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This optional <span class="keyword">annotation</span> allows tooling to offer auto-complete <span class="keyword">for</span> the android:name attribute. This should match the <span class="keyword">class</span> <span class="title class_">type</span> <span class="title">passed</span> <span class="title">to</span> <span class="title">parseClassFromName</span> <span class="title">when</span> <span class="title">parsing</span> <span class="title">the</span> <span class="title">android</span>:<span class="type">name</span> <span class="title">attribute</span>.</span><br></pre></td></tr></table></figure>
<p>看起来是xml自动补全的时候会用到</p>
<h4 id="2-parent"><a href="#2-parent" class="headerlink" title="2. parent"></a><code>2. parent</code></h4><p>parent是<code>NavGraph</code>，表示当前<code>NavDestination</code>的父节点，同时剧透一下, <code>NavGraph</code>是<code>NavDestination</code>的子类</p>
<h4 id="8-hierarchy"><a href="#8-hierarchy" class="headerlink" title="8. hierarchy"></a><code>8. hierarchy</code></h4><p><code>hierarchy</code>是一个扩展属性，从当前<code>NavDestination</code>开始，生成一个父节点的sequence</p>
<h4 id="3-deepLinks"><a href="#3-deepLinks" class="headerlink" title="3. deepLinks"></a><code>3. deepLinks</code></h4><p>deepLinks是一个list, 在<code>matchDeepLink</code>时会遍历该list，寻找到最佳match的<code>NavDeepLink</code></p>
<h4 id="4-actions"><a href="#4-actions" class="headerlink" title="4. actions"></a><code>4. actions</code></h4><p>action是一个SparseArrayCompat，也就是一个<code>Int</code>到<code>Object</code>的<code>Map</code></p>
<h4 id="7-route"><a href="#7-route" class="headerlink" title="7. route"></a><code>7. route</code></h4><p>代表当前Destination的route字符串，可以看到他也调用了<code>addDeepLink</code></p>
<h3 id="addDeepLink"><a href="#addDeepLink" class="headerlink" title="addDeepLink"></a>addDeepLink</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">addDeepLink</span><span class="params">(uriPattern: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    addDeepLink(NavDeepLink.Builder().setUriPattern(uriPattern).build())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">addDeepLink</span><span class="params">(navDeepLink: <span class="type">NavDeepLink</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> missingRequiredArguments = _arguments.missingRequiredArguments &#123; key -&gt;</span><br><span class="line">        key !<span class="keyword">in</span> navDeepLink.argumentsNames</span><br><span class="line">    &#125;</span><br><span class="line">    require(missingRequiredArguments.isEmpty()) &#123;</span><br><span class="line">        <span class="string">&quot;Deep link <span class="subst">$&#123;navDeepLink.uriPattern&#125;</span> can&#x27;t be used to open destination <span class="variable">$this</span>.\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;Following required arguments are missing: <span class="variable">$missingRequiredArguments</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    deepLinks.add(navDeepLink)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个函数是给<code>route</code>使用的，将route字符串变成一个<code>NavDeepLink</code><br>第二个函数很简单，就是将<code>NavDeepLink</code>添加到<code>deepLinks</code>中，在放入之前会检查一下，保证<code>_arguments</code>中的key全部存在于<code>deepLink</code>的<code>argumentsNames</code>中</p>
<h3 id="route转换成NavDeepLinkRequest"><a href="#route转换成NavDeepLinkRequest" class="headerlink" title="route转换成NavDeepLinkRequest"></a>route转换成NavDeepLinkRequest</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">createRoute</span><span class="params">(route: <span class="type">String</span>?)</span></span>: String =</span><br><span class="line">    <span class="keyword">if</span> (route != <span class="literal">null</span>) <span class="string">&quot;android-app://androidx.navigation/<span class="variable">$route</span>&quot;</span> <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NavDeepLinkRequest.Builder#build</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">build</span><span class="params">()</span></span>: NavDeepLinkRequest &#123;</span><br><span class="line">    <span class="keyword">return</span> NavDeepLinkRequest(uri, action, mimeType)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是把route根据特定格式转换成一个uri，存到<code>NavDeepLinkRequest</code>这个类中，这个类也很简单</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NavDeepLinkRequest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">val</span> uri: Uri?</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">val</span> action: String?</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">val</span> mimeType: String?</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是用来存这三个东西的</p>
<h3 id="matchDeepLink"><a href="#matchDeepLink" class="headerlink" title="matchDeepLink"></a>matchDeepLink</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">matchDeepLink</span><span class="params">(route: <span class="type">String</span>)</span></span>: DeepLinkMatch? &#123;</span><br><span class="line">    <span class="keyword">val</span> request = NavDeepLinkRequest.Builder.fromUri(createRoute(route).toUri()).build()</span><br><span class="line">    <span class="keyword">val</span> matchingDeepLink = <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> NavGraph) &#123;</span><br><span class="line">        matchDeepLinkExcludingChildren(request)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        matchDeepLink(request)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> matchingDeepLink</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数是用来通过route来匹配DeepLink的，如果当前<code>NavDestination</code>是子类<code>NavGraph</code>，则会调用子类的函数<code>matchDeepLinkExcludingChildren</code>，否则调用<code>matchDeepLink</code>。<code>matchDeepLinkExcludingChildren</code>在后面介绍</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">matchDeepLink</span><span class="params">(navDeepLinkRequest: <span class="type">NavDeepLinkRequest</span>)</span></span>: DeepLinkMatch? &#123;</span><br><span class="line">    <span class="keyword">if</span> (deepLinks.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> bestMatch: DeepLinkMatch? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">for</span> (deepLink <span class="keyword">in</span> deepLinks) &#123;</span><br><span class="line">        <span class="keyword">val</span> uri = navDeepLinkRequest.uri</span><br><span class="line">        <span class="comment">// includes matching args for path, query, and fragment</span></span><br><span class="line">        <span class="keyword">val</span> matchingArguments =</span><br><span class="line">            <span class="keyword">if</span> (uri != <span class="literal">null</span>) deepLink.getMatchingArguments(uri, _arguments) <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">        <span class="keyword">val</span> matchingPathSegments = deepLink.calculateMatchingPathSegments(uri)</span><br><span class="line">        <span class="keyword">val</span> requestAction = navDeepLinkRequest.action</span><br><span class="line">        <span class="keyword">val</span> matchingAction = requestAction != <span class="literal">null</span> &amp;&amp; requestAction ==</span><br><span class="line">            deepLink.action</span><br><span class="line">        <span class="keyword">val</span> mimeType = navDeepLinkRequest.mimeType</span><br><span class="line">        <span class="keyword">val</span> mimeTypeMatchLevel =</span><br><span class="line">            <span class="keyword">if</span> (mimeType != <span class="literal">null</span>) deepLink.getMimeTypeMatchRating(mimeType) <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (matchingArguments != <span class="literal">null</span> || ((matchingAction || mimeTypeMatchLevel &gt; -<span class="number">1</span>) &amp;&amp;</span><br><span class="line">                hasRequiredArguments(deepLink, uri, _arguments))</span><br><span class="line">        ) &#123; <span class="comment">// 2. match的条件</span></span><br><span class="line">            <span class="keyword">val</span> newMatch = DeepLinkMatch(</span><br><span class="line">                <span class="keyword">this</span>, matchingArguments,</span><br><span class="line">                deepLink.isExactDeepLink, matchingPathSegments, matchingAction,</span><br><span class="line">                mimeTypeMatchLevel</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> (bestMatch == <span class="literal">null</span> || newMatch &gt; bestMatch) &#123; <span class="comment">// 1. 比较match, 选择最好的一个match</span></span><br><span class="line">                bestMatch = newMatch</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bestMatch</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>就是遍历所有deepLinks数组，找到最match的一个</li>
<li>&#x2F;&#x2F; todo: 2. match的条件</li>
</ul>
<h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个destination的唯一id，必须是资源id</span></span><br><span class="line"><span class="meta">@get:IdRes</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> id: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">set</span>(<span class="meta">@IdRes</span> id) &#123;</span><br><span class="line">        field = id</span><br><span class="line">        idName = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里就有疑问了，这里的id应该是导航图xml的id，如下所示，id在onInflate的时候被赋值。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInflate</span><span class="params">(context: <span class="type">Context</span>, attrs: <span class="type">AttributeSet</span>)</span></span> &#123;</span><br><span class="line">    context.resources.obtainAttributes(attrs, R.styleable.Navigator).use &#123; array -&gt;</span><br><span class="line">        route = array.getString(R.styleable.Navigator_route)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (array.hasValue(R.styleable.Navigator_android_id)) &#123;</span><br><span class="line">            id = array.getResourceId(R.styleable.Navigator_android_id, <span class="number">0</span>)</span><br><span class="line">            idName = getDisplayName(context, id)</span><br><span class="line">        &#125;</span><br><span class="line">        label = array.getText(R.styleable.Navigator_android_label)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但在Compose中，并不使用xml的导航图，如何初始化这个id呢？</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> route: String? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">set</span>(route) &#123;</span><br><span class="line">        <span class="keyword">if</span> (route == <span class="literal">null</span>) &#123;</span><br><span class="line">            id = <span class="number">0</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            require(route.isNotBlank()) &#123; <span class="string">&quot;Cannot have an empty route&quot;</span> &#125;</span><br><span class="line">            <span class="keyword">val</span> internalRoute = createRoute(route)</span><br><span class="line">            id = internalRoute.hashCode()</span><br><span class="line">            addDeepLink(internalRoute)</span><br><span class="line">        &#125;</span><br><span class="line">        deepLinks.remove(deepLinks.firstOrNull &#123; it.uriPattern == createRoute(field) &#125;)</span><br><span class="line">        field = route</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里，如果是compose的route字符串，createRoute后，会使用hashCode为id赋值</p>
<h3 id="addInDefaultArgs"><a href="#addInDefaultArgs" class="headerlink" title="addInDefaultArgs"></a>addInDefaultArgs</h3><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>大概作用就是</p>
<ul>
<li>保存action对象，维护了一个map，保存action的resId到action对象</li>
<li>提供navigatorName，方便NavController根据name找到对应的Navigator</li>
<li>维护deeplink列表，提供deeplink匹配的方法</li>
<li>提供parent和hierarchy，提供嵌套图的支持</li>
<li>提供route到deeplinkRequest的转换</li>
</ul>
<h2 id="NavGraph"><a href="#NavGraph" class="headerlink" title="NavGraph"></a>NavGraph</h2><h3 id="先看注释-2"><a href="#先看注释-2" class="headerlink" title="先看注释"></a>先看注释</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NavGraph <span class="keyword">is</span> a collection of NavDestination nodes fetchable <span class="keyword">by</span> ID.</span><br><span class="line">A NavGraph serves <span class="keyword">as</span> a <span class="string">&#x27;virtual&#x27;</span> destination: <span class="keyword">while</span> the NavGraph itself will not appear on the back stack, navigating to the NavGraph will cause the starting destination to be added to the back stack.</span><br><span class="line">Construct a new NavGraph. This NavGraph <span class="keyword">is</span> not valid until you add a destination and <span class="keyword">set</span> the starting destination.</span><br><span class="line">Params:</span><br><span class="line">navGraphNavigator - The NavGraphNavigator which <span class="keyword">this</span> destination will be associated with. Generally retrieved via a NavController<span class="string">&#x27;sNavigatorProvider.getNavigator method.</span></span><br></pre></td></tr></table></figure>

<ul>
<li>存储了图中所有的节点，可以通过id获取各个节点<ul>
<li>这里的节点就是上面介绍的<code>NavDestination</code></li>
</ul>
</li>
<li>导航图本身是一个虚拟的destination，但是他不会出现在栈中，如果试图导航到NavGraph，将会导航到这个导航图的<code>startDest</code>中</li>
</ul>
<h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NavGraph</span>(navGraphNavigator: Navigator&lt;<span class="keyword">out</span> NavGraph&gt;) :</span><br><span class="line">    NavDestination(navGraphNavigator), Iterable&lt;NavDestination&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> nodes: SparseArrayCompat&lt;NavDestination&gt; = SparseArrayCompat&lt;NavDestination&gt;()</span><br><span class="line">        <span class="comment">/** <span class="doctag">@suppress</span> */</span></span><br><span class="line">        <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> startDestId = <span class="number">0</span></span><br><span class="line">    <span class="meta">@get:IdRes</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> startDestinationId: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">get</span>() = startDestId</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>(startDestId) &#123;</span><br><span class="line">            require(startDestId != id) &#123;</span><br><span class="line">                <span class="string">&quot;Start destination <span class="variable">$startDestId</span> cannot use the same id as the graph <span class="variable">$this</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (startDestinationRoute != <span class="literal">null</span>) &#123;</span><br><span class="line">                startDestinationRoute = <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.startDestId = startDestId</span><br><span class="line">            startDestIdName = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> startDestinationRoute: String? = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>(startDestRoute) &#123;</span><br><span class="line">            startDestId = <span class="keyword">if</span> (startDestRoute == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="number">0</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                require(startDestRoute != route) &#123;</span><br><span class="line">                    <span class="string">&quot;Start destination <span class="variable">$startDestRoute</span> cannot use the same route as the graph <span class="variable">$this</span>&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                require(startDestRoute.isNotBlank()) &#123;</span><br><span class="line">                    <span class="string">&quot;Cannot have an empty start destination route&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> internalRoute = createRoute(startDestRoute)</span><br><span class="line">                internalRoute.hashCode()</span><br><span class="line">            &#125;</span><br><span class="line">            field = startDestRoute</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>nodes，存储所有destination的map，key时destination的id</li>
<li>startDestId，startDestinationRoute起始destination的id、route<ul>
<li>如果startDestinationRoute不空，和id的情况相同，createRoute后，使用hashCode作为startDestId</li>
</ul>
</li>
</ul>
<h3 id="onInflate-1"><a href="#onInflate-1" class="headerlink" title="onInflate"></a>onInflate</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInflate</span><span class="params">(context: <span class="type">Context</span>, attrs: <span class="type">AttributeSet</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onInflate(context, attrs)</span><br><span class="line">    context.resources.obtainAttributes(</span><br><span class="line">        attrs,</span><br><span class="line">        R.styleable.NavGraphNavigator</span><br><span class="line">    ).use &#123;</span><br><span class="line">        startDestinationId = it.getResourceId(R.styleable.NavGraphNavigator_startDestination, <span class="number">0</span>)</span><br><span class="line">        startDestIdName = getDisplayName(context, startDestId)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析xml时，从xml中获取startDestination的id</p>
<h3 id="matchDeepLink-1"><a href="#matchDeepLink-1" class="headerlink" title="matchDeepLink"></a>matchDeepLink</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">matchDeepLink</span><span class="params">(navDeepLinkRequest: <span class="type">NavDeepLinkRequest</span>)</span></span>: DeepLinkMatch? &#123;</span><br><span class="line">    <span class="comment">// First search through any deep links directly added to this NavGraph</span></span><br><span class="line">    <span class="keyword">val</span> bestMatch = <span class="keyword">super</span>.matchDeepLink(navDeepLinkRequest)</span><br><span class="line">    <span class="comment">// Then search through all child destinations for a matching deep link</span></span><br><span class="line">    <span class="keyword">val</span> bestChildMatch = mapNotNull &#123; child -&gt;</span><br><span class="line">        child.matchDeepLink(navDeepLinkRequest)</span><br><span class="line">    &#125;.maxOrNull()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> listOfNotNull(bestMatch, bestChildMatch).maxOrNull()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">matchDeepLinkExcludingChildren</span><span class="params">(request: <span class="type">NavDeepLinkRequest</span>)</span></span>: DeepLinkMatch? =</span><br><span class="line">    <span class="keyword">super</span>.matchDeepLink(request)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>navGraph本身也可以作为一个destination，拥有deeplink，所以先搜索他自身的match，然后搜索所有子节点的match，最后返回最match的一个</li>
<li>这个函数只有在使用route字符串匹配时会使用，通过route匹配时就不考虑子节点，为什么呢？</li>
</ul>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><ul>
<li>其实本质上也是一个保存子节点的map</li>
<li>提供matchDeepLink方法，用于匹配子子节点和自己本身deeplink</li>
</ul>
<h2 id="NavigatorState"><a href="#NavigatorState" class="headerlink" title="NavigatorState"></a>NavigatorState</h2><h2 id="NavControllerNavigatorState"><a href="#NavControllerNavigatorState" class="headerlink" title="NavControllerNavigatorState"></a>NavControllerNavigatorState</h2><h2 id="NavControllerViewModel"><a href="#NavControllerViewModel" class="headerlink" title="NavControllerViewModel"></a>NavControllerViewModel</h2><h2 id="FragmentNavigator"><a href="#FragmentNavigator" class="headerlink" title="FragmentNavigator"></a>FragmentNavigator</h2><h2 id="ActivityNavigator"><a href="#ActivityNavigator" class="headerlink" title="ActivityNavigator"></a>ActivityNavigator</h2><h2 id="总结中的总结"><a href="#总结中的总结" class="headerlink" title="总结中的总结"></a>总结中的总结</h2><h3 id="需要一个NavHostFragment"><a href="#需要一个NavHostFragment" class="headerlink" title="需要一个NavHostFragment"></a>需要一个NavHostFragment</h3><p>想要使用<code>navigation</code>库，需要有一个<code>NavHostFragment</code>。<code>navigation</code>库为<code>Fragment</code>, <code>View</code>, <code>Acivity</code>都添加了扩展函数<code>findNavController</code>，用来找到<code>navController</code>，查找时都需要一个<code>NavHostFragment</code>的存在。</p>
<ul>
<li>对于<code>Fragment</code>来说，需要它本身，或者所有上级<code>Fragment</code>中存在一个<code>NavHostFragment</code></li>
<li>对于View来说，需要他本身，或者所有上级view的tag中，存在<code>R.id.nav_controller_view_tag</code>,这个tag下可以获得NavController。NavHostFragment的<a href="#onviewcreated">onViewCreated</a>方法中,会对<code>Fragment</code>的<code>rootView</code>设置这个<code>tag</code></li>
<li>对于<code>activity</code>来说，需要指定一个<code>viewId</code>，通过<code>findView</code>找到这个<code>view</code>后，寻找过程和<code>View</code>相同</li>
</ul>
<p>这个<code>NavHostFragment</code>的<code>graphId</code>不能通过用户传入，因为这个变量是<code>private</code>的。<code>NavHostFragment</code>通过<code>xml</code>获取这个导航图的<code>id</code>，或者使用<code>KEY_GRAPH_ID</code>从<code>savedState</code>或<code>Fragment</code>的<code>mArguments</code>中获取，而这个<code>KEY_GRAPH_ID</code>也是仅在<code>navigation</code>库中可用的。</p>
<p><code>NavHostFragment</code>实现了<code>NavHost</code>，拥有了一个<code>NavController</code>，通过它的<code>navigate</code>方法可以进行跳转。<br><code>NavHostFragment</code>实现<code>NavController</code>的实现类是<code>NavHostController</code>,这个类中没有任何函数实现，只是将父类的几个函数变成<code>final</code>的</p>
<h3 id="导航图-1"><a href="#导航图-1" class="headerlink" title="导航图"></a>导航图</h3><ul>
<li>导航图可以通过<code>xml</code>和<code>kotlin DSL</code>描述。</li>
<li>导航图可以包含多个子节点，每个子节点都是一个<code>destination</code>。<ul>
<li>每个<code>destination</code>可以是<code>fragment</code>，<code>activity</code>，<code>dialog</code>，或者一个<code>NavGraph</code>作为子图。每个<code>destination</code>可以包含多个<code>action</code><ul>
<li>每个<code>action</code>包含它本身的<code>id</code>和导航目的地的<code>destinationId</code>，用于确定导航的目的地。</li>
</ul>
</li>
<li>每个<code>destination</code>也可以包含多个<code>deeplink</code><ul>
<li><code>NavController</code>通过<code>deeplink</code>进行导航时，会搜索导航图，以及导航图中的<code>destination</code>的<code>deeplink</code>，找到匹配度最高的一个，进行导航。</li>
<li>在<code>Compose</code>中使用<code>route</code>字符串进行导航时，实际上会将其包装为一个<code>uri</code>类型的<code>deeplink</code>，然后进行匹配。</li>
<li>每个<code>deeplink</code>包含其<code>uri</code>，<code>action</code>字符串，<code>mimeType</code>字符串，用于匹配。</li>
</ul>
</li>
</ul>
</li>
<li>导航图本身也是一个<code>destination</code>，导航到一个<code>NavGraph</code>是，会导航到<code>startDestination</code>。<ul>
<li>在<code>xml</code>中，给根节点<code>&lt;navigation&gt;</code>添加<code>startDestination</code>参数，填写一个<code>destinationId</code>，作为<code>startDestination</code>。</li>
<li>在<code>kotlin DSL</code>中，通过<code>startDestination</code>指定一个<code>route</code>字符串，作为<code>startDestination</code></li>
</ul>
</li>
</ul>
<h3 id="NavController-1"><a href="#NavController-1" class="headerlink" title="NavController"></a>NavController</h3><ul>
<li>这个类是整个<code>navigation</code>库的核心<ul>
<li>提供多种<code>navigate</code>方法，可以通过<code>destination</code>的<code>resId</code>，<code>route</code>字符串和<code>deepLink</code>进行导航</li>
<li>这个类维护了导航图<code>NavGraph</code>，返回栈<code>_currentBackStack</code>等数据结构</li>
<li>这个类并承担具体的跳转任务，具体的跳转任务由<code>Navigator</code>的各个子类完成<ul>
<li>上面说到导航目的地有很多种类，<code>NavController</code>会根据导航目的地的类型，选择不同的<code>Navigator</code>来完成跳转任务，比如<code>FragmentNavigator</code>，<code>ActivityNavigator</code>，<code>DialogNavigator</code></li>
<li>每个<code>Navigator</code>都有<code>name</code>，是通过一个注解<code>Navigator.Name</code>指定的。</li>
<li><code>NavController</code>中因此也维护了<code>_navigatorProvider</code>，他的作用类似于一个<code>map</code>,存储<code>Navigator</code>的<code>name</code>和<code>Navigator</code>的映射关系。</li>
</ul>
</li>
</ul>
</li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>基础05-Navigation</p><p><a href="https://jingtianer.github.io/home/2024/08/07/Android高级/源码阅读/基础05-Navigation/">https://jingtianer.github.io/home/2024/08/07/Android高级/源码阅读/基础05-Navigation/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Meow Meow Liu</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-08-07</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-04-15</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/home/tags/Android-%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81/">Android-官方源码</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/home/2024/08/18/LeetCode/LeetCode-%E5%88%B7%E9%A2%98%E6%80%BB%E7%BB%9336/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">LeetCode-36</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/home/2024/08/06/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8004-LiveData/"><span class="level-item">基础04-LiveData</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "ec91f926ed85d224cfcca544f96e4325",
            repo: "blog_comment",
            owner: "jingtianer",
            clientID: "f0b13fe8021fcd2efe50",
            clientSecret: "35207c14b34e77c48a3aeee1e94c9da169ffe0c2",
            admin: ["jingtianer"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#简介"><span class="level-left"><span class="level-item">1</span><span class="level-item">简介</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#获取NavController"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">获取NavController</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Fragment-findNavController"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">Fragment.findNavController</span></span></a></li><li><a class="level is-mobile" href="#View-findNavController"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">View.findNavController</span></span></a></li><li><a class="level is-mobile" href="#Activity-findNavController"><span class="level-left"><span class="level-item">1.1.3</span><span class="level-item">Activity.findNavController</span></span></a></li><li><a class="level is-mobile" href="#findViewNavController-view-View"><span class="level-left"><span class="level-item">1.1.4</span><span class="level-item">findViewNavController(view: View)</span></span></a></li></ul></li><li><a class="level is-mobile" href="#导航图"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">导航图</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#使用kotlin-DSL"><span class="level-left"><span class="level-item">1.2.1</span><span class="level-item">使用kotlin DSL</span></span></a></li><li><a class="level is-mobile" href="#xml"><span class="level-left"><span class="level-item">1.2.2</span><span class="level-item">xml</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#NavHostFragment"><span class="level-left"><span class="level-item">2</span><span class="level-item">NavHostFragment</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#navHostController"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">navHostController</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-lazy"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">1: lazy</span></span></a></li><li><a class="level is-mobile" href="#2-获取context并判空"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">2: 获取context并判空</span></span></a></li><li><a class="level is-mobile" href="#6-回调通知fragment"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">6: 回调通知fragment</span></span></a></li><li><a class="level is-mobile" href="#7-savedState相关的看不懂，todo-以后再看"><span class="level-left"><span class="level-item">2.1.4</span><span class="level-item">7: savedState相关的看不懂，todo: 以后再看</span></span></a></li><li><a class="level is-mobile" href="#8-setGraph"><span class="level-left"><span class="level-item">2.1.5</span><span class="level-item">8: setGraph</span></span></a></li></ul></li><li><a class="level is-mobile" href="#创建NavHostFragment"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">创建NavHostFragment</span></span></a></li><li><a class="level is-mobile" href="#几个key的定义"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">几个key的定义</span></span></a></li><li><a class="level is-mobile" href="#onInflate"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">onInflate</span></span></a></li><li><a class="level is-mobile" href="#onSaveInstanceState"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">onSaveInstanceState</span></span></a></li><li><a class="level is-mobile" href="#onCreate"><span class="level-left"><span class="level-item">2.6</span><span class="level-item">onCreate</span></span></a></li><li><a class="level is-mobile" href="#onViewCreated"><span class="level-left"><span class="level-item">2.7</span><span class="level-item">onViewCreated</span></span></a></li><li><a class="level is-mobile" href="#onDestroyView"><span class="level-left"><span class="level-item">2.8</span><span class="level-item">onDestroyView</span></span></a></li><li><a class="level is-mobile" href="#defaultNavHost"><span class="level-left"><span class="level-item">2.9</span><span class="level-item">defaultNavHost</span></span></a></li></ul></li><li><a class="level is-mobile" href="#NavHostController类"><span class="level-left"><span class="level-item">3</span><span class="level-item">NavHostController类</span></span></a></li><li><a class="level is-mobile" href="#NavController"><span class="level-left"><span class="level-item">4</span><span class="level-item">NavController</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-生成实例"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">3: 生成实例</span></span></a></li><li><a class="level is-mobile" href="#4-传递fragment为lifecycleOwner"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">4: 传递fragment为lifecycleOwner</span></span></a></li><li><a class="level is-mobile" href="#5-传递fragment的viewModelStore"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">5: 传递fragment的viewModelStore</span></span></a></li><li><a class="level is-mobile" href="#8-setGraph-1"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">8: setGraph</span></span></a></li><li><a class="level is-mobile" href="#navigate"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">navigate</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#通过action的资源id跳转的"><span class="level-left"><span class="level-item">4.5.1</span><span class="level-item">通过action的资源id跳转的</span></span></a></li><li><a class="level is-mobile" href="#通过NavDirections跳转的"><span class="level-left"><span class="level-item">4.5.2</span><span class="level-item">通过NavDirections跳转的</span></span></a></li><li><a class="level is-mobile" href="#通过Uri类型的DeepLink跳转的"><span class="level-left"><span class="level-item">4.5.3</span><span class="level-item">通过Uri类型的DeepLink跳转的</span></span></a></li><li><a class="level is-mobile" href="#通过route跳转的"><span class="level-left"><span class="level-item">4.5.4</span><span class="level-item">通过route跳转的</span></span></a></li><li><a class="level is-mobile" href="#通过NavDeepLinkRequest跳转的"><span class="level-left"><span class="level-item">4.5.5</span><span class="level-item">通过NavDeepLinkRequest跳转的</span></span></a></li><li><a class="level is-mobile" href="#核心的navigate方法"><span class="level-left"><span class="level-item">4.5.6</span><span class="level-item">核心的navigate方法</span></span></a></li><li><a class="level is-mobile" href="#3-singleTop的情况"><span class="level-left"><span class="level-item">4.5.7</span><span class="level-item">3: singleTop的情况</span></span></a></li><li><a class="level is-mobile" href="#其他情况"><span class="level-left"><span class="level-item">4.5.8</span><span class="level-item">其他情况</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#NavigatorProvider"><span class="level-left"><span class="level-item">5</span><span class="level-item">NavigatorProvider</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#数据结构"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">数据结构</span></span></a></li><li><a class="level is-mobile" href="#获取Navigator"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">获取Navigator</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#getNameForNavigator"><span class="level-left"><span class="level-item">5.2.1</span><span class="level-item">getNameForNavigator</span></span></a></li></ul></li><li><a class="level is-mobile" href="#addNavigator"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">addNavigator</span></span></a></li><li><a class="level is-mobile" href="#扩展get和set方法"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">扩展get和set方法</span></span></a></li><li><a class="level is-mobile" href="#扩展的-运算符"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">扩展的+=运算符</span></span></a></li></ul></li><li><a class="level is-mobile" href="#NavBackStackEntry"><span class="level-left"><span class="level-item">6</span><span class="level-item">NavBackStackEntry</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#先看注释"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">先看注释</span></span></a></li><li><a class="level is-mobile" href="#类定义和数据结构"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">类定义和数据结构</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#lifeCycle部分"><span class="level-left"><span class="level-item">6.2.1</span><span class="level-item">lifeCycle部分</span></span></a></li><li><a class="level is-mobile" href="#ViewModel部分"><span class="level-left"><span class="level-item">6.2.2</span><span class="level-item">ViewModel部分</span></span></a></li><li><a class="level is-mobile" href="#savedState部分"><span class="level-left"><span class="level-item">6.2.3</span><span class="level-item">savedState部分</span></span></a></li><li><a class="level is-mobile" href="#其他部分"><span class="level-left"><span class="level-item">6.2.4</span><span class="level-item">其他部分</span></span></a></li><li><a class="level is-mobile" href="#构造函数"><span class="level-left"><span class="level-item">6.2.5</span><span class="level-item">构造函数</span></span></a></li></ul></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">总结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#NavDestination"><span class="level-left"><span class="level-item">7</span><span class="level-item">NavDestination</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#先看注释-1"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">先看注释</span></span></a></li><li><a class="level is-mobile" href="#类定义和数据结构-1"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">类定义和数据结构</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-注解"><span class="level-left"><span class="level-item">7.2.1</span><span class="level-item">1. 注解</span></span></a></li><li><a class="level is-mobile" href="#2-parent"><span class="level-left"><span class="level-item">7.2.2</span><span class="level-item">2. parent</span></span></a></li><li><a class="level is-mobile" href="#8-hierarchy"><span class="level-left"><span class="level-item">7.2.3</span><span class="level-item">8. hierarchy</span></span></a></li><li><a class="level is-mobile" href="#3-deepLinks"><span class="level-left"><span class="level-item">7.2.4</span><span class="level-item">3. deepLinks</span></span></a></li><li><a class="level is-mobile" href="#4-actions"><span class="level-left"><span class="level-item">7.2.5</span><span class="level-item">4. actions</span></span></a></li><li><a class="level is-mobile" href="#7-route"><span class="level-left"><span class="level-item">7.2.6</span><span class="level-item">7. route</span></span></a></li></ul></li><li><a class="level is-mobile" href="#addDeepLink"><span class="level-left"><span class="level-item">7.3</span><span class="level-item">addDeepLink</span></span></a></li><li><a class="level is-mobile" href="#route转换成NavDeepLinkRequest"><span class="level-left"><span class="level-item">7.4</span><span class="level-item">route转换成NavDeepLinkRequest</span></span></a></li><li><a class="level is-mobile" href="#matchDeepLink"><span class="level-left"><span class="level-item">7.5</span><span class="level-item">matchDeepLink</span></span></a></li><li><a class="level is-mobile" href="#id"><span class="level-left"><span class="level-item">7.6</span><span class="level-item">id</span></span></a></li><li><a class="level is-mobile" href="#addInDefaultArgs"><span class="level-left"><span class="level-item">7.7</span><span class="level-item">addInDefaultArgs</span></span></a></li><li><a class="level is-mobile" href="#总结-1"><span class="level-left"><span class="level-item">7.8</span><span class="level-item">总结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#NavGraph"><span class="level-left"><span class="level-item">8</span><span class="level-item">NavGraph</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#先看注释-2"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">先看注释</span></span></a></li><li><a class="level is-mobile" href="#数据结构-1"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">数据结构</span></span></a></li><li><a class="level is-mobile" href="#onInflate-1"><span class="level-left"><span class="level-item">8.3</span><span class="level-item">onInflate</span></span></a></li><li><a class="level is-mobile" href="#matchDeepLink-1"><span class="level-left"><span class="level-item">8.4</span><span class="level-item">matchDeepLink</span></span></a></li><li><a class="level is-mobile" href="#总结-2"><span class="level-left"><span class="level-item">8.5</span><span class="level-item">总结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#NavigatorState"><span class="level-left"><span class="level-item">9</span><span class="level-item">NavigatorState</span></span></a></li><li><a class="level is-mobile" href="#NavControllerNavigatorState"><span class="level-left"><span class="level-item">10</span><span class="level-item">NavControllerNavigatorState</span></span></a></li><li><a class="level is-mobile" href="#NavControllerViewModel"><span class="level-left"><span class="level-item">11</span><span class="level-item">NavControllerViewModel</span></span></a></li><li><a class="level is-mobile" href="#FragmentNavigator"><span class="level-left"><span class="level-item">12</span><span class="level-item">FragmentNavigator</span></span></a></li><li><a class="level is-mobile" href="#ActivityNavigator"><span class="level-left"><span class="level-item">13</span><span class="level-item">ActivityNavigator</span></span></a></li><li><a class="level is-mobile" href="#总结中的总结"><span class="level-left"><span class="level-item">14</span><span class="level-item">总结中的总结</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#需要一个NavHostFragment"><span class="level-left"><span class="level-item">14.1</span><span class="level-item">需要一个NavHostFragment</span></span></a></li><li><a class="level is-mobile" href="#导航图-1"><span class="level-left"><span class="level-item">14.2</span><span class="level-item">导航图</span></span></a></li><li><a class="level is-mobile" href="#NavController-1"><span class="level-left"><span class="level-item">14.3</span><span class="level-item">NavController</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/home/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/home/">Meow!!</a><p class="is-size-7"><span>&copy; 2025 Meow Meow Liu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/home/js/column.js"></script><script src="/home/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/home/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/home/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/home/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/home/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/home/js/fairyDustCursor.js"></script><link rel="stylesheet" type="text/css" href="/home/css/textPopup.css"><script type="text/javascript" src="/home/js/textPopup.js"></script><script type="text/javascript" src="/home/js/clickClipBoard.js"></script><script type="module" src="/home/js/mermaidInitializer.js"></script><script src="/home/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/home/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true}});</script></body></html>