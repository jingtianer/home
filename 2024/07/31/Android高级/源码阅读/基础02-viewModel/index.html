<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>基础02-viewModel - Jingtianer</title><link rel="manifest" href="/home/manifest.json"><meta name="application-name" content="Jingtianer"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jingtianer"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="ViewModel简介在了解ViewModel之前，我们先来了解一下MVC, MVP, MVVM的发展Difference Between MVC, MVP and MVVM Architecture Pattern in Android ViewModelStoreOwner1234567interface ViewModelStoreOwner &amp;amp;#123;    &amp;#x2F;**     * The"><meta property="og:type" content="blog"><meta property="og:title" content="基础02-viewModel"><meta property="og:url" content="https://jingtianer.github.io/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8002-viewModel/"><meta property="og:site_name" content="Jingtianer"><meta property="og:description" content="ViewModel简介在了解ViewModel之前，我们先来了解一下MVC, MVP, MVVM的发展Difference Between MVC, MVP and MVVM Architecture Pattern in Android ViewModelStoreOwner1234567interface ViewModelStoreOwner &amp;amp;#123;    &amp;#x2F;**     * The"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://developer.android.com/static/images/topic/libraries/architecture/viewmodel-apis-cheatsheet.png?hl=zh-cn"><meta property="article:published_time" content="2024-07-31T13:15:36.000Z"><meta property="article:modified_time" content="2025-04-15T02:37:55.588Z"><meta property="article:author" content="Meow Meow Liu"><meta property="article:tag" content="Android-官方源码"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://developer.android.com/static/images/topic/libraries/architecture/viewmodel-apis-cheatsheet.png?hl=zh-cn"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jingtianer.github.io/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8002-viewModel/"},"headline":"基础02-viewModel","image":[],"datePublished":"2024-07-31T13:15:36.000Z","dateModified":"2025-04-15T02:37:55.588Z","author":{"@type":"Person","name":"Meow Meow Liu"},"publisher":{"@type":"Organization","name":"Jingtianer","logo":{"@type":"ImageObject","url":{"text":"Meow!!"}}},"description":"ViewModel简介在了解ViewModel之前，我们先来了解一下MVC, MVP, MVVM的发展Difference Between MVC, MVP and MVVM Architecture Pattern in Android ViewModelStoreOwner1234567interface ViewModelStoreOwner &amp;#123;    &#x2F;**     * The"}</script><link rel="canonical" href="https://jingtianer.github.io/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8002-viewModel/"><link rel="alternate" href="/home/atom.xml" title="Jingtianer" type="application/atom+xml"><link rel="icon" href="/home/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/vs.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/home/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/home/">Meow!!</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/home/">主页</a><a class="navbar-item" href="/home/archives">归档</a><a class="navbar-item" href="/home/categories">分类</a><a class="navbar-item" href="/home/tags">标签</a><a class="navbar-item" href="/home/about">关于我</a><a class="navbar-item" href="/home/tags/gallery">相册</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-07-31T13:15:36.000Z" title="2024/7/31 21:15:36">2024-07-31</time>发表</span><span class="level-item"><time dateTime="2025-04-15T02:37:55.588Z" title="2025/4/15 10:37:55">2025-04-15</time>更新</span><span class="level-item"><a class="link-muted" href="/home/categories/Android/">Android</a><span> / </span><a class="link-muted" href="/home/categories/Android/%E6%89%8B%E6%92%B8Android%E6%BA%90%E7%A0%81/">手撸Android源码</a></span><span class="level-item">21 分钟读完 (大约3102个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">基础02-viewModel</h1><div class="content"><h2 id="ViewModel简介"><a href="#ViewModel简介" class="headerlink" title="ViewModel简介"></a>ViewModel简介</h2><p>在了解ViewModel之前，我们先来了解一下MVC, MVP, MVVM的发展<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-mvc-mvp-and-mvvm-architecture-pattern-in-android/">Difference Between MVC, MVP and MVVM Architecture Pattern in Android</a></p>
<h2 id="ViewModelStoreOwner"><a href="#ViewModelStoreOwner" class="headerlink" title="ViewModelStoreOwner"></a><a target="_blank" rel="noopener" href="https://developer.android.com/reference/kotlin/androidx/lifecycle/ViewModelStoreOwner">ViewModelStoreOwner</a></h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ViewModelStoreOwner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The owned [ViewModelStore]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> viewModelStore: ViewModelStore</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现了<code>ViewModelStoreOwner</code>的类会有一个<code>viewModelStore</code>属性</li>
<li>在创建<code>ViewModel</code>时会传递这个变量，具体传递方式在见<a href="#by-viewmodels">by viewModels()</a></li>
<li>实现了<code>ViewModelStoreOwner</code>的直接子类有： <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/activity/ComponentActivity">ComponentActivity</a>, <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/fragment/app/Fragment">Fragment</a> 和 <a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/navigation/NavBackStackEntry">NavBackStackEntry</a></li>
</ul>
<h2 id="ViewModelStore"><a href="#ViewModelStore" class="headerlink" title="ViewModelStore"></a>ViewModelStore</h2><p>实际上就是维护了一个<code>MutableMap&lt;String, ViewModel&gt;</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">ViewModelStore</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> map = mutableMapOf&lt;String, ViewModel&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">put</span><span class="params">(key: <span class="type">String</span>, viewModel: <span class="type">ViewModel</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> oldViewModel = map.put(key, viewModel)</span><br><span class="line">        oldViewModel?.onCleared()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the `ViewModel` mapped to the given `key` or null if none exists.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(key: <span class="type">String</span>)</span></span>: ViewModel? &#123;</span><br><span class="line">        <span class="keyword">return</span> map[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">keys</span><span class="params">()</span></span>: Set&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> HashSet(map.keys)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Clears internal storage and notifies `ViewModel`s that they are no longer used.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (vm <span class="keyword">in</span> map.values) &#123;</span><br><span class="line">            vm.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        map.clear()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现就是在对map读写，注意到put方法会调用同key值的旧ViewModel的<code>onCleared</code></p>
<ul>
<li><code>onCleared</code>并不执行任何操作，是提供给子类进行回收资源的回调。<code>ViewModel</code>真正进行资源回收（调用<code>Closeable</code>的<code>close</code>方法）的函数是<code>clear</code>，put中并没有调用，这是一个很奇怪的问题，具体的原因在<a href="#a-viewmodelstoreput%E9%97%AE%E9%A2%98">下面</a>会解释</li>
<li>那么这个key是什么呢，<a href="#viewmodelprovider%E7%9A%84get%E6%96%B9%E6%B3%95">下面</a>再看吧</li>
</ul>
<h2 id="by-viewModels"><a href="#by-viewModels" class="headerlink" title="by viewModels()"></a><code>by viewModels()</code></h2><h3 id="ComponentActivity的viewModels"><a href="#ComponentActivity的viewModels" class="headerlink" title="ComponentActivity的viewModels()"></a><code>ComponentActivity</code>的<code>viewModels()</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> VM : ViewModel&gt;</span> ComponentActivity.<span class="title">viewModels</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> extrasProducer: (() -&gt; <span class="type">CreationExtras</span>)? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> factoryProducer: (() -&gt; <span class="type">Factory</span>)? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Lazy&lt;VM&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> factoryPromise = factoryProducer ?: &#123;</span><br><span class="line">        defaultViewModelProviderFactory</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ViewModelLazy(</span><br><span class="line">        VM::<span class="keyword">class</span>,</span><br><span class="line">        &#123; viewModelStore &#125;, <span class="comment">// 1️⃣ viewModelStore的传递在这里</span></span><br><span class="line">        factoryPromise, </span><br><span class="line">        &#123; extrasProducer?.invoke() ?: <span class="keyword">this</span>.defaultViewModelCreationExtras &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>viewModels()</code>实际上是<code>ComponentActivity</code>的一个扩展方法，返回了<code>ViewModelLazy</code>对<code>ViewModel</code>的属性进行代理</p>
<h2 id="ViewModelLazy"><a href="#ViewModelLazy" class="headerlink" title="ViewModelLazy"></a>ViewModelLazy</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ViewModelLazy</span>&lt;<span class="type">VM : ViewModel</span>&gt; <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModelClass: KClass&lt;VM&gt;,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> storeProducer: () -&gt; ViewModelStore,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> factoryProducer: () -&gt; ViewModelProvider.Factory,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> extrasProducer: () -&gt; CreationExtras = &#123; CreationExtras.Empty &#125;</span><br><span class="line">) : Lazy&lt;VM&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> cached: VM? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> value: VM</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">val</span> viewModel = cached</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">if</span> (viewModel == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">val</span> factory = factoryProducer()</span><br><span class="line">                <span class="keyword">val</span> store = storeProducer()</span><br><span class="line">                ViewModelProvider(</span><br><span class="line">                    store,</span><br><span class="line">                    factory,</span><br><span class="line">                    extrasProducer()</span><br><span class="line">                ).<span class="keyword">get</span>(viewModelClass.java).also &#123;</span><br><span class="line">                    cached = it</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                viewModel</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isInitialized</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> = cached != <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到当属性首次<code>get</code>时会构造<code>ViewModelProvider</code>并调用<code>get</code>方法获取<code>viewModel</code>对象</p>
<h2 id="ViewModelProvider"><a href="#ViewModelProvider" class="headerlink" title="ViewModelProvider"></a>ViewModelProvider</h2><h3 id="ViewModelProvider的get方法"><a href="#ViewModelProvider的get方法" class="headerlink" title="ViewModelProvider的get方法"></a><code>ViewModelProvider</code>的<code>get</code>方法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">get</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">    <span class="keyword">val</span> canonicalName = modelClass.canonicalName</span><br><span class="line">        ?: <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Local and anonymous classes can not be ViewModels&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">get</span>(<span class="string">&quot;<span class="variable">$DEFAULT_KEY</span>:<span class="variable">$canonicalName</span>&quot;</span>, modelClass)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">get</span><span class="params">(key: <span class="type">String</span>, modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">    <span class="keyword">val</span> viewModel = store[key] <span class="comment">// 1️⃣ 从store中取viewModel</span></span><br><span class="line">    <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123; <span class="comment">// 2️⃣ 判断合法性</span></span><br><span class="line">        (factory <span class="keyword">as</span>? OnRequeryFactory)?.onRequery(viewModel!!)</span><br><span class="line">        <span class="keyword">return</span> viewModel <span class="keyword">as</span> T</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="meta">@Suppress(<span class="string">&quot;ControlFlowWithEmptyBody&quot;</span>)</span></span><br><span class="line">        <span class="keyword">if</span> (viewModel != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> extras = MutableCreationExtras(defaultCreationExtras)</span><br><span class="line">    extras[VIEW_MODEL_KEY] = key</span><br><span class="line">    <span class="comment">// AGP has some desugaring issues associated with compileOnly dependencies so we need to</span></span><br><span class="line">    <span class="comment">// fall back to the other create method to keep from crashing.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">        factory.create(modelClass, extras) <span class="comment">// 3️⃣ 通过factory创建ViewModel</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: AbstractMethodError) &#123; <span class="comment">// 3️⃣ 通过factory创建ViewModel</span></span><br><span class="line">        factory.create(modelClass)</span><br><span class="line">    &#125;.also &#123; store.put(key, it) &#125; <span class="comment">// 4️⃣ 存入store</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>1️⃣ 从<code>store</code>中取<code>viewModel</code>，这个<code>store</code>就是上面提到的<a href="#viewmodelstore">ViewModelStore</a>, 这里可以看到其<code>key</code>就是类名</li>
<li>2️⃣ 判断合法性，<code>isInstance</code>函数首先判空，其次判断是否为对应的类型，这一步的判空是为了判断是否需要构造<code>ViewModel</code>实例，避免返回空；这一步的判断类型则是为了提高安全性，返回时强转不会强转失败</li>
<li>3️⃣ 通过<code>factory</code>创建，这一步显而易见，创建新的实例。这里的<code>factory</code>默认值是通过<code>ComponentActivity</code>构造的<code>SavedStateViewModelFactory</code></li>
<li>4️⃣ 存入<code>store</code>，在创建后存入<code>store</code>中</li>
</ul>
<h3 id="A-ViewModelStore-put-问题"><a href="#A-ViewModelStore-put-问题" class="headerlink" title="A: ViewModelStore.put()问题"></a>A: ViewModelStore.put()问题</h3><blockquote>
<p>这里可以推测，如果同一个<code>ViewModelStoreOwner</code>中声明了多个同类型的<code>ViewModel</code>，根据2️⃣的判断，他们会是同一个实例。<code>ViewModelStore.put</code>时一般不会存在同key值的<code>ViewModel</code>对象，所以那里是否调用<code>clear</code>进行资源回收也就不是很重要了。</p>
</blockquote>
<h2 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h2><p>ViewModel类实际上不是实际实现，持有<code>ViewModelImpl</code>的实例，对其方法进行代理</p>
<h3 id="类定义"><a href="#类定义" class="headerlink" title="类定义"></a>类定义</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">actual</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ViewModel</span></span><br></pre></td></tr></table></figure>

<p>几个注意的点：</p>
<ul>
<li>actual: 介绍看<a target="_blank" rel="noopener" href="https://www.baeldung.com/kotlin/actual-expect-keywords">这里</a>, 大概是和跨端相关的。</li>
<li>abstract</li>
</ul>
<h3 id="clear方法"><a href="#clear方法" class="headerlink" title="clear方法"></a>clear方法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">actual</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCleared</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">actual</span> <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">    impl?.clear()</span><br><span class="line">    onCleared()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里可以看到稍有不同的是，除了代理调用<code>ViewModelImpl</code>的<code>clear</code>方法，还调用了钩子方法<code>onCleared</code></li>
<li>另外很有趣的是<code>ViewModelImpl</code>和<code>ViewModel</code>并没有继承关系，也没有继承相同的接口</li>
</ul>
<h2 id="ViewModelImpl"><a href="#ViewModelImpl" class="headerlink" title="ViewModelImpl"></a>ViewModelImpl</h2><h3 id="关键的属性"><a href="#关键的属性" class="headerlink" title="关键的属性"></a>关键的属性</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> keyToCloseables = mutableMapOf&lt;String, AutoCloseable&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> [keyToCloseables]</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> closeables = mutableSetOf&lt;AutoCloseable&gt;()</span><br></pre></td></tr></table></figure>

<p>可以看到维护了一个map和一个set，保存<code>AutoCloseable</code></p>
<h3 id="addCloseable"><a href="#addCloseable" class="headerlink" title="addCloseable"></a>addCloseable</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">addCloseable</span><span class="params">(key: <span class="type">String</span>, closeable: <span class="type">AutoCloseable</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Although no logic should be done after user calls onCleared(), we will</span></span><br><span class="line">    <span class="comment">// ensure that if it has already been called, the closeable attempting to</span></span><br><span class="line">    <span class="comment">// be added will be closed immediately to ensure there will be no leaks.</span></span><br><span class="line">    <span class="keyword">if</span> (isCleared) &#123;</span><br><span class="line">        closeWithRuntimeException(closeable)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> oldCloseable = synchronized(lock) &#123; keyToCloseables.put(key, closeable) &#125;</span><br><span class="line">    closeWithRuntimeException(oldCloseable)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@see</span> [ViewModel.addCloseable] */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">addCloseable</span><span class="params">(closeable: <span class="type">AutoCloseable</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Although no logic should be done after user calls onCleared(), we will</span></span><br><span class="line">    <span class="comment">// ensure that if it has already been called, the closeable attempting to</span></span><br><span class="line">    <span class="comment">// be added will be closed immediately to ensure there will be no leaks.</span></span><br><span class="line">    <span class="keyword">if</span> (isCleared) &#123;</span><br><span class="line">        closeWithRuntimeException(closeable)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronized(lock) &#123; closeables += closeable &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到两个函数，一个是添加到map中，一个是添加到set中</li>
<li>如果当前ViewModel已经被clear了，那么会调用<code>closeWithRuntimeException</code>，这个方法会调用其close方法，并将close时出现的异常转换为<code>RuntimeException</code>抛出</li>
<li>如果map中有同key值的closeable，那么也会调用<code>closeWithRuntimeException</code>将其关闭</li>
<li>这两个函数也可以提供给用户使用</li>
</ul>
<h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">constructor</span>(viewModelScope: CoroutineScope) &#123;</span><br><span class="line">    addCloseable(VIEW_MODEL_SCOPE_KEY, viewModelScope.asCloseable())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constructor</span>(<span class="keyword">vararg</span> closeables: AutoCloseable) &#123;</span><br><span class="line">    <span class="keyword">this</span>.closeables += closeables</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constructor</span>(viewModelScope: CoroutineScope, <span class="keyword">vararg</span> closeables: AutoCloseable) &#123;</span><br><span class="line">    addCloseable(VIEW_MODEL_SCOPE_KEY, viewModelScope.asCloseable())</span><br><span class="line">    <span class="keyword">this</span>.closeables += closeables</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，只允许传递一个<code>CoroutineScope</code>，会将其转化为closeable，存到map中</li>
<li>看上去只允许传递一个<code>CoroutineScope</code>，但是还是可以通过相同的方法传递多个用<code>CloseableCoroutineScope</code>包装过的Scope对象</li>
<li>这个构造允许传递一个<code>CoroutineScope</code>完全是为了将其转化为Closeable对象，没有别的意义，感觉很多余。</li>
</ul>
<h3 id="clear"><a href="#clear" class="headerlink" title="clear"></a>clear</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCleared) <span class="keyword">return</span> <span class="comment">// 1️⃣</span></span><br><span class="line"></span><br><span class="line">    isCleared = <span class="literal">true</span> <span class="comment">// 2️⃣</span></span><br><span class="line">    synchronized(lock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (closeable <span class="keyword">in</span> keyToCloseables.values) &#123;</span><br><span class="line">            closeWithRuntimeException(closeable)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (closeable <span class="keyword">in</span> closeables) &#123;</span><br><span class="line">            closeWithRuntimeException(closeable)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Clear only resources without keys to prevent accidental recreation of resources.</span></span><br><span class="line">        <span class="comment">// For example, `viewModelScope` would be recreated leading to unexpected behaviour.</span></span><br><span class="line">        closeables.clear()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@MainThread</code>标明该方法应该被在主线程调用</li>
<li>方法其实就是把所有closeable关掉，再把set清空，但是map却没有清空？</li>
<li>可以看到1️⃣和2️⃣并不是原子的，如果clear被多个线程同时调用，有可能存在map里的closeable被close两次的情况。</li>
</ul>
<h2 id="SavedStateViewModelFactory"><a href="#SavedStateViewModelFactory" class="headerlink" title="SavedStateViewModelFactory"></a>SavedStateViewModelFactory</h2><h3 id="create方法"><a href="#create方法" class="headerlink" title="create方法"></a>create方法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">create</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;, extras: <span class="type">CreationExtras</span>)</span></span>: T &#123; <span class="comment">// 1️⃣</span></span><br><span class="line">    <span class="keyword">val</span> key = extras[ViewModelProvider.NewInstanceFactory.VIEW_MODEL_KEY]</span><br><span class="line">        ?: <span class="keyword">throw</span> IllegalStateException(</span><br><span class="line">            <span class="string">&quot;VIEW_MODEL_KEY must always be provided by ViewModelProvider&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (extras[SAVED_STATE_REGISTRY_OWNER_KEY] != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        extras[VIEW_MODEL_STORE_OWNER_KEY] != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> application = extras[ViewModelProvider.AndroidViewModelFactory.APPLICATION_KEY]</span><br><span class="line">        <span class="keyword">val</span> isAndroidViewModel = AndroidViewModel::<span class="keyword">class</span>.java.isAssignableFrom(modelClass)</span><br><span class="line">        <span class="keyword">val</span> <span class="keyword">constructor</span>: Constructor&lt;T&gt;? = <span class="keyword">if</span> (isAndroidViewModel &amp;&amp; application != <span class="literal">null</span>) &#123;</span><br><span class="line">            findMatchingConstructor(modelClass, ANDROID_VIEWMODEL_SIGNATURE)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            findMatchingConstructor(modelClass, VIEWMODEL_SIGNATURE)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// doesn&#x27;t need SavedStateHandle</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">constructor</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> factory.create(modelClass, extras)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> viewModel = <span class="keyword">if</span> (isAndroidViewModel &amp;&amp; application != <span class="literal">null</span>) &#123;</span><br><span class="line">            newInstance(modelClass, <span class="keyword">constructor</span>, application, extras.createSavedStateHandle())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            newInstance(modelClass, <span class="keyword">constructor</span>, extras.createSavedStateHandle())</span><br><span class="line">        &#125;</span><br><span class="line">        viewModel</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> viewModel = <span class="keyword">if</span> (lifecycle != <span class="literal">null</span>) &#123;</span><br><span class="line">            create(key, modelClass)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;SAVED_STATE_REGISTRY_OWNER_KEY and&quot;</span> +</span><br><span class="line">                <span class="string">&quot;VIEW_MODEL_STORE_OWNER_KEY must be provided in the creation extras to&quot;</span> +</span><br><span class="line">                <span class="string">&quot;successfully create a ViewModel.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        viewModel</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a new instance of the given `Class`.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key a key associated with the requested ViewModel</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> modelClass a `Class` whose instance is requested</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> a newly created ViewModel</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> UnsupportedOperationException if the there is no lifecycle</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">create</span><span class="params">(key: <span class="type">String</span>, modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123; <span class="comment">// 2️⃣</span></span><br><span class="line">    <span class="comment">// empty constructor was called.</span></span><br><span class="line">    <span class="keyword">val</span> lifecycle = lifecycle</span><br><span class="line">        ?: <span class="keyword">throw</span> UnsupportedOperationException(</span><br><span class="line">            <span class="string">&quot;SavedStateViewModelFactory constructed with empty constructor supports only &quot;</span> +</span><br><span class="line">                <span class="string">&quot;calls to create(modelClass: Class&lt;T&gt;, extras: CreationExtras).&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">val</span> isAndroidViewModel = AndroidViewModel::<span class="keyword">class</span>.java.isAssignableFrom(modelClass)</span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">constructor</span>: Constructor&lt;T&gt;? = <span class="keyword">if</span> (isAndroidViewModel &amp;&amp; application != <span class="literal">null</span>) &#123;</span><br><span class="line">        findMatchingConstructor(modelClass, ANDROID_VIEWMODEL_SIGNATURE)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        findMatchingConstructor(modelClass, VIEWMODEL_SIGNATURE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// doesn&#x27;t need SavedStateHandle</span></span><br><span class="line">    <span class="keyword">constructor</span></span><br><span class="line">        ?: <span class="comment">// If you are using a stateful constructor and no application is available, we</span></span><br><span class="line">        <span class="comment">// use an instance factory instead.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (application != <span class="literal">null</span>) factory.create(modelClass)</span><br><span class="line">        <span class="keyword">else</span> instance.create(modelClass)</span><br><span class="line">    <span class="keyword">val</span> controller = LegacySavedStateHandleController.create(</span><br><span class="line">        savedStateRegistry!!, lifecycle, key, defaultArgs</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> viewModel: T = <span class="keyword">if</span> (isAndroidViewModel &amp;&amp; application != <span class="literal">null</span>) &#123;</span><br><span class="line">        newInstance(modelClass, <span class="keyword">constructor</span>, application!!, controller.handle)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newInstance(modelClass, <span class="keyword">constructor</span>, controller.handle)</span><br><span class="line">    &#125;</span><br><span class="line">    viewModel.setTagIfAbsent(</span><br><span class="line">        AbstractSavedStateViewModelFactory.TAG_SAVED_STATE_HANDLE_CONTROLLER, controller</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> viewModel</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>1️⃣和2️⃣大体流程上都是获取构造函数，创建实例对象</li>
<li>区别在于<code>newInstance</code>的第四个参数不同，一个通过<code>extras</code>获取，一个通过<code>LegacySavedStateHandleController</code>获得，看起来很复杂，但是看一下这个<code>newInstance</code>的实现就会发现，第四个参数实际上就是构造函数的参数</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel?&gt;</span> <span class="title">newInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">constructor</span>: <span class="type">Constructor</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">vararg</span> params: <span class="type">Any</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: T &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">constructor</span>.newInstance(*params)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IllegalAccessException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;Failed to access <span class="variable">$modelClass</span>&quot;</span>, e)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: InstantiationException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;A <span class="variable">$modelClass</span> cannot be instantiated.&quot;</span>, e)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: InvocationTargetException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> RuntimeException(</span><br><span class="line">            <span class="string">&quot;An exception happened in constructor of <span class="variable">$modelClass</span>&quot;</span>, e.cause</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="viewModelStore何时被clear"><a href="#viewModelStore何时被clear" class="headerlink" title="viewModelStore何时被clear"></a>viewModelStore何时被clear</h2><p>在ComponentActivty的初始化时，会看到下面这段代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">lifecycle.addObserver(LifecycleEventObserver &#123; _, event -&gt;</span><br><span class="line">    <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">        <span class="comment">// Clear out the available context</span></span><br><span class="line">        contextAwareHelper.clearAvailableContext()</span><br><span class="line">        <span class="comment">// And clear the ViewModelStore</span></span><br><span class="line">        <span class="keyword">if</span> (!isChangingConfigurations) &#123;</span><br><span class="line">            viewModelStore.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        reportFullyDrawnExecutor.activityDestroyed()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如果Activity生命周期到了<code>ON_DESTROY</code>，且不是夜间模式改变等情况，就会将viewModel清空，做到了界面和数据分离。</p>
<h2 id="CoroutineScope是如何变成Closeable的"><a href="#CoroutineScope是如何变成Closeable的" class="headerlink" title="CoroutineScope是如何变成Closeable的"></a>CoroutineScope是如何变成Closeable的</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">asCloseable</span><span class="params">()</span></span> = CloseableCoroutineScope(coroutineScope = <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [CoroutineScope] that provides a method to [close] it, causing the rejection of any new tasks and</span></span><br><span class="line"><span class="comment"> * cleanup of all underlying resources associated with the scope.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">CloseableCoroutineScope</span>(</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> coroutineContext: CoroutineContext,</span><br><span class="line">) : AutoCloseable, CoroutineScope &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(coroutineScope: CoroutineScope) : <span class="keyword">this</span>(coroutineScope.coroutineContext)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">close</span><span class="params">()</span></span> = coroutineContext.cancel()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>CloseableCoroutineScope</code>实现了<code>AutoCloseable</code>, 在close方法中将协程cancel掉</p>
</blockquote>
<h2 id="CreationExtras"><a href="#CreationExtras" class="headerlink" title="CreationExtras"></a>CreationExtras</h2><p>在<a href="#create%E6%96%B9%E6%B3%95">SavedStateViewModelFactory的create方法</a>中，可以看到factory会拿到一个<code>CreationExtras</code><br>在<a href="#by-viewmodels">by viewModels()</a>时，会传递一个构造<code>CreationExtras</code>的函数，如果没提供，就使用默认<code>ComponentActivity</code>提供的<code>defaultViewModelCreationExtras</code></p>
<h3 id="默认的CreationExtras"><a href="#默认的CreationExtras" class="headerlink" title="默认的CreationExtras"></a>默认的<code>CreationExtras</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">val</span> defaultViewModelCreationExtras: CreationExtras</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * The extras of [getIntent] when this is first called will be used as</span></span><br><span class="line"><span class="comment">        * the defaults to any [androidx.lifecycle.SavedStateHandle] passed to a view model</span></span><br><span class="line"><span class="comment">        * created using this extra.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">val</span> extras = MutableCreationExtras()</span><br><span class="line">        <span class="keyword">if</span> (application != <span class="literal">null</span>) &#123;</span><br><span class="line">            extras[APPLICATION_KEY] = application</span><br><span class="line">        &#125;</span><br><span class="line">        extras[SAVED_STATE_REGISTRY_OWNER_KEY] = <span class="keyword">this</span></span><br><span class="line">        extras[VIEW_MODEL_STORE_OWNER_KEY] = <span class="keyword">this</span></span><br><span class="line">        <span class="keyword">val</span> intentExtras = intent?.extras</span><br><span class="line">        <span class="keyword">if</span> (intentExtras != <span class="literal">null</span>) &#123;</span><br><span class="line">            extras[DEFAULT_ARGS_KEY] = intentExtras</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> extras</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到里面存了当前的Application对象，还有两个this，还会将<code>intent.extra</code>放进去</p>
<blockquote>
<p>MutableCreationExtras其实也是维护了一个map</p>
</blockquote>
<h2 id="给ViewModel传参"><a href="#给ViewModel传参" class="headerlink" title="给ViewModel传参"></a>给ViewModel传参</h2><ul>
<li>前面提到我们可以指定<code>Factory</code>和<code>CreationExtras</code></li>
<li>可以自己编写<code>Factory</code>，从<code>CreationExtras</code>中获取参数，下面是示例代码<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MainViewModel</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> coroutineScope: CoroutineScope = CloseableCoroutineScope(), </span><br><span class="line">    param1: String, </span><br><span class="line">    param2: <span class="built_in">Int</span></span><br><span class="line">) : ViewModel(coroutineScope) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">create</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;, extras: <span class="type">CreationExtras</span>)</span></span>: T &#123;</span><br><span class="line">            <span class="keyword">val</span> param1 = extras[MY_PARAM_KEY1]!!</span><br><span class="line">            <span class="keyword">val</span> param2 = extras[MY_PARAM_KEY2]!!</span><br><span class="line">            <span class="keyword">return</span> MainViewModel(param1 = param1, param2 = param2) <span class="keyword">as</span> T</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> MY_PARAM_KEY1 = <span class="keyword">object</span> : CreationExtras.Key&lt;String&gt; &#123;&#125;</span><br><span class="line">        <span class="keyword">val</span> MY_PARAM_KEY2 = <span class="keyword">object</span> : CreationExtras.Key&lt;<span class="built_in">Int</span>&gt; &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModel : MainViewModel <span class="keyword">by</span> viewModels(&#123;</span><br><span class="line">        <span class="keyword">return</span><span class="symbol">@viewModels</span> MutableCreationExtras().apply &#123;</span><br><span class="line">            <span class="keyword">set</span>(MainViewModel.MY_PARAM_KEY1, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            <span class="keyword">set</span>(MainViewModel.MY_PARAM_KEY2, <span class="number">2</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)&#123;</span><br><span class="line">        <span class="keyword">return</span><span class="symbol">@viewModels</span> MainViewModel.Factory</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Fragment-viewModels"><a href="#Fragment-viewModels" class="headerlink" title="Fragment.viewModels"></a>Fragment.viewModels</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> VM : ViewModel&gt;</span> Fragment.<span class="title">viewModels</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> ownerProducer: () -&gt; <span class="type">ViewModelStoreOwner</span> = &#123; this &#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> extrasProducer: (() -&gt; <span class="type">CreationExtras</span>)? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> factoryProducer: (() -&gt; <span class="type">Factory</span>)? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Lazy&lt;VM&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> owner <span class="keyword">by</span> lazy(LazyThreadSafetyMode.NONE) &#123; ownerProducer() &#125;</span><br><span class="line">    <span class="keyword">return</span> createViewModelLazy(</span><br><span class="line">        VM::<span class="keyword">class</span>,</span><br><span class="line">        &#123; owner.viewModelStore &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            extrasProducer?.invoke()</span><br><span class="line">            ?: (owner <span class="keyword">as</span>? HasDefaultViewModelProviderFactory)?.defaultViewModelCreationExtras</span><br><span class="line">            ?: CreationExtras.Empty</span><br><span class="line">        &#125;,</span><br><span class="line">        factoryProducer ?: &#123;</span><br><span class="line">            (owner <span class="keyword">as</span>? HasDefaultViewModelProviderFactory)?.defaultViewModelProviderFactory</span><br><span class="line">                ?: defaultViewModelProviderFactory</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>支持创建&#x2F;获取其他<code>owner</code>的<code>ViewModel</code></li>
<li>和<code>ComponentActivity</code>一样，<code>createViewModelLazy</code>的返回的也是<code>ViewModelLazy</code>类</li>
</ul>
<h2 id="Fragment-activityViewModels"><a href="#Fragment-activityViewModels" class="headerlink" title="Fragment.activityViewModels"></a>Fragment.activityViewModels</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> VM : ViewModel&gt;</span> Fragment.<span class="title">activityViewModels</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> extrasProducer: (() -&gt; <span class="type">CreationExtras</span>)? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> factoryProducer: (() -&gt; <span class="type">Factory</span>)? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Lazy&lt;VM&gt; = createViewModelLazy(</span><br><span class="line">    VM::<span class="keyword">class</span>, &#123; requireActivity().viewModelStore &#125;,</span><br><span class="line">    &#123; extrasProducer?.invoke() ?: requireActivity().defaultViewModelCreationExtras &#125;,</span><br><span class="line">    factoryProducer ?: &#123; requireActivity().defaultViewModelProviderFactory &#125;</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>获取<code>activity</code>的<code>viewModelStore</code></li>
</ul>
<h2 id="获取父fragment的viewModel"><a href="#获取父fragment的viewModel" class="headerlink" title="获取父fragment的viewModel"></a>获取父fragment的viewModel</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> parentFragmentViewModel:XXXViewModel <span class="keyword">by</span> viewModels(ownerProducer = &#123; requireParentFragment() &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="navigation图的viewModel"><a href="#navigation图的viewModel" class="headerlink" title="navigation图的viewModel"></a>navigation图的viewModel</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> naviViewModel : MainViewModel <span class="keyword">by</span> navGraphViewModels(R.id.xxx)</span><br><span class="line"><span class="keyword">val</span> naviViewModel1 : MainViewModel <span class="keyword">by</span> viewModels(ownerProducer = &#123; findNavController().getBackStackEntry(R.id.xxx) &#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> VM : ViewModel&gt;</span> Fragment.<span class="title">navGraphViewModels</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@IdRes</span> navGraphId: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> extrasProducer: (() -&gt; <span class="type">CreationExtras</span>)? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">noinline</span> factoryProducer: (() -&gt; <span class="type">ViewModelProvider</span>.<span class="type">Factory</span>)? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: Lazy&lt;VM&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> backStackEntry <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        findNavController().getBackStackEntry(navGraphId)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> storeProducer: () -&gt; ViewModelStore = &#123;</span><br><span class="line">        backStackEntry.viewModelStore</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createViewModelLazy(</span><br><span class="line">        VM::<span class="keyword">class</span>, storeProducer,</span><br><span class="line">        &#123; extrasProducer?.invoke() ?: backStackEntry.defaultViewModelCreationExtras &#125;,</span><br><span class="line">        factoryProducer ?: &#123; backStackEntry.defaultViewModelProviderFactory &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>navGraphViewModels其实就是调用了<code>findNavController().getBackStackEntry(navGraphId)</code>，然后获取其<code>viewModelStore</code></li>
</ul>
<h2 id="非lazy获取的viewModel"><a href="#非lazy获取的viewModel" class="headerlink" title="非lazy获取的viewModel"></a>非lazy获取的viewModel</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewModel = ViewModelProvider(<span class="keyword">this</span>.viewModelStore, ViewModelProvider.NewInstanceFactory.instance)[MainViewModel::<span class="keyword">class</span>.java]</span><br><span class="line"><span class="keyword">val</span> viewModel = ViewModelProvider(<span class="keyword">this</span>.viewModelStore, MainViewModel.Factory, MutableCreationExtras().apply &#123;</span><br><span class="line">    <span class="keyword">set</span>(MainViewModel.MY_PARAM_KEY1, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">set</span>(MainViewModel.MY_PARAM_KEY2, <span class="number">2</span>)</span><br><span class="line">&#125;)[MainViewModel::<span class="keyword">class</span>.java]</span><br></pre></td></tr></table></figure>

<h2 id="Compose获取viewModel"><a href="#Compose获取viewModel" class="headerlink" title="Compose获取viewModel"></a>Compose获取viewModel</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">Greeting</span><span class="params">(string: <span class="type">String</span>, modifier: <span class="type">Modifier</span> = Modifier, vm : <span class="type">MainViewModel</span> = viewModel()</span></span>) &#123;</span><br><span class="line">    Text(</span><br><span class="line">        text = string,</span><br><span class="line">        modifier = modifier</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> VM : ViewModel&gt;</span> <span class="title">viewModel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    viewModelStoreOwner: <span class="type">ViewModelStoreOwner</span> = checkNotNull(LocalViewModelStoreOwner.current)</span></span> &#123;</span><br><span class="line">        <span class="string">&quot;No ViewModelStoreOwner was provided via LocalViewModelStoreOwner&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    key: String? = <span class="literal">null</span>,</span><br><span class="line">    factory: ViewModelProvider.Factory? = <span class="literal">null</span>,</span><br><span class="line">    extras: CreationExtras = <span class="keyword">if</span> (viewModelStoreOwner <span class="keyword">is</span> HasDefaultViewModelProviderFactory) &#123;</span><br><span class="line">        viewModelStoreOwner.defaultViewModelCreationExtras</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CreationExtras.Empty</span><br><span class="line">    &#125;</span><br><span class="line">): VM = viewModel(VM::<span class="keyword">class</span>, viewModelStoreOwner, key, factory, extras)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;MissingJvmstatic&quot;</span>)</span></span><br><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;VM : ViewModel&gt;</span> <span class="title">viewModel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modelClass: <span class="type">KClass</span>&lt;<span class="type">VM</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    viewModelStoreOwner: <span class="type">ViewModelStoreOwner</span> = checkNotNull(LocalViewModelStoreOwner.current)</span></span> &#123;</span><br><span class="line">        <span class="string">&quot;No ViewModelStoreOwner was provided via LocalViewModelStoreOwner&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    key: String? = <span class="literal">null</span>,</span><br><span class="line">    factory: ViewModelProvider.Factory? = <span class="literal">null</span>,</span><br><span class="line">    extras: CreationExtras = <span class="keyword">if</span> (viewModelStoreOwner <span class="keyword">is</span> HasDefaultViewModelProviderFactory) &#123;</span><br><span class="line">        viewModelStoreOwner.defaultViewModelCreationExtras</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CreationExtras.Empty</span><br><span class="line">    &#125;</span><br><span class="line">): VM = viewModelStoreOwner.<span class="keyword">get</span>(modelClass, key, factory, extras)</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;VM : ViewModel&gt;</span> ViewModelStoreOwner.<span class="title">get</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    modelClass: <span class="type">KClass</span>&lt;<span class="type">VM</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    key: <span class="type">String</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    factory: <span class="type">ViewModelProvider</span>.<span class="type">Factory</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    extras: <span class="type">CreationExtras</span> = <span class="keyword">if</span> (this <span class="keyword">is</span> HasDefaultViewModelProviderFactory)</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultViewModelCreationExtras</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CreationExtras.Empty</span><br><span class="line">    &#125;</span><br><span class="line">): VM &#123;</span><br><span class="line">    <span class="keyword">val</span> provider = <span class="keyword">if</span> (factory != <span class="literal">null</span>) &#123;</span><br><span class="line">        ViewModelProvider.create(<span class="keyword">this</span>.viewModelStore, factory, extras)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> HasDefaultViewModelProviderFactory) &#123;</span><br><span class="line">        ViewModelProvider.create(<span class="keyword">this</span>.viewModelStore, <span class="keyword">this</span>.defaultViewModelProviderFactory, extras)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ViewModelProvider.create(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (key != <span class="literal">null</span>) &#123;</span><br><span class="line">        provider[key, modelClass]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        provider[modelClass]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">HasDefaultViewModelProviderFactory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the default [ViewModelProvider.Factory] that should be</span></span><br><span class="line"><span class="comment">     * used when no custom `Factory` is provided to the</span></span><br><span class="line"><span class="comment">     * [ViewModelProvider] constructors.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> defaultViewModelProviderFactory: ViewModelProvider.Factory</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the default [CreationExtras] that should be passed into</span></span><br><span class="line"><span class="comment">     * [ViewModelProvider.Factory.create] when no overriding</span></span><br><span class="line"><span class="comment">     * [CreationExtras] were passed to the [ViewModelProvider] constructors.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">val</span> defaultViewModelCreationExtras: CreationExtras</span><br><span class="line">        <span class="keyword">get</span>() = CreationExtras.Empty</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>store</code>来自<code>LocalViewModelStoreOwner.current</code></li>
<li>factory和extras来自<code>HasDefaultViewModelProviderFactory</code></li>
</ul>
<h2 id="备忘单"><a href="#备忘单" class="headerlink" title="备忘单"></a>备忘单</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/architecture/viewmodel/viewmodel-cheatsheet?hl=zh-cn"><img src="https://developer.android.com/static/images/topic/libraries/architecture/viewmodel-apis-cheatsheet.png?hl=zh-cn"></a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>基础02-viewModel</p><p><a href="https://jingtianer.github.io/home/2024/07/31/Android高级/源码阅读/基础02-viewModel/">https://jingtianer.github.io/home/2024/07/31/Android高级/源码阅读/基础02-viewModel/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Meow Meow Liu</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-07-31</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-04-15</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/home/tags/Android-%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81/">Android-官方源码</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8003-Lifecycle/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">基础03-Lifecycle</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/home/2024/07/13/misc/MIUISupermarket%E7%A7%BB%E6%A4%8D/"><span class="level-item">MIUISupermarket移植</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "5c40211a5c019eb94e3ff15eb2543a30",
            repo: "blog_comment",
            owner: "jingtianer",
            clientID: "f0b13fe8021fcd2efe50",
            clientSecret: "35207c14b34e77c48a3aeee1e94c9da169ffe0c2",
            admin: ["jingtianer"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#ViewModel简介"><span class="level-left"><span class="level-item">1</span><span class="level-item">ViewModel简介</span></span></a></li><li><a class="level is-mobile" href="#ViewModelStoreOwner"><span class="level-left"><span class="level-item">2</span><span class="level-item">ViewModelStoreOwner</span></span></a></li><li><a class="level is-mobile" href="#ViewModelStore"><span class="level-left"><span class="level-item">3</span><span class="level-item">ViewModelStore</span></span></a></li><li><a class="level is-mobile" href="#by-viewModels"><span class="level-left"><span class="level-item">4</span><span class="level-item">by viewModels()</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ComponentActivity的viewModels"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">ComponentActivity的viewModels()</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ViewModelLazy"><span class="level-left"><span class="level-item">5</span><span class="level-item">ViewModelLazy</span></span></a></li><li><a class="level is-mobile" href="#ViewModelProvider"><span class="level-left"><span class="level-item">6</span><span class="level-item">ViewModelProvider</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ViewModelProvider的get方法"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">ViewModelProvider的get方法</span></span></a></li><li><a class="level is-mobile" href="#A-ViewModelStore-put-问题"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">A: ViewModelStore.put()问题</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ViewModel"><span class="level-left"><span class="level-item">7</span><span class="level-item">ViewModel</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#类定义"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">类定义</span></span></a></li><li><a class="level is-mobile" href="#clear方法"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">clear方法</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ViewModelImpl"><span class="level-left"><span class="level-item">8</span><span class="level-item">ViewModelImpl</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#关键的属性"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">关键的属性</span></span></a></li><li><a class="level is-mobile" href="#addCloseable"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">addCloseable</span></span></a></li><li><a class="level is-mobile" href="#构造方法"><span class="level-left"><span class="level-item">8.3</span><span class="level-item">构造方法</span></span></a></li><li><a class="level is-mobile" href="#clear"><span class="level-left"><span class="level-item">8.4</span><span class="level-item">clear</span></span></a></li></ul></li><li><a class="level is-mobile" href="#SavedStateViewModelFactory"><span class="level-left"><span class="level-item">9</span><span class="level-item">SavedStateViewModelFactory</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#create方法"><span class="level-left"><span class="level-item">9.1</span><span class="level-item">create方法</span></span></a></li></ul></li><li><a class="level is-mobile" href="#viewModelStore何时被clear"><span class="level-left"><span class="level-item">10</span><span class="level-item">viewModelStore何时被clear</span></span></a></li><li><a class="level is-mobile" href="#CoroutineScope是如何变成Closeable的"><span class="level-left"><span class="level-item">11</span><span class="level-item">CoroutineScope是如何变成Closeable的</span></span></a></li><li><a class="level is-mobile" href="#CreationExtras"><span class="level-left"><span class="level-item">12</span><span class="level-item">CreationExtras</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#默认的CreationExtras"><span class="level-left"><span class="level-item">12.1</span><span class="level-item">默认的CreationExtras</span></span></a></li></ul></li><li><a class="level is-mobile" href="#给ViewModel传参"><span class="level-left"><span class="level-item">13</span><span class="level-item">给ViewModel传参</span></span></a></li><li><a class="level is-mobile" href="#Fragment-viewModels"><span class="level-left"><span class="level-item">14</span><span class="level-item">Fragment.viewModels</span></span></a></li><li><a class="level is-mobile" href="#Fragment-activityViewModels"><span class="level-left"><span class="level-item">15</span><span class="level-item">Fragment.activityViewModels</span></span></a></li><li><a class="level is-mobile" href="#获取父fragment的viewModel"><span class="level-left"><span class="level-item">16</span><span class="level-item">获取父fragment的viewModel</span></span></a></li><li><a class="level is-mobile" href="#navigation图的viewModel"><span class="level-left"><span class="level-item">17</span><span class="level-item">navigation图的viewModel</span></span></a></li><li><a class="level is-mobile" href="#非lazy获取的viewModel"><span class="level-left"><span class="level-item">18</span><span class="level-item">非lazy获取的viewModel</span></span></a></li><li><a class="level is-mobile" href="#Compose获取viewModel"><span class="level-left"><span class="level-item">19</span><span class="level-item">Compose获取viewModel</span></span></a></li><li><a class="level is-mobile" href="#备忘单"><span class="level-left"><span class="level-item">20</span><span class="level-item">备忘单</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/home/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/home/">Meow!!</a><p class="is-size-7"><span>&copy; 2025 Meow Meow Liu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/home/js/column.js"></script><script src="/home/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/home/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/home/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/home/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/home/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/home/js/fairyDustCursor.js"></script><link rel="stylesheet" type="text/css" href="/home/css/textPopup.css"><script type="text/javascript" src="/home/js/textPopup.js"></script><script type="text/javascript" src="/home/js/clickClipBoard.js"></script><script type="module" src="/home/js/mermaidInitializer.js"></script><script src="/home/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/home/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true}});</script></body></html>