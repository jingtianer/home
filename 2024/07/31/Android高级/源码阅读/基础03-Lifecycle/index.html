<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>基础03-Lifecycle - Jingtianer</title><link rel="manifest" href="/home/manifest.json"><meta name="application-name" content="Jingtianer"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jingtianer"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="lifeCycle的Observer123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public interface LifecycleObserverp"><meta property="og:type" content="blog"><meta property="og:title" content="基础03-Lifecycle"><meta property="og:url" content="https://jingtianer.github.io/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8003-Lifecycle/"><meta property="og:site_name" content="Jingtianer"><meta property="og:description" content="lifeCycle的Observer123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public interface LifecycleObserverp"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://jingtianer.github.io/home/img/og_image.png"><meta property="article:published_time" content="2024-07-31T13:15:36.000Z"><meta property="article:modified_time" content="2025-04-15T02:37:55.588Z"><meta property="article:author" content="Meow Meow Liu"><meta property="article:tag" content="Android-官方源码"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://jingtianer.github.io/home/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://jingtianer.github.io/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8003-Lifecycle/"},"headline":"基础03-Lifecycle","image":["https://jingtianer.github.io/home/img/og_image.png"],"datePublished":"2024-07-31T13:15:36.000Z","dateModified":"2025-04-15T02:37:55.588Z","author":{"@type":"Person","name":"Meow Meow Liu"},"publisher":{"@type":"Organization","name":"Jingtianer","logo":{"@type":"ImageObject","url":{"text":"Meow!!"}}},"description":"lifeCycle的Observer123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public interface LifecycleObserverp"}</script><link rel="canonical" href="https://jingtianer.github.io/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8003-Lifecycle/"><link rel="alternate" href="/home/atom.xml" title="Jingtianer" type="application/atom+xml"><link rel="icon" href="/home/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/vs.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/home/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/home/">Meow!!</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/home/">主页</a><a class="navbar-item" href="/home/archives">归档</a><a class="navbar-item" href="/home/categories">分类</a><a class="navbar-item" href="/home/tags">标签</a><a class="navbar-item" href="/home/about">关于我</a><a class="navbar-item" href="/home/tags/gallery">相册</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-07-31T13:15:36.000Z" title="2024/7/31 21:15:36">2024-07-31</time>发表</span><span class="level-item"><time dateTime="2025-04-15T02:37:55.588Z" title="2025/4/15 10:37:55">2025-04-15</time>更新</span><span class="level-item"><a class="link-muted" href="/home/categories/Android/">Android</a><span> / </span><a class="link-muted" href="/home/categories/Android/%E6%89%8B%E6%92%B8Android%E6%BA%90%E7%A0%81/">手撸Android源码</a></span><span class="level-item">18 分钟读完 (大约2687个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">基础03-Lifecycle</h1><div class="content"><h2 id="lifeCycle的Observer"><a href="#lifeCycle的Observer" class="headerlink" title="lifeCycle的Observer"></a>lifeCycle的Observer</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LifecycleObserver</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DefaultLifecycleObserver</span> : <span class="type">LifecycleObserver</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies that `ON_CREATE` event occurred.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method will be called after the [LifecycleOwner]&#x27;s `onCreate`</span></span><br><span class="line"><span class="comment">     * method returns.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner the component, whose state was changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies that `ON_START` event occurred.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method will be called after the [LifecycleOwner]&#x27;s `onStart` method returns.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner the component, whose state was changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStart</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies that `ON_RESUME` event occurred.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method will be called after the [LifecycleOwner]&#x27;s `onResume`</span></span><br><span class="line"><span class="comment">     * method returns.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner the component, whose state was changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies that `ON_PAUSE` event occurred.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method will be called before the [LifecycleOwner]&#x27;s `onPause` method</span></span><br><span class="line"><span class="comment">     * is called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner the component, whose state was changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies that `ON_STOP` event occurred.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method will be called before the [LifecycleOwner]&#x27;s `onStop` method</span></span><br><span class="line"><span class="comment">     * is called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner the component, whose state was changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStop</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies that `ON_DESTROY` event occurred.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This method will be called before the [LifecycleOwner]&#x27;s `onDestroy` method</span></span><br><span class="line"><span class="comment">     * is called.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> owner the component, whose state was changed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">(owner: <span class="type">LifecycleOwner</span>)</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> LifecycleEventObserver : LifecycleObserver &#123;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when a state transition event happens.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source The source of the event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event The event</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStateChanged</span><span class="params">(source: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，我们在使用<code>lifecycle.addObserver()</code>时，可以传入<code>LifecycleEventObserver</code>或<code>DefaultLifecycleObserver</code>，一个通过<code>event</code>获取当前状态，一个通过不同的回调函数获取当前状态</li>
</ul>
<h2 id="Activity树"><a href="#Activity树" class="headerlink" title="Activity树"></a>Activity树</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Activity -- AccountAuthenticatorActivity</span><br><span class="line">         |- ActivityGroup -- TabActivity</span><br><span class="line">         |- ExpandableListActivity</span><br><span class="line">         |- LauncherActivity</span><br><span class="line">         |- ListActivity -- PreferenceActivity</span><br><span class="line">         |- NativeActivity</span><br><span class="line">         |- androidx.core.app.ComponentActivity -- androidx.activity.ComponentActivity -- FragmentActivity -- AppCompatActivity</span><br><span class="line">                                                |- PreviewActivity</span><br><span class="line">         |- BootstrapActivity</span><br><span class="line">         |- EmptyActivity</span><br><span class="line">         |- EmptyFloatingActivity</span><br></pre></td></tr></table></figure>

<h2 id="LifecycleOwner"><a href="#LifecycleOwner" class="headerlink" title="LifecycleOwner"></a>LifecycleOwner</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LifecycleOwner</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the Lifecycle of the provider.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The lifecycle of the provider.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> lifecycle: Lifecycle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>androidx.core.app.ComponentActivity</code>和<code>androidx.activity.ComponentActivity</code>都声明了对<code>LifecycleOwner</code>的实现</p>
<p>可以拿到<code>lifecycle</code>的<code>Activity</code>有</p>
<ul>
<li>androidx.core.app.ComponentActivity</li>
<li>androidx.activity.ComponentActivity</li>
<li>FragmentActivity</li>
<li>AppCompatActivity</li>
<li>PreviewActivity</li>
</ul>
<h2 id="androidx-core-app-ComponentActivity中的lifecycle"><a href="#androidx-core-app-ComponentActivity中的lifecycle" class="headerlink" title="androidx.core.app.ComponentActivity中的lifecycle"></a>androidx.core.app.ComponentActivity中的lifecycle</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;LeakingThis&quot;</span>)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> lifecycleRegistry = LifecycleRegistry(<span class="keyword">this</span>)</span><br><span class="line"><span class="keyword">override</span> <span class="keyword">val</span> lifecycle: Lifecycle</span><br><span class="line">    <span class="keyword">get</span>() = lifecycleRegistry</span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSaveInstanceState</span><span class="params">(outState: <span class="type">Bundle</span>)</span></span> &#123;</span><br><span class="line">    lifecycleRegistry.currentState = Lifecycle.State.CREATED</span><br><span class="line">    <span class="keyword">super</span>.onSaveInstanceState(outState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>很意外的是<code>ComponentActivity</code>并不是在每个生命周期回调函数中调用<code>lifecycleRegistry</code>的<code>setCurrentState</code>，从而分发生命周期</li>
</ul>
<h2 id="LifecycleRegistry"><a href="#LifecycleRegistry" class="headerlink" title="LifecycleRegistry"></a>LifecycleRegistry</h2><h3 id="addObserver"><a href="#addObserver" class="headerlink" title="addObserver"></a>addObserver</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">addObserver</span><span class="params">(observer: <span class="type">LifecycleObserver</span>)</span></span> &#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;addObserver&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> initialState = <span class="keyword">if</span> (state == State.DESTROYED) State.DESTROYED <span class="keyword">else</span> State.INITIALIZED</span><br><span class="line">    <span class="keyword">val</span> statefulObserver = ObserverWithState(observer, initialState)</span><br><span class="line">    <span class="keyword">val</span> previous = observerMap.putIfAbsent(observer, statefulObserver)</span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> lifecycleOwner = lifecycleOwner.<span class="keyword">get</span>()</span><br><span class="line">        ?: <span class="comment">// it is null we should be destroyed. Fallback quickly</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">val</span> isReentrance = addingObserverCounter != <span class="number">0</span> || handlingEvent</span><br><span class="line">    <span class="keyword">var</span> targetState = calculateTargetState(observer)</span><br><span class="line">    addingObserverCounter++</span><br><span class="line">    <span class="keyword">while</span> (statefulObserver.state &lt; targetState &amp;&amp; observerMap.contains(observer)</span><br><span class="line">    ) &#123;</span><br><span class="line">        pushParentState(statefulObserver.state)</span><br><span class="line">        <span class="keyword">val</span> event = Event.upFrom(statefulObserver.state)</span><br><span class="line">            ?: <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;no event up from <span class="subst">$&#123;statefulObserver.state&#125;</span>&quot;</span>)</span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, event)</span><br><span class="line">        popParentState()</span><br><span class="line">        <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">        targetState = calculateTargetState(observer)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        sync()</span><br><span class="line">    &#125;</span><br><span class="line">    addingObserverCounter--</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里看到<code>addObserver</code>首先将observer包装成<code>ObserverWithState</code>，并将其加入到<code>observerMap</code></li>
<li>加入后立刻调用<code>dispatchEvent</code>将最新的状态传递出去</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sync</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> lifecycleOwner = lifecycleOwner.<span class="keyword">get</span>()</span><br><span class="line">        ?: <span class="keyword">throw</span> IllegalStateException(</span><br><span class="line">            <span class="string">&quot;LifecycleOwner of this LifecycleRegistry is already &quot;</span> +</span><br><span class="line">                <span class="string">&quot;garbage collected. It is too late to change lifecycle state.&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">while</span> (!isSynced) &#123;</span><br><span class="line">        newEventOccurred = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> (state &lt; observerMap.eldest()!!.value.state) &#123;</span><br><span class="line">            backwardPass(lifecycleOwner)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> newest = observerMap.newest()</span><br><span class="line">        <span class="keyword">if</span> (!newEventOccurred &amp;&amp; newest != <span class="literal">null</span> &amp;&amp; state &gt; newest.value.state) &#123;</span><br><span class="line">            forwardPass(lifecycleOwner)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    newEventOccurred = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里看到<code>sync</code>会调用<code>backwardPass</code>和<code>forwardPass</code></li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">forwardPass</span><span class="params">(lifecycleOwner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">    <span class="meta">@Suppress()</span></span><br><span class="line">    <span class="keyword">val</span> ascendingIterator: Iterator&lt;Map.Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; =</span><br><span class="line">        observerMap.iteratorWithAdditions()</span><br><span class="line">    <span class="keyword">while</span> (ascendingIterator.hasNext() &amp;&amp; !newEventOccurred) &#123;</span><br><span class="line">        <span class="keyword">val</span> (key, observer) = ascendingIterator.next()</span><br><span class="line">        <span class="keyword">while</span> (observer.state &lt; state &amp;&amp; !newEventOccurred &amp;&amp; observerMap.contains(key)</span><br><span class="line">        ) &#123;</span><br><span class="line">            pushParentState(observer.state)</span><br><span class="line">            <span class="keyword">val</span> event = Event.upFrom(observer.state)</span><br><span class="line">                ?: <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;no event up from <span class="subst">$&#123;observer.state&#125;</span>&quot;</span>)</span><br><span class="line">            observer.dispatchEvent(lifecycleOwner, event)</span><br><span class="line">            popParentState()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">backwardPass</span><span class="params">(lifecycleOwner: <span class="type">LifecycleOwner</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> descendingIterator = observerMap.descendingIterator()</span><br><span class="line">    <span class="keyword">while</span> (descendingIterator.hasNext() &amp;&amp; !newEventOccurred) &#123;</span><br><span class="line">        <span class="keyword">val</span> (key, observer) = descendingIterator.next()</span><br><span class="line">        <span class="keyword">while</span> (observer.state &gt; state &amp;&amp; !newEventOccurred &amp;&amp; observerMap.contains(key)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">val</span> event = Event.downFrom(observer.state)</span><br><span class="line">                ?: <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;no event down from <span class="subst">$&#123;observer.state&#125;</span>&quot;</span>)</span><br><span class="line">            pushParentState(event.targetState)</span><br><span class="line">            observer.dispatchEvent(lifecycleOwner, event)</span><br><span class="line">            popParentState()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里看到<code>sync</code>被调用后，就会根据<code>observer</code>的情况和<code>state</code>的不同，按照需要将<code>state</code>的变化传递给<code>observer</code></li>
</ul>
<h3 id="ObserverWithState"><a href="#ObserverWithState" class="headerlink" title="ObserverWithState"></a>ObserverWithState</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">ObserverWithState</span>(observer: LifecycleObserver?, initialState: State) &#123;</span><br><span class="line">    <span class="keyword">var</span> state: State</span><br><span class="line">    <span class="keyword">var</span> lifecycleObserver: LifecycleEventObserver</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        lifecycleObserver = Lifecycling.lifecycleEventObserver(observer!!)</span><br><span class="line">        state = initialState</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dispatchEvent</span><span class="params">(owner: <span class="type">LifecycleOwner</span>?, event: <span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> newState = event.targetState</span><br><span class="line">        state = min(state, newState)</span><br><span class="line">        lifecycleObserver.onStateChanged(owner!!, event)</span><br><span class="line">        state = newState</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>首先这里看到一个关键的函数调用<code>onStateChanged</code>，也就是当<code>dispatchEvent</code>被调用时，<code>state</code>的改变就会传递给<code>observer</code></li>
</ul>
<h3 id="setCurrentState作用"><a href="#setCurrentState作用" class="headerlink" title="setCurrentState作用"></a>setCurrentState作用</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> currentState: State</span><br><span class="line">    <span class="keyword">get</span>() = state</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Moves the Lifecycle to the given state and dispatches necessary events to the observers.</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> state new state</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">set</span>(state) &#123;</span><br><span class="line">        enforceMainThreadIfNeeded(<span class="string">&quot;setCurrentState&quot;</span>)</span><br><span class="line">        moveToState(state)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">moveToState</span><span class="params">(next: <span class="type">State</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state == next) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    check(!(state == State.INITIALIZED &amp;&amp; next == State.DESTROYED)) &#123;</span><br><span class="line">        <span class="string">&quot;no event down from <span class="variable">$state</span> in component <span class="subst">$&#123;lifecycleOwner.get()&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    state = next</span><br><span class="line">    <span class="keyword">if</span> (handlingEvent || addingObserverCounter != <span class="number">0</span>) &#123;</span><br><span class="line">        newEventOccurred = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// we will figure out what to do on upper level.</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    handlingEvent = <span class="literal">true</span></span><br><span class="line">    sync()</span><br><span class="line">    handlingEvent = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (state == State.DESTROYED) &#123;</span><br><span class="line">        observerMap = FastSafeIterableMap()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到这里对<code>state</code>进行一定逻辑判断后，调用了<code>sync</code>，也就是当前<code>state</code>的改变会传递给<code>observer</code></li>
<li><code>activity</code>传递<code>state</code>的方式看起来还是通过<code>setCurrentState</code>，但是并没有在<code>CompinentActivity</code>中的各个生命周期函数中调用</li>
</ul>
<h3 id="ObserverWithState如何处理两种LifecycleObserver"><a href="#ObserverWithState如何处理两种LifecycleObserver" class="headerlink" title="ObserverWithState如何处理两种LifecycleObserver"></a>ObserverWithState如何处理两种LifecycleObserver</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span> &#123;</span><br><span class="line">    lifecycleObserver = Lifecycling.lifecycleEventObserver(observer!!)</span><br><span class="line">    state = initialState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到构造函数中将<code>observer</code>通过<code>Lifecycling.lifecycleEventObserver</code>对<code>observer</code>进行了包装</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">lifecycleEventObserver</span><span class="params">(`<span class="keyword">object</span>`: <span class="type">Any</span>)</span></span>: LifecycleEventObserver &#123;</span><br><span class="line">    <span class="keyword">val</span> isLifecycleEventObserver = `<span class="keyword">object</span>` <span class="keyword">is</span> LifecycleEventObserver</span><br><span class="line">    <span class="keyword">val</span> isDefaultLifecycleObserver = `<span class="keyword">object</span>` <span class="keyword">is</span> DefaultLifecycleObserver</span><br><span class="line">    <span class="keyword">if</span> (isLifecycleEventObserver &amp;&amp; isDefaultLifecycleObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> DefaultLifecycleObserverAdapter(</span><br><span class="line">            `<span class="keyword">object</span>` <span class="keyword">as</span> DefaultLifecycleObserver,</span><br><span class="line">            `<span class="keyword">object</span>` <span class="keyword">as</span> LifecycleEventObserver</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isDefaultLifecycleObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> DefaultLifecycleObserverAdapter(`<span class="keyword">object</span>` <span class="keyword">as</span> DefaultLifecycleObserver, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isLifecycleEventObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> `<span class="keyword">object</span>` <span class="keyword">as</span> LifecycleEventObserver</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> klass: Class&lt;*&gt; = `<span class="keyword">object</span>`.javaClass</span><br><span class="line">    <span class="keyword">val</span> type = getObserverConstructorType(klass)</span><br><span class="line">    <span class="keyword">if</span> (type == GENERATED_CALLBACK) &#123;</span><br><span class="line">        <span class="keyword">val</span> constructors = classToAdapters[klass]!!</span><br><span class="line">        <span class="keyword">if</span> (constructors.size == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> generatedAdapter = createGeneratedAdapter(</span><br><span class="line">                constructors[<span class="number">0</span>], `<span class="keyword">object</span>`</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> SingleGeneratedAdapterObserver(generatedAdapter)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> adapters: Array&lt;GeneratedAdapter&gt; = Array(constructors.size) &#123; i -&gt;</span><br><span class="line">            createGeneratedAdapter(constructors[i], `<span class="keyword">object</span>`)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CompositeGeneratedAdaptersObserver(adapters)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReflectiveGenericLifecycleObserver(`<span class="keyword">object</span>`)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以看到这里会判断<code>observer</code>的类型，如果是<code>DefaultLifecycleObserver</code>，则会使用<code>DefaultLifecycleObserverAdapter</code>对<code>observer</code>进行适配</p>
</li>
<li><p>这里可以看到，适配器考虑到了<code>Observer</code>即是<code>LifecycleEventObserver</code>又是<code>DefaultLifecycleObserver</code>的情况</p>
</li>
</ul>
<h4 id="DefaultLifecycleObserverAdapter"><a href="#DefaultLifecycleObserverAdapter" class="headerlink" title="DefaultLifecycleObserverAdapter"></a>DefaultLifecycleObserverAdapter</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">DefaultLifecycleObserverAdapter</span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> defaultLifecycleObserver: DefaultLifecycleObserver,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> lifecycleEventObserver: LifecycleEventObserver?</span><br><span class="line">) : LifecycleEventObserver &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStateChanged</span><span class="params">(source: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (event) &#123;</span><br><span class="line">            Lifecycle.Event.ON_CREATE -&gt; defaultLifecycleObserver.onCreate(source)</span><br><span class="line">            Lifecycle.Event.ON_START -&gt; defaultLifecycleObserver.onStart(source)</span><br><span class="line">            Lifecycle.Event.ON_RESUME -&gt; defaultLifecycleObserver.onResume(source)</span><br><span class="line">            Lifecycle.Event.ON_PAUSE -&gt; defaultLifecycleObserver.onPause(source)</span><br><span class="line">            Lifecycle.Event.ON_STOP -&gt; defaultLifecycleObserver.onStop(source)</span><br><span class="line">            Lifecycle.Event.ON_DESTROY -&gt; defaultLifecycleObserver.onDestroy(source)</span><br><span class="line">            Lifecycle.Event.ON_ANY -&gt;</span><br><span class="line">                <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;ON_ANY must not been send by anybody&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        lifecycleEventObserver?.onStateChanged(source, event)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里就很清晰了，<code>DefaultLifecycleObserverAdapter</code>根据当前的<code>state</code>调用<code>DefaultLifecycleObserver</code>的各个回调</li>
</ul>
<h3 id="handleLifecycleEvent"><a href="#handleLifecycleEvent" class="headerlink" title="handleLifecycleEvent"></a>handleLifecycleEvent</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Sets the current state and notifies the observers.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Note that if the `currentState` is the same state as the last call to this method,</span></span><br><span class="line"><span class="comment">    * calling this method has no effect.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> event The event that was received</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleLifecycleEvent</span><span class="params">(event: <span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;handleLifecycleEvent&quot;</span>)</span><br><span class="line">    moveToState(event.targetState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里看到<code>handleLifecycleEvent</code>也有设置<code>state</code>的作用</li>
</ul>
<h2 id="Activity生命周期相关函数"><a href="#Activity生命周期相关函数" class="headerlink" title="Activity生命周期相关函数"></a>Activity生命周期相关函数</h2><h3 id="回调结构定义"><a href="#回调结构定义" class="headerlink" title="回调结构定义"></a>回调结构定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Application.ActivityLifecycleCallbacks&gt; mActivityLifecycleCallbacks =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Application.ActivityLifecycleCallbacks&gt;();</span><br></pre></td></tr></table></figure>

<p>此处定义了一个回调的接口<code>List</code></p>
<h3 id="注册与删除"><a href="#注册与删除" class="headerlink" title="注册与删除"></a>注册与删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerActivityLifecycleCallbacks</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@NonNull</span> Application.ActivityLifecycleCallbacks callback)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mActivityLifecycleCallbacks) &#123;</span><br><span class="line">        mActivityLifecycleCallbacks.add(callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregisterActivityLifecycleCallbacks</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@NonNull</span> Application.ActivityLifecycleCallbacks callback)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mActivityLifecycleCallbacks) &#123;</span><br><span class="line">        mActivityLifecycleCallbacks.remove(callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="回调list转数组"><a href="#回调list转数组" class="headerlink" title="回调list转数组"></a>回调<code>list</code>转数组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object[] collectActivityLifecycleCallbacks() &#123;</span><br><span class="line">    Object[] callbacks = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mActivityLifecycleCallbacks) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mActivityLifecycleCallbacks.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            callbacks = mActivityLifecycleCallbacks.toArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> callbacks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>下面介绍的<code>dispatchActivityXXX</code>函数将调用<code>collectActivityLifecycleCallbacks</code>获取所有<code>callbacks</code>，然后调用<code>callbacks</code>的<code>onActivityXXX</code>函数</li>
</ul>
<h3 id="dispatchActivityPreCreated"><a href="#dispatchActivityPreCreated" class="headerlink" title="dispatchActivityPreCreated"></a>dispatchActivityPreCreated</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchActivityPreCreated</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    getApplication().dispatchActivityPreCreated(<span class="built_in">this</span>, savedInstanceState);</span><br><span class="line">    Object[] callbacks = collectActivityLifecycleCallbacks();</span><br><span class="line">    <span class="keyword">if</span> (callbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">            ((Application.ActivityLifecycleCallbacks) callbacks[i]).onActivityPreCreated(<span class="built_in">this</span>,</span><br><span class="line">                    savedInstanceState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatchActivityCreated"><a href="#dispatchActivityCreated" class="headerlink" title="dispatchActivityCreated"></a>dispatchActivityCreated</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchActivityCreated</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    getApplication().dispatchActivityCreated(<span class="built_in">this</span>, savedInstanceState);</span><br><span class="line">    Object[] callbacks = collectActivityLifecycleCallbacks();</span><br><span class="line">    <span class="keyword">if</span> (callbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">            ((Application.ActivityLifecycleCallbacks) callbacks[i]).onActivityCreated(<span class="built_in">this</span>,</span><br><span class="line">                    savedInstanceState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatchActivityPostCreated"><a href="#dispatchActivityPostCreated" class="headerlink" title="dispatchActivityPostCreated"></a>dispatchActivityPostCreated</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchActivityPostCreated</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    Object[] callbacks = collectActivityLifecycleCallbacks();</span><br><span class="line">    <span class="keyword">if</span> (callbacks != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">            ((Application.ActivityLifecycleCallbacks) callbacks[i]).onActivityPostCreated(<span class="built_in">this</span>,</span><br><span class="line">                    savedInstanceState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    getApplication().dispatchActivityPostCreated(<span class="built_in">this</span>, savedInstanceState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>每段代码几乎是一样的，就不全贴上来了</li>
<li>没贴上来的还有<ul>
<li>dispatchActivityPreStarted, dispatchActivityStarted, dispatchActivityPostStarted</li>
<li>dispatchActivityPreResumed, dispatchActivityResumed, dispatchActivityPostResumed</li>
<li>dispatchActivityPrePaused, dispatchActivityPaused, dispatchActivityPostPaused</li>
<li>dispatchActivitySaveInstanceState, dispatchActivitySaveInstanceState, dispatchActivityPostSaveInstanceState</li>
<li>dispatchActivityPreDestroyed, dispatchActivityDestroyed, dispatchActivityPostDestroyed</li>
<li>dispatchActivityConfigurationChanged</li>
</ul>
</li>
</ul>
<h2 id="ReportFragment"><a href="#ReportFragment" class="headerlink" title="ReportFragment"></a>ReportFragment</h2><ul>
<li>reportFragment负责传递Activity的生命周期</li>
</ul>
<h3 id="ReportFragment的初始化"><a href="#ReportFragment的初始化" class="headerlink" title="ReportFragment的初始化"></a>ReportFragment的初始化</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    ReportFragment.injectIfNeededIn(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">injectIfNeededIn</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">        <span class="comment">// On API 29+, we can register for the correct Lifecycle callbacks directly</span></span><br><span class="line">        LifecycleCallbacks.registerIn(activity)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Prior to API 29 and to maintain compatibility with older versions of</span></span><br><span class="line">    <span class="comment">// ProcessLifecycleOwner (which may not be updated when lifecycle-runtime is updated and</span></span><br><span class="line">    <span class="comment">// need to support activities that don&#x27;t extend from FragmentActivity from support lib),</span></span><br><span class="line">    <span class="comment">// use a framework fragment to get the correct timing of Lifecycle events</span></span><br><span class="line">    <span class="keyword">val</span> manager = activity.fragmentManager</span><br><span class="line">    <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="literal">null</span>) &#123;</span><br><span class="line">        manager.beginTransaction().add(ReportFragment(), REPORT_FRAGMENT_TAG).commit()</span><br><span class="line">        <span class="comment">// Hopefully, we are the first to make a transaction.</span></span><br><span class="line">        manager.executePendingTransactions()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>api</code>29之后，会使用<code>LifecycleCallbacks.registerIn</code></li>
<li>另外还会使用<code>ReportFragment</code>来报告<code>activity</code>的生命周期</li>
</ul>
<h3 id="ReportFragment分发生命周期-API-29之前"><a href="#ReportFragment分发生命周期-API-29之前" class="headerlink" title="ReportFragment分发生命周期(API 29之前)"></a>ReportFragment分发生命周期(API 29之前)</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> processListener: ActivityInitializationListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchCreate</span><span class="params">(listener: <span class="type">ActivityInitializationListener</span>?)</span></span> &#123;</span><br><span class="line">    listener?.onCreate()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchStart</span><span class="params">(listener: <span class="type">ActivityInitializationListener</span>?)</span></span> &#123;</span><br><span class="line">    listener?.onStart()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchResume</span><span class="params">(listener: <span class="type">ActivityInitializationListener</span>?)</span></span> &#123;</span><br><span class="line">    listener?.onResume()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityCreated</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityCreated(savedInstanceState)</span><br><span class="line">    dispatchCreate(processListener)</span><br><span class="line">    dispatch(Lifecycle.Event.ON_CREATE)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onStart()</span><br><span class="line">    dispatchStart(processListener)</span><br><span class="line">    dispatch(Lifecycle.Event.ON_START)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResume</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume()</span><br><span class="line">    dispatchResume(processListener)</span><br><span class="line">    dispatch(Lifecycle.Event.ON_RESUME)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onPause()</span><br><span class="line">    dispatch(Lifecycle.Event.ON_PAUSE)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStop</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onStop()</span><br><span class="line">    dispatch(Lifecycle.Event.ON_STOP)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    dispatch(Lifecycle.Event.ON_DESTROY)</span><br><span class="line">    <span class="comment">// just want to be sure that we won&#x27;t leak reference to an activity</span></span><br><span class="line">    processListener = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，当<code>Fragment</code>的声明周期函数被调用时，会调用<code>dispatch</code>，将<code>activity</code>的生命周期进行传递</li>
</ul>
<h3 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch"></a>dispatch</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatch</span><span class="params">(event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">29</span>) &#123;</span><br><span class="line">        <span class="comment">// Only dispatch events from ReportFragment on API levels prior</span></span><br><span class="line">        <span class="comment">// to API 29. On API 29+, this is handled by the ActivityLifecycleCallbacks</span></span><br><span class="line">        <span class="comment">// added in ReportFragment.injectIfNeededIn</span></span><br><span class="line">        dispatch(activity, event)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatch</span><span class="params">(activity: <span class="type">Activity</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">is</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">        activity.lifecycle.handleLifecycleEvent(event)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">is</span> LifecycleOwner) &#123;</span><br><span class="line">        <span class="keyword">val</span> lifecycle = (activity <span class="keyword">as</span> LifecycleOwner).lifecycle</span><br><span class="line">        <span class="keyword">if</span> (lifecycle <span class="keyword">is</span> LifecycleRegistry) &#123;</span><br><span class="line">            lifecycle.handleLifecycleEvent(event)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>仅在<code>api 29</code>之前通过<code>ReportFragment</code>来进行<code>activity</code>的生命周期传递</li>
<li>这里就可以看到上面分析的<code>LifecycleRegistry</code>类了，获取<code>activity</code>中的<code>lifecycle</code>再调用<code>handleLifecycleEvent</code>来更新<code>activity</code>的生命周期，进而将生命周期改变传递给<code>listener</code></li>
</ul>
<h2 id="API-29及以后Activity分发生命周期"><a href="#API-29及以后Activity分发生命周期" class="headerlink" title="API 29及以后Activity分发生命周期"></a>API 29及以后Activity分发生命周期</h2><h3 id="回到ReportFragment"><a href="#回到ReportFragment" class="headerlink" title="回到ReportFragment"></a>回到<code>ReportFragment</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">injectIfNeededIn</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">        <span class="comment">// On API 29+, we can register for the correct Lifecycle callbacks directly</span></span><br><span class="line">        LifecycleCallbacks.registerIn(activity)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大于等于<code>Api 29</code>时，会调用<code>registerIn</code></p>
<h3 id="registerIn"><a href="#registerIn" class="headerlink" title="registerIn"></a><code>registerIn</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmStatic</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">registerIn</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">    activity.registerActivityLifecycleCallbacks(LifecycleCallbacks())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里看到，调用了<a href="#activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0">activity</a>的<code>registerActivityLifecycleCallbacks</code>，<code>activity</code>会在发生生命周期改变时调用回调<code>LifecycleCallbacks</code></li>
</ul>
<h3 id="LifecycleCallbacks"><a href="#LifecycleCallbacks" class="headerlink" title="LifecycleCallbacks"></a>LifecycleCallbacks</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">LifecycleCallbacks</span> : <span class="type">Application.ActivityLifecycleCallbacks</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityCreated</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        activity: <span class="type">Activity</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bundle: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityPostCreated</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        activity: <span class="type">Activity</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_CREATE)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityStarted</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityPostStarted</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_START)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResumed</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityPostResumed</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_RESUME)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityPrePaused</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_PAUSE)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityPaused</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityPreStopped</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_STOP)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityStopped</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivitySaveInstanceState</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        activity: <span class="type">Activity</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bundle: <span class="type">Bundle</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityPreDestroyed</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_DESTROY)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityDestroyed</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">registerIn</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">            activity.registerActivityLifecycleCallbacks(LifecycleCallbacks())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里看到<code>LifecycleCallbacks</code>调用了<a href="#dispatch">dispatch()</a>函数，将<code>activity</code>的生命周期进行了分发</li>
</ul>
<h2 id="Fragment的lifecycle"><a href="#Fragment的lifecycle" class="headerlink" title="Fragment的lifecycle"></a>Fragment的lifecycle</h2><h3 id="实现LifecycleOwner"><a href="#实现LifecycleOwner" class="headerlink" title="实现LifecycleOwner"></a>实现<code>LifecycleOwner</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fragment</span> <span class="keyword">implements</span> <span class="title class_">ComponentCallbacks</span>, OnCreateContextMenuListener, LifecycleOwner,</span><br><span class="line">        ViewModelStoreOwner, HasDefaultViewModelProviderFactory, SavedStateRegistryOwner,</span><br><span class="line">        ActivityResultCaller &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> Lifecycle <span class="title function_">getLifecycle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化Lifecycle"><a href="#初始化Lifecycle" class="headerlink" title="初始化Lifecycle"></a>初始化<code>Lifecycle</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Fragment</span><span class="params">()</span> &#123;</span><br><span class="line">    initLifecycle();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initLifecycle</span><span class="params">()</span> &#123;</span><br><span class="line">    mLifecycleRegistry = <span class="keyword">new</span> <span class="title class_">LifecycleRegistry</span>(<span class="built_in">this</span>);</span><br><span class="line">    mSavedStateRegistryController = SavedStateRegistryController.create(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// The default factory depends on the SavedStateRegistry so it</span></span><br><span class="line">    <span class="comment">// needs to be reset when the SavedStateRegistry is reset</span></span><br><span class="line">    mDefaultFactory = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mOnPreAttachedListeners.contains(mSavedStateAttachListener)) &#123;</span><br><span class="line">        registerOnPreAttachListener(mSavedStateAttachListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="传递事件"><a href="#传递事件" class="headerlink" title="传递事件"></a>传递事件</h3><p><code>fragment</code>的生命周期传递比较简单，就是在<code>fragment</code>各个生命周期时调用<code>handleLifecycleEvent</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    mChildFragmentManager.noteStateNotSaved();</span><br><span class="line">    mState = CREATED;</span><br><span class="line">    mCalled = <span class="literal">false</span>;</span><br><span class="line">    mLifecycleRegistry.addObserver(<span class="keyword">new</span> <span class="title class_">LifecycleEventObserver</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span><br><span class="line"><span class="params">                <span class="meta">@NonNull</span> Lifecycle.Event event)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event == Lifecycle.Event.ON_STOP) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mView != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mView.cancelPendingInputEvents();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    onCreate(savedInstanceState);</span><br><span class="line">    mIsCreated = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SuperNotCalledException</span>(<span class="string">&quot;Fragment &quot;</span> + <span class="built_in">this</span></span><br><span class="line">                + <span class="string">&quot; did not call through to super.onCreate()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performStart</span><span class="params">()</span> &#123;</span><br><span class="line">    mChildFragmentManager.noteStateNotSaved();</span><br><span class="line">    mChildFragmentManager.execPendingActions(<span class="literal">true</span>);</span><br><span class="line">    mState = STARTED;</span><br><span class="line">    mCalled = <span class="literal">false</span>;</span><br><span class="line">    onStart();</span><br><span class="line">    <span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SuperNotCalledException</span>(<span class="string">&quot;Fragment &quot;</span> + <span class="built_in">this</span></span><br><span class="line">                + <span class="string">&quot; did not call through to super.onStart()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);</span><br><span class="line">    <span class="keyword">if</span> (mView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mViewLifecycleOwner.handleLifecycleEvent(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line">    mChildFragmentManager.dispatchStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performResume</span><span class="params">()</span> &#123;</span><br><span class="line">    mChildFragmentManager.noteStateNotSaved();</span><br><span class="line">    mChildFragmentManager.execPendingActions(<span class="literal">true</span>);</span><br><span class="line">    mState = RESUMED;</span><br><span class="line">    mCalled = <span class="literal">false</span>;</span><br><span class="line">    onResume();</span><br><span class="line">    <span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SuperNotCalledException</span>(<span class="string">&quot;Fragment &quot;</span> + <span class="built_in">this</span></span><br><span class="line">                + <span class="string">&quot; did not call through to super.onResume()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    <span class="keyword">if</span> (mView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mViewLifecycleOwner.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line">    mChildFragmentManager.dispatchResume();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performPause</span><span class="params">()</span> &#123;</span><br><span class="line">    mChildFragmentManager.dispatchPause();</span><br><span class="line">    <span class="keyword">if</span> (mView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mViewLifecycleOwner.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line">    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    mState = AWAITING_ENTER_EFFECTS;</span><br><span class="line">    mCalled = <span class="literal">false</span>;</span><br><span class="line">    onPause();</span><br><span class="line">    <span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SuperNotCalledException</span>(<span class="string">&quot;Fragment &quot;</span> + <span class="built_in">this</span></span><br><span class="line">                + <span class="string">&quot; did not call through to super.onPause()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performStop</span><span class="params">()</span> &#123;</span><br><span class="line">    mChildFragmentManager.dispatchStop();</span><br><span class="line">    <span class="keyword">if</span> (mView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mViewLifecycleOwner.handleLifecycleEvent(Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line">    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);</span><br><span class="line">    mState = ACTIVITY_CREATED;</span><br><span class="line">    mCalled = <span class="literal">false</span>;</span><br><span class="line">    onStop();</span><br><span class="line">    <span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SuperNotCalledException</span>(<span class="string">&quot;Fragment &quot;</span> + <span class="built_in">this</span></span><br><span class="line">                + <span class="string">&quot; did not call through to super.onStop()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">performDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    mChildFragmentManager.dispatchDestroy();</span><br><span class="line">    mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">    mState = ATTACHED;</span><br><span class="line">    mCalled = <span class="literal">false</span>;</span><br><span class="line">    mIsCreated = <span class="literal">false</span>;</span><br><span class="line">    onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (!mCalled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SuperNotCalledException</span>(<span class="string">&quot;Fragment &quot;</span> + <span class="built_in">this</span></span><br><span class="line">                + <span class="string">&quot; did not call through to super.onDestroy()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>基础03-Lifecycle</p><p><a href="https://jingtianer.github.io/home/2024/07/31/Android高级/源码阅读/基础03-Lifecycle/">https://jingtianer.github.io/home/2024/07/31/Android高级/源码阅读/基础03-Lifecycle/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Meow Meow Liu</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-07-31</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-04-15</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/home/tags/Android-%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81/">Android-官方源码</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/home/2024/08/06/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8004-LiveData/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">基础04-LiveData</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/home/2024/07/31/Android%E9%AB%98%E7%BA%A7/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/%E5%9F%BA%E7%A1%8002-viewModel/"><span class="level-item">基础02-viewModel</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "a5793840947dc58d3a6fdf7aa4452297",
            repo: "blog_comment",
            owner: "jingtianer",
            clientID: "f0b13fe8021fcd2efe50",
            clientSecret: "35207c14b34e77c48a3aeee1e94c9da169ffe0c2",
            admin: ["jingtianer"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#lifeCycle的Observer"><span class="level-left"><span class="level-item">1</span><span class="level-item">lifeCycle的Observer</span></span></a></li><li><a class="level is-mobile" href="#Activity树"><span class="level-left"><span class="level-item">2</span><span class="level-item">Activity树</span></span></a></li><li><a class="level is-mobile" href="#LifecycleOwner"><span class="level-left"><span class="level-item">3</span><span class="level-item">LifecycleOwner</span></span></a></li><li><a class="level is-mobile" href="#androidx-core-app-ComponentActivity中的lifecycle"><span class="level-left"><span class="level-item">4</span><span class="level-item">androidx.core.app.ComponentActivity中的lifecycle</span></span></a></li><li><a class="level is-mobile" href="#LifecycleRegistry"><span class="level-left"><span class="level-item">5</span><span class="level-item">LifecycleRegistry</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#addObserver"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">addObserver</span></span></a></li><li><a class="level is-mobile" href="#ObserverWithState"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">ObserverWithState</span></span></a></li><li><a class="level is-mobile" href="#setCurrentState作用"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">setCurrentState作用</span></span></a></li><li><a class="level is-mobile" href="#ObserverWithState如何处理两种LifecycleObserver"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">ObserverWithState如何处理两种LifecycleObserver</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#DefaultLifecycleObserverAdapter"><span class="level-left"><span class="level-item">5.4.1</span><span class="level-item">DefaultLifecycleObserverAdapter</span></span></a></li></ul></li><li><a class="level is-mobile" href="#handleLifecycleEvent"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">handleLifecycleEvent</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Activity生命周期相关函数"><span class="level-left"><span class="level-item">6</span><span class="level-item">Activity生命周期相关函数</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#回调结构定义"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">回调结构定义</span></span></a></li><li><a class="level is-mobile" href="#注册与删除"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">注册与删除</span></span></a></li><li><a class="level is-mobile" href="#回调list转数组"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">回调list转数组</span></span></a></li><li><a class="level is-mobile" href="#dispatchActivityPreCreated"><span class="level-left"><span class="level-item">6.4</span><span class="level-item">dispatchActivityPreCreated</span></span></a></li><li><a class="level is-mobile" href="#dispatchActivityCreated"><span class="level-left"><span class="level-item">6.5</span><span class="level-item">dispatchActivityCreated</span></span></a></li><li><a class="level is-mobile" href="#dispatchActivityPostCreated"><span class="level-left"><span class="level-item">6.6</span><span class="level-item">dispatchActivityPostCreated</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ReportFragment"><span class="level-left"><span class="level-item">7</span><span class="level-item">ReportFragment</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ReportFragment的初始化"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">ReportFragment的初始化</span></span></a></li><li><a class="level is-mobile" href="#ReportFragment分发生命周期-API-29之前"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">ReportFragment分发生命周期(API 29之前)</span></span></a></li><li><a class="level is-mobile" href="#dispatch"><span class="level-left"><span class="level-item">7.3</span><span class="level-item">dispatch</span></span></a></li></ul></li><li><a class="level is-mobile" href="#API-29及以后Activity分发生命周期"><span class="level-left"><span class="level-item">8</span><span class="level-item">API 29及以后Activity分发生命周期</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#回到ReportFragment"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">回到ReportFragment</span></span></a></li><li><a class="level is-mobile" href="#registerIn"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">registerIn</span></span></a></li><li><a class="level is-mobile" href="#LifecycleCallbacks"><span class="level-left"><span class="level-item">8.3</span><span class="level-item">LifecycleCallbacks</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Fragment的lifecycle"><span class="level-left"><span class="level-item">9</span><span class="level-item">Fragment的lifecycle</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#实现LifecycleOwner"><span class="level-left"><span class="level-item">9.1</span><span class="level-item">实现LifecycleOwner</span></span></a></li><li><a class="level is-mobile" href="#初始化Lifecycle"><span class="level-left"><span class="level-item">9.2</span><span class="level-item">初始化Lifecycle</span></span></a></li><li><a class="level is-mobile" href="#传递事件"><span class="level-left"><span class="level-item">9.3</span><span class="level-item">传递事件</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/home/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/home/">Meow!!</a><p class="is-size-7"><span>&copy; 2025 Meow Meow Liu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/home/js/column.js"></script><script src="/home/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/home/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/home/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/home/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/home/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script type="text/javascript" src="/home/js/fairyDustCursor.js"></script><link rel="stylesheet" type="text/css" href="/home/css/textPopup.css"><script type="text/javascript" src="/home/js/textPopup.js"></script><script type="text/javascript" src="/home/js/clickClipBoard.js"></script><script type="module" src="/home/js/mermaidInitializer.js"></script><script src="/home/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/home/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true}});</script></body></html>