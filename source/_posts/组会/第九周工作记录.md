---
title: 第九周记录
date: 2023-3-13 12:15:37
tags: 
    - 组会 
categories: 组会
toc: true
language: zh-CN
---

## 使用go-fuzz对coreDNS测试

- 这里是对CoreDns的插件进行模糊测试，参考官方插件[proxy](https://github.com/coredns/proxy/blob/master/fuzz.go)的模糊测试方法

### 下载go-fuzz

```sh
mkdir go-fuzz; cd go-fuzz
export GOPATH=`pwd`             # 暂时更改go path，将go-fuzz下载到指定位置
cd ..; mkdir tmp; cd tmp
go mod init tmp
go mod tidy
go get -u github.com/dvyukov/go-fuzz/go-fuzz@latest github.com/dvyukov/go-fuzz/go-fuzz-build@latest
echo export PATH=\$PATH:$GOPATH/bin/ | tee -a ~/.bashrc
source ~/.bashrc  # 写入环境变量
```

### 获取go-fuzz的语料库
```sh
go get -d github.com/dvyukov/go-fuzz-corpus
```

### 测试

对于一个项目
```sh
go mod init xxx
go mod tidy
go-fuzz-build
go-fuzz
```
> 前提是必须编写Fuzz函数，作为go-fuzz的入口。Fuzz 函数的参数 data 是 go-fuzz生成的随机输入；返回值是一个整数，如果输入是有效的，则返回1，否则返回0。

```sh
2023/03/12 18:16:31 workers: 8, corpus: 266 (48s ago), crashers: 0, restarts: 1/9642, execs: 1099293 (22890/sec), cover: 1596, uptime: 48s
2023/03/12 18:16:34 workers: 8, corpus: 266 (51s ago), crashers: 0, restarts: 1/9722, execs: 1176398 (23055/sec), cover: 1596, uptime: 51s
2023/03/12 18:16:37 workers: 8, corpus: 266 (54s ago), crashers: 0, restarts: 1/9778, execs: 1290718 (23891/sec), cover: 1596, uptime: 54s
2023/03/12 18:16:40 workers: 8, corpus: 266 (57s ago), crashers: 0, restarts: 1/9778, execs: 1398336 (24522/sec), cover: 1596, uptime: 57s
2023/03/12 18:16:43 workers: 8, corpus: 266 (1m0s ago), crashers: 0, restarts: 1/9788, execs: 1497597 (24950/sec), cover: 1596, uptime: 1m0s
2023/03/12 18:16:46 workers: 8, corpus: 266 (1m3s ago), crashers: 0, restarts: 1/9875, execs: 1589886 (25226/sec), cover: 1596, uptime: 1m3s
2023/03/12 18:16:49 workers: 8, corpus: 266 (1m6s ago), crashers: 0, restarts: 1/9827, execs: 1739488 (26346/sec), cover: 1759, uptime: 1m6s
2023/03/12 18:16:52 workers: 8, corpus: 266 (1m9s ago), crashers: 0, restarts: 1/9740, execs: 1840949 (26671/sec), cover: 1799, uptime: 1m9s
2023/03/12 18:16:55 workers: 8, corpus: 266 (1m12s ago), crashers: 0, restarts: 1/9806, execs: 1922080 (26686/sec), cover: 1799, uptime: 1m12s
```

## 对CoreDNS进行模糊测试

### coredns对go-fuzz的支持

在coredns的源码中可以找到一个Do函数，这使我们可以对CoreDNS的插件进行测试

```go
func Do(p plugin.Handler, data []byte) int {
	ctx := context.TODO()
	r := new(dns.Msg)
	if err := r.Unpack(data); err != nil {
		return 0 // plugin will never be called when this happens.
	}
	// If the data unpack into a dns msg, but does not have a proper question section discard it.
	// The server parts make sure this is true before calling the plugins; mimic this behavior.
	if len(r.Question) == 0 {
		return 0
	}

	if _, err := p.ServeDNS(ctx, &test.ResponseWriter{}, r); err != nil {
		return 1
	}

	return 0
}
```

### 对proxy插件进行fuzz

#### 编写Fuzz函数
例如，对proxy插件可以这样编写他的Fuzz函数

```go

// Fuzz fuzzes proxy.
func Fuzz(data []byte) int {
	c := caddy.NewTestController("dns", "proxy . 8.8.8.8:53")
	up, err := NewStaticUpstreams(&c.Dispenser)
	if err != nil {
		return 0
	}
	p := &Proxy{Upstreams: &up}

	return fuzz.Do(p, data)
}
```

#### 使用go-fuzz编译

```sh
go-fuzz-build
```

#### 进行测试

```sh
go-fuzz
```

```sh
2023/03/12 19:31:09 workers: 8, corpus: 310 (58s ago), crashers: 0, restarts: 1/9678, execs: 3619593 (57454/sec), cover: 1189, uptime: 1m3s
2023/03/12 19:31:12 workers: 8, corpus: 310 (1m1s ago), crashers: 0, restarts: 1/9659, execs: 3767317 (57080/sec), cover: 1189, uptime: 1m6s
2023/03/12 19:31:15 workers: 8, corpus: 310 (1m4s ago), crashers: 0, restarts: 1/9691, execs: 3924923 (56883/sec), cover: 1189, uptime: 1m9s
2023/03/12 19:31:18 workers: 8, corpus: 345 (0s ago), crashers: 0, restarts: 1/9745, execs: 4093282 (56851/sec), cover: 1189, uptime: 1m12s
2023/03/12 19:31:21 workers: 8, corpus: 407 (0s ago), crashers: 0, restarts: 1/9749, execs: 4270438 (56939/sec), cover: 1538, uptime: 1m15s
2023/03/12 19:31:24 workers: 8, corpus: 407 (3s ago), crashers: 0, restarts: 1/9711, execs: 4409004 (56525/sec), cover: 1546, uptime: 1m18s
```