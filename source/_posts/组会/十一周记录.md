---
title: 十一周记录
date: 2023-3-21 12:15:37
tags: 
    - 组会 
categories: 组会
toc: true
language: zh-CN
---

## fuzz旧版本bind

|版本号|来源|fuzzed_app|
|-|-|-|
|9.16.39|release|dns_rdata_fromwire_text|

### 问题解决
- 问题1:

```sh
dns_rdata_fromwire_text.lto.o:ld-temp.o:function LLVMFuzzerTestOneInput: error: undefined reference to 'debug'
dns_rdata_fromwire_text.lto.o:ld-temp.o:function LLVMFuzzerTestOneInput: error: undefined reference to 'debug'
dns_rdata_fromwire_text.lto.o:ld-temp.o:function nullmsg: error: undefined reference to 'debug'
```

在文件`bind9/fuzz/dns_rdata_fromwire_text.c`下，定义了外部变量`debug`，但是该文件并没有与其他文件链接，改为该文件中的全局变量


- 问题2:
make install时，filter-aaaa.so文件编译出错，去对应的文件夹下找不到该文件，说明编译失败了
分析：
- 在该文件夹下手动编译该文件，可以正常编译，生产.so文件，且通过make生产的文件缺少运行权限
- 通过手动编译该文件，继续make，可以顺利继续编译，并且所有so都存在相同问题
```sh
/home/ubuntu/build/llvm_tools/build-llvm/msan/aflgo/afl-clang-fast -Wl,--export-dynamic -shared -o $@ filter-aaaa.o 
/home/ubuntu/build/llvm_tools/build-llvm/msan/aflgo/afl-clang-fast -Wl,--export-dynamic -shared -o filter-aaaa.so filter-aaaa.o
```


解决：
- 手动对so库编译


### 挖掘情况

aflgo挖的很快，在第4分钟时就出了一个crash

```sh
               american fuzzy lop 2.52b (dns_rdata_fromwire_text)

┌─ process timing ─────────────────────────────────────┬─ overall results ─────┐
│        run time : 0 days, 7 hrs, 48 min, 9 sec       │  cycles done : 0      │
│   last new path : 0 days, 0 hrs, 1 min, 30 sec       │  total paths : 820    │
│ last uniq crash : 0 days, 0 hrs, 23 min, 20 sec      │ uniq crashes : 14     │
│  last uniq hang : none seen yet                      │   uniq hangs : 0      │
├─ cycle progress ────────────────────┬─ map coverage ─┴───────────────────────┤
│  now processing : 169 (20.61%)      │    map density : 1.88% / 15.43%        │
│ paths timed out : 0 (0.00%)         │ count coverage : 1.67 bits/tuple       │
├─ stage progress ────────────────────┼─ findings in depth ────────────────────┤
│  now trying : havoc                 │ favored paths : 300 (36.59%)           │
│ stage execs : 4070/6552 (62.12%)    │  new edges on : 394 (48.05%)           │
│ total execs : 844k                  │ total crashes : 62 (14 unique)         │
│  exec speed : 37.74/sec (slow!)     │  total tmouts : 808 (19 unique)        │
├─ fuzzing strategy yields ───────────┴───────────────┬─ path geometry ────────┤
│   bit flips : 25/72.1k, 22/72.0k, 15/72.0k          │    levels : 5          │
│  byte flips : 1/9007, 0/2844, 1/2838                │   pending : 794        │
│ arithmetics : 102/157k, 2/55.1k, 0/10.3k            │  pend fav : 285        │
│  known ints : 3/16.1k, 2/73.4k, 6/121k              │ own finds : 727        │
│  dictionary : 0/0, 0/0, 0/0                         │  imported : n/a        │
│       havoc : 561/165k, 0/0                         │ stability : 99.90%     │
│        trim : 63.40%/4616, 67.84%                   ├────────────────────────┘
^C────────────────────────────────────────────────────┘          [cpu002: 87%]
```

转到服务器上，cpu核心多一点，可以并行挖。10小时挖出41+75+77+71

## 对named fuzz

|版本号|来源|fuzzed_app|
|-|-|-|
|9.15.0|release|named|


### 准备工作

- 如何调试
  - 先直接运行named，通过`-g`参数显示debug信息
  - `-L logfile`，可以指定log文件的输出位置，经过实践，在我写的脚本里似乎无论如何都输出不了，用shell却可以
- 如何fuzz
  - 使用参数`-A`，从`bind9/bin/named/fuzz.c`的代码注释中了解到的，可以指定named的角色
  - 使用参数`-c`可指定配置文件，配合`@@`占位，可以将afl输入作为配置文件，但是-c是指定配置文件的路径而非内容
- named配置文件
  - 使用`-c`可指定配置文件
  - 如果使用`-A`进行fuzz，需要手动配置其配置文件，只需一个空文件即可。


### -A参数

#### \<mode\>:\<address\>:\<port\>

这个参数从标准输入中读取AFL中的测试用例，查询blobs，并将其发送到指定的相应tcp侦听端口

- mode可选
  - tcp
  - http
  - rndc

#### client:\<address\>:\<port\>

创建线程从标准输入读取AFL的模糊查询消息，并将其发送到named的监听端口(DNS)

#### resolver:\<saddress\>:\<sport\>:\<raddress\>:\<rport\>


创建线程从标准输入中读取AFL中的模糊消息，将侦听器设置为远程。


- \<raddress\>:\<rport\>会通过root zone配置为aaaaaaaaaaa .example的权限服务器。

- \<saddress\>:\<sport\>为named监听的socket

### 问题解决
#### -A resolver:127.0.0.1:4444:127.0.0.1:3333
- /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39-named/bind9/bin/named/.libs/named: symbol lookup error: /home/ubuntu/dnsenv/aflgo-workdir/bind9-16-39-named/bind9/bin/named/.libs/named: undefined symbol: dns_resolver_setfuzzing
  - 通过全局搜索，该函数定义位于`bind9/lib/dns/resolver.c`下，但是我已经在LD_LIBRARY_PATH中指定了该目录，该函数需要宏定义`ENABLE_AFL`
  - 因为fuzz的是`9.15.0`，怀疑其`Makefile`生成有误，或者当时版本并不支持在`./config`时加入参数`--enable-fuzz=afl`
  - 在编译参数`$CFLAGS`中添加条件编译参数`-D ENABLE_AFL`重新编译插装，可以正常运行

- 权限问题：24-Mar-2023 09:55:55.273 general: info: generating session key for dynamic DNS
24-Mar-2023 09:55:55.273 general: warning: could not open file '/usr/local/var/run/named/session.key': Permission denied
  - 用su运行

- 24-Mar-2023 10:52:01.158 general: critical: unable to signal parent that we otherwise started successfully.
  - 因为这个问题，找不到解决方法，还在尝试

#### -A client:127.0.0.1:4444

- 有了前面的铺垫，这个模式顺利运行起来了，并在40s时挖出了2个漏洞

挖了1分8秒，出了5个crash，但是OOM了，这个时候我同时开了四个进程并行挖`dns_rdata_fromwire_text`

并且同时观察到，通过 `ps -ef | grep named`，发现在fuzz过程中，除了`aflgo`的进程外，内存中还有大量的`named -A client:xxxx:xxxx`

通过`ps -ef  | grep -e $STOP | wc -l`统计行数，发现named的数目是越来越多的，这应该就是oom的原因，但不知是否是crash的原因


## crash分析

### named服务

#### hexdump查看16进制内容
```sh
hexdump -C id\:xxxxx,xxxxx,xxxxx
00000000  1b                                                |.|
00000001
```

确实都是这样无意义的输出，应该就是过多进程导致的OOM。


### dns_rdata_fromwire_text

#### hexdump

经过手工查看，发现也是没有什么含义的内容

#### crash直接作为输入
```sh
cat crashfile | fuzzed_app
cannot execute binary file: Exec format error
```
直接这样做不可行，换种方法，把crash输入未插桩的同版本的同一个测试程序中，得到报错为``

mem.c:871: fatal error: RUNTIME_CHECK(((pthread_mutex_lock(((&contextslock))) == 0) ? 0 : 34) == 0) failed
Aborted

#### gdb

- 先不设置断点，直接运行

```sh
ubuntu@VM-0-4-ubuntu:~/dnsenv/crash_analyze$ LD_LIBRARY_PATH=$SUBJECT/lib/isc/.libs:$SUBJECT/lib/dns/.libs:$SUBJECT/lib/isccc/.libs:$SUBJECT/lib/isccfg/.libs gdb  $SUBJECT/fuzz/dns_rdata_fromwire_text
GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.5) 7.11.1
Copyright (C) 2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from /home/ubuntu/dnsenv/crash_analyze/bind-9.16.39/fuzz/dns_rdata_fromwire_text...done.
(gdb) r
Starting program: /home/ubuntu/dnsenv/crash_analyze/bind-9.16.39/fuzz/dns_rdata_fromwire_text 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
testing 2 bytes from /home/ubuntu/dnsenv/crash_analyze/bind-9.16.39/fuzz/dns_rdata_fromwire_text.in/id:000022,8867894,sig:06,src:000445,op:havoc,rep:128
mem.c:871: fatal error: RUNTIME_CHECK(((pthread_mutex_lock(((&contextslock))) == 0) ? 0 : 34) == 0) failed

Program received signal SIGABRT, Aborted.
0x00007ffff6f4a438 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:54
54      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
```
- 找到报错位于`/lib/x86_64-linux-gnu/libthread_db.so.1`下的RUNTIME_CHECK中找到该行，导致崩溃的函数是EnterCriticalSection，剩下的东西还没看完
